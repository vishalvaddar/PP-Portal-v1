

// // // // // // // // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // // // // // // // import React, { useState, useEffect } from "react";
// // // // // // // // // // // // import axios from "axios";
// // // // // // // // // // // // import "./BatchManagement.css";
// // // // // // // // // // // // import {
// // // // // // // // // // // //   Search,
// // // // // // // // // // // //   Download,
// // // // // // // // // // // //   Eye,
// // // // // // // // // // // //   Edit,
// // // // // // // // // // // //   X,
// // // // // // // // // // // //   CheckCircle,
// // // // // // // // // // // //   User2,
// // // // // // // // // // // //   Phone,
// // // // // // // // // // // //   Mail,
// // // // // // // // // // // //   MapPin,
// // // // // // // // // // // //   AlertTriangle,
// // // // // // // // // // // //   Filter,
// // // // // // // // // // // //   ChevronDown,
// // // // // // // // // // // // } from "lucide-react";
// // // // // // // // // // // // import { useAuth } from "../../contexts/AuthContext";
// // // // // // // // // // // // import { jsPDF } from "jspdf";
// // // // // // // // // // // // import autoTable from "jspdf-autotable";
// // // // // // // // // // // // import * as XLSX from "xlsx";
// // // // // // // // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // // // // // // // export default function StudentManagement() {
// // // // // // // // // // // //   const { user } = useAuth();
// // // // // // // // // // // //   const token = user?.token;

// // // // // // // // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // // // // // // // //   const [batches, setBatches] = useState([]);
// // // // // // // // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });

// // // // // // // // // // // //   const [students, setStudents] = useState([]);
// // // // // // // // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // // // // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // // // // // // // //   const [statusFilter, setStatusFilter] = useState("all");

// // // // // // // // // // // //   const [loading, setLoading] = useState(false);

// // // // // // // // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // // // // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // // // // // // // //   const [editForm, setEditForm] = useState({});

// // // // // // // // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // // // // // // // //   const [inactiveReason, setInactiveReason] = useState("");

// // // // // // // // // // // //   const [exportOpen, setExportOpen] = useState(false); // <-- dropdown toggle

// // // // // // // // // // // //   const editableFields = [
// // // // // // // // // // // //     "student_name",
// // // // // // // // // // // //     "father_name",
// // // // // // // // // // // //     "father_occupation",
// // // // // // // // // // // //     "mother_name",
// // // // // // // // // // // //     "mother_occupation",
// // // // // // // // // // // //     "student_email",
// // // // // // // // // // // //     "student_email_password",
// // // // // // // // // // // //     "home_address",
// // // // // // // // // // // //     "current_institute",
// // // // // // // // // // // //     "previous_institute",
// // // // // // // // // // // //     "disecode",
// // // // // // // // // // // //     "active_yn",
// // // // // // // // // // // //     "inactive_reason",
// // // // // // // // // // // //     "teacher_name",
// // // // // // // // // // // //   ];

// // // // // // // // // // // //   const axiosConfig = () => ({ headers: { Authorization: `Bearer ${token}` } });

// // // // // // // // // // // //   // Fetch cohorts
// // // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // // //     if (!token) return;
// // // // // // // // // // // //     axios
// // // // // // // // // // // //       .get(`${process.env.REACT_APP_BACKEND_API_URL}/api/coordinator/cohorts`, axiosConfig())
// // // // // // // // // // // //       .then(({ data }) => setCohorts(data || []))
// // // // // // // // // // // //       .catch(() => setCohorts([]));
// // // // // // // // // // // //   }, [token]);

// // // // // // // // // // // //   // Fetch batches
// // // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // // //     if (!token || !formData.cohort) return setBatches([]);
// // // // // // // // // // // //     axios
// // // // // // // // // // // //       .get(
// // // // // // // // // // // //         `${process.env.REACT_APP_BACKEND_API_URL}/api/coordinator/batches?cohort_number=${formData.cohort}`,
// // // // // // // // // // // //         axiosConfig()
// // // // // // // // // // // //       )
// // // // // // // // // // // //       .then(({ data }) => setBatches(data || []))
// // // // // // // // // // // //       .catch(() => setBatches([]));
// // // // // // // // // // // //   }, [token, formData.cohort]);

// // // // // // // // // // // //   // Fetch students
// // // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // // //     if (!token) return;
// // // // // // // // // // // //     setLoading(true);

// // // // // // // // // // // //     const params = {};
// // // // // // // // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // // // // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // // // // // // // //     axios
// // // // // // // // // // // //       .get(`${process.env.REACT_APP_BACKEND_API_URL}/api/coordinator/students`, {
// // // // // // // // // // // //         ...axiosConfig(),
// // // // // // // // // // // //         params,
// // // // // // // // // // // //       })
// // // // // // // // // // // //       .then(({ data }) => setStudents(data || []))
// // // // // // // // // // // //       .catch(() => setStudents([]))
// // // // // // // // // // // //       .finally(() => setLoading(false));
// // // // // // // // // // // //   }, [token, formData]);

// // // // // // // // // // // //   // Local filtering
// // // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // // //     let f = [...students];
// // // // // // // // // // // //     if (searchQuery.trim()) {
// // // // // // // // // // // //       const q = searchQuery.toLowerCase();
// // // // // // // // // // // //       f = f.filter(
// // // // // // // // // // // //         (s) =>
// // // // // // // // // // // //           s.student_name?.toLowerCase().includes(q) ||
// // // // // // // // // // // //           s.enr_id?.toLowerCase().includes(q)
// // // // // // // // // // // //       );
// // // // // // // // // // // //     }
// // // // // // // // // // // //     if (statusFilter !== "all") {
// // // // // // // // // // // //       f = f.filter((s) => (s.active_yn ?? "").toLowerCase() === statusFilter);
// // // // // // // // // // // //     }
// // // // // // // // // // // //     setFilteredStudents(f);
// // // // // // // // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   /*               EXPORT: CSV                  */
// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   const exportCSV = () => {
// // // // // // // // // // // //     if (!filteredStudents.length) {
// // // // // // // // // // // //       alert("No rows to export.");
// // // // // // // // // // // //       return;
// // // // // // // // // // // //     }

// // // // // // // // // // // //     const rows = filteredStudents.map((s) => ({
// // // // // // // // // // // //       student_id: s.student_id,
// // // // // // // // // // // //       student_name: s.student_name,
// // // // // // // // // // // //       enr_id: s.enr_id,
// // // // // // // // // // // //       cohort: s.cohort_name,
// // // // // // // // // // // //       batch: s.batch_name,
// // // // // // // // // // // //       contact: s.contact_no1,
// // // // // // // // // // // //       status: s.active_yn,
// // // // // // // // // // // //       //teacher: s.teacher_name,
// // // // // // // // // // // //     }));

// // // // // // // // // // // //     const csv = [
// // // // // // // // // // // //       Object.keys(rows[0] || {}).join(","),
// // // // // // // // // // // //       ...rows.map((r) =>
// // // // // // // // // // // //         Object.values(r)
// // // // // // // // // // // //           .map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`)
// // // // // // // // // // // //           .join(",")
// // // // // // // // // // // //       ),
// // // // // // // // // // // //     ].join("\n");

// // // // // // // // // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // // // // // // // // //     const url = URL.createObjectURL(blob);
// // // // // // // // // // // //     const a = document.createElement("a");
// // // // // // // // // // // //     a.href = url;
// // // // // // // // // // // //     a.download = "Student_Report.csv";
// // // // // // // // // // // //     a.click();
// // // // // // // // // // // //     URL.revokeObjectURL(url);
// // // // // // // // // // // //     setExportOpen(false);
// // // // // // // // // // // //   };

// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // // /*               EXPORT: PDF                  */
// // // // // // // // // // // // /**********************************************/
// // // // // // // // // // // // /**********************************************/
// // // // // // // // // // // // /*               EXPORT: PDF                  */
// // // // // // // // // // // // /**********************************************/
// // // // // // // // // // // // const exportPDF = async () => {
// // // // // // // // // // // //   if (!filteredStudents.length) {
// // // // // // // // // // // //     alert("No rows to export.");
// // // // // // // // // // // //     return;
// // // // // // // // // // // //   }

// // // // // // // // // // // //   try {
// // // // // // // // // // // //     // PORTRAIT A4 (same style as timetable)
// // // // // // // // // // // //     const doc = new jsPDF({ unit: "pt", format: "a4" });
// // // // // // // // // // // //     const pageWidth = doc.internal.pageSize.getWidth();

// // // // // // // // // // // //     /* -------------------------
// // // // // // // // // // // //        LOAD LOGO
// // // // // // // // // // // //     -------------------------*/
// // // // // // // // // // // //     let logoDataUrl = null;
// // // // // // // // // // // //     try {
// // // // // // // // // // // //       const resp = await fetch(Logo); // imported logo
// // // // // // // // // // // //       const blob = await resp.blob();
// // // // // // // // // // // //       logoDataUrl = await new Promise((resolve) => {
// // // // // // // // // // // //         const reader = new FileReader();
// // // // // // // // // // // //         reader.onloadend = () => resolve(reader.result);
// // // // // // // // // // // //         reader.readAsDataURL(blob);
// // // // // // // // // // // //       });
// // // // // // // // // // // //     } catch (err) {
// // // // // // // // // // // //       console.warn("⚠️ Logo load failed");
// // // // // // // // // // // //     }

// // // // // // // // // // // //     /* -------------------------
// // // // // // // // // // // //        HEADER (Cohort + Batch)
// // // // // // // // // // // //     -------------------------*/
// // // // // // // // // // // //     doc.setFont("helvetica", "bold");
// // // // // // // // // // // //     doc.setFontSize(16);

// // // // // // // // // // // //     const cohortName =
// // // // // // // // // // // //       cohorts.find((c) => String(c.cohort_number) === String(formData.cohort))
// // // // // // // // // // // //         ?.cohort_name || `Cohort ${formData.cohort || "-"}`;

// // // // // // // // // // // //     const batchName =
// // // // // // // // // // // //       batches.find((b) => String(b.batch_id) === String(formData.batch))
// // // // // // // // // // // //         ?.batch_name || `Batch ${formData.batch || "-"}`;

// // // // // // // // // // // //     const titleLines = [
// // // // // // // // // // // //       "PRATIBHA POSHAK",
// // // // // // // // // // // //       `${cohortName} - ${batchName} - STUDENT REPORT`,
// // // // // // // // // // // //     ];

// // // // // // // // // // // //     let baseY = 40;

// // // // // // // // // // // //     titleLines.forEach((line, i) => {
// // // // // // // // // // // //       const x = (pageWidth - doc.getTextWidth(line)) / 2;
// // // // // // // // // // // //       doc.text(line, x, baseY + i * 18);
// // // // // // // // // // // //     });

// // // // // // // // // // // //     // Add logo on the top-right
// // // // // // // // // // // //     if (logoDataUrl) {
// // // // // // // // // // // //       doc.addImage(logoDataUrl, "JPEG", pageWidth - 100, 20, 60, 60);
// // // // // // // // // // // //     }

// // // // // // // // // // // //     /* -------------------------
// // // // // // // // // // // //        TABLE DATA
// // // // // // // // // // // //     -------------------------*/
// // // // // // // // // // // //     const tableData = filteredStudents.map((s) => ({
// // // // // // // // // // // //       student: s.student_name ?? "-",
// // // // // // // // // // // //       enrollment: s.enr_id ?? "-",
// // // // // // // // // // // //       cohort: s.cohort_name ?? "-",
// // // // // // // // // // // //       batch: s.batch_name ?? "-",
// // // // // // // // // // // //       contact: s.contact_no1 ?? "-",
// // // // // // // // // // // //       status: s.active_yn ?? "-",
// // // // // // // // // // // //     }));

// // // // // // // // // // // //     /* -------------------------
// // // // // // // // // // // //        AUTOTABLE EXPORT
// // // // // // // // // // // //     -------------------------*/
// // // // // // // // // // // //     autoTable(doc, {
// // // // // // // // // // // //       startY: 100,

// // // // // // // // // // // //       columns: [
// // // // // // // // // // // //         { header: "Student", dataKey: "student" },
// // // // // // // // // // // //         { header: "Enrollment", dataKey: "enrollment" },
// // // // // // // // // // // //         { header: "Cohort", dataKey: "cohort" },
// // // // // // // // // // // //         { header: "Batch", dataKey: "batch" },
// // // // // // // // // // // //         { header: "Contact", dataKey: "contact" },
// // // // // // // // // // // //         { header: "Status", dataKey: "status" },
// // // // // // // // // // // //       ],

// // // // // // // // // // // //       body: tableData,

// // // // // // // // // // // //       theme: "grid",
// // // // // // // // // // // //       tableWidth: "auto",
// // // // // // // // // // // //       margin: { left: 20, right: 20 },

// // // // // // // // // // // //       headStyles: {
// // // // // // // // // // // //         fillColor: [16, 185, 129],
// // // // // // // // // // // //         textColor: 255,
// // // // // // // // // // // //         fontSize: 10,
// // // // // // // // // // // //         halign: "center",
// // // // // // // // // // // //       },

// // // // // // // // // // // //       styles: {
// // // // // // // // // // // //         fontSize: 9,
// // // // // // // // // // // //         cellPadding: 3,
// // // // // // // // // // // //         halign: "center",
// // // // // // // // // // // //         valign: "middle",
// // // // // // // // // // // //       },

// // // // // // // // // // // //       columnStyles: {
// // // // // // // // // // // //         student: { cellWidth: 130 },
// // // // // // // // // // // //         enrollment: { cellWidth: 90 },
// // // // // // // // // // // //         cohort: { cellWidth: 80 },
// // // // // // // // // // // //         batch: { cellWidth: 80 },
// // // // // // // // // // // //         contact: { cellWidth: 100 },
// // // // // // // // // // // //         status: { cellWidth: 60 },
// // // // // // // // // // // //       },
// // // // // // // // // // // //     });

// // // // // // // // // // // //     /* -------------------------
// // // // // // // // // // // //        SAVE
// // // // // // // // // // // //     -------------------------*/
// // // // // // // // // // // //     doc.save("Student_Report.pdf");
// // // // // // // // // // // //   } catch (err) {
// // // // // // // // // // // //     console.error("PDF export failed", err);
// // // // // // // // // // // //     alert("Failed to generate PDF.");
// // // // // // // // // // // //   } finally {
// // // // // // // // // // // //     setExportOpen(false);
// // // // // // // // // // // //   }
// // // // // // // // // // // // };



// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   /*             EXPORT: EXCEL (XLSX)           */
// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   const exportExcel = () => {
// // // // // // // // // // // //     if (!filteredStudents.length) {
// // // // // // // // // // // //       alert("No rows to export.");
// // // // // // // // // // // //       return;
// // // // // // // // // // // //     }

// // // // // // // // // // // //     const exportData = filteredStudents.map((s) => ({
// // // // // // // // // // // //       "Student Name": s.student_name ?? "-",
// // // // // // // // // // // //       "Enrollment ID": s.enr_id ?? "-",
// // // // // // // // // // // //       Cohort: s.cohort_name ?? "-",
// // // // // // // // // // // //       Batch: s.batch_name ?? "-",
// // // // // // // // // // // //       "Contact No": s.contact_no1 ?? "-",
// // // // // // // // // // // //       Status: s.active_yn ?? "-",
// // // // // // // // // // // //       Teacher: s.teacher_name ?? "-",
// // // // // // // // // // // //     }));

// // // // // // // // // // // //     const worksheet = XLSX.utils.json_to_sheet(exportData);
// // // // // // // // // // // //     // Auto column width (simple)
// // // // // // // // // // // //     const cols = Object.keys(exportData[0]).map((k) => ({ wch: Math.min(30, Math.max(8, k.length + 4)) }));
// // // // // // // // // // // //     worksheet["!cols"] = cols;

// // // // // // // // // // // //     const workbook = XLSX.utils.book_new();
// // // // // // // // // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // // // // // // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // // // // // // // // //     setExportOpen(false);
// // // // // // // // // // // //   };

// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   /*               EDIT LOGIC                   */
// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   const openEdit = (student) => {
// // // // // // // // // // // //     setEditStudent(student);
// // // // // // // // // // // //     const prefill = {};
// // // // // // // // // // // //     editableFields.forEach((k) => (prefill[k] = student[k] ?? ""));
// // // // // // // // // // // //     setEditForm(prefill);
// // // // // // // // // // // //   };

// // // // // // // // // // // //   const handleEditChange = (e) => {
// // // // // // // // // // // //     const { name, value } = e.target;
// // // // // // // // // // // //     setEditForm((p) => ({ ...p, [name]: value }));
// // // // // // // // // // // //   };

// // // // // // // // // // // //   const saveEdit = async () => {
// // // // // // // // // // // //     if (!editStudent) return;
// // // // // // // // // // // //     const payload = {};
// // // // // // // // // // // //     editableFields.forEach((k) => (payload[k] = editForm[k]));

// // // // // // // // // // // //     try {
// // // // // // // // // // // //       await axios.put(
// // // // // // // // // // // //         `${process.env.REACT_APP_BACKEND_API_URL}/api/coordinator/students/${editStudent.student_id}`,
// // // // // // // // // // // //         payload,
// // // // // // // // // // // //         axiosConfig()
// // // // // // // // // // // //       );

// // // // // // // // // // // //       setStudents((prev) =>
// // // // // // // // // // // //         prev.map((s) =>
// // // // // // // // // // // //           s.student_id === editStudent.student_id ? { ...s, ...payload } : s
// // // // // // // // // // // //         )
// // // // // // // // // // // //       );

// // // // // // // // // // // //       setEditStudent(null);
// // // // // // // // // // // //       alert("Student updated.");
// // // // // // // // // // // //     } catch (err) {
// // // // // // // // // // // //       console.error(err);
// // // // // // // // // // // //       alert("Failed to update student.");
// // // // // // // // // // // //     }
// // // // // // // // // // // //   };

// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   /*             INACTIVE LOGIC                 */
// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   const openInactiveModal = (student) => {
// // // // // // // // // // // //     setInactiveModal(student);
// // // // // // // // // // // //     setInactiveReason(student.inactive_reason || "");
// // // // // // // // // // // //   };

// // // // // // // // // // // //   const confirmInactive = async () => {
// // // // // // // // // // // //     if (!inactiveReason.trim()) return alert("Please enter reason.");

// // // // // // // // // // // //     const payload = { active_yn: "inactive", inactive_reason: inactiveReason };

// // // // // // // // // // // //     try {
// // // // // // // // // // // //       await axios.put(
// // // // // // // // // // // //         `${process.env.REACT_APP_BACKEND_API_URL}/api/coordinator/students/${inactiveModal.student_id}`,
// // // // // // // // // // // //         payload,
// // // // // // // // // // // //         axiosConfig()
// // // // // // // // // // // //       );

// // // // // // // // // // // //       setStudents((prev) =>
// // // // // // // // // // // //         prev.map((s) =>
// // // // // // // // // // // //           s.student_id === inactiveModal.student_id ? { ...s, ...payload } : s
// // // // // // // // // // // //         )
// // // // // // // // // // // //       );

// // // // // // // // // // // //       setInactiveModal(null);
// // // // // // // // // // // //       setInactiveReason("");
// // // // // // // // // // // //     } catch (err) {
// // // // // // // // // // // //       console.error(err);
// // // // // // // // // // // //       alert("Failed to update.");
// // // // // // // // // // // //     }
// // // // // // // // // // // //   };

// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   /*                   UI                       */
// // // // // // // // // // // //   /**********************************************/
// // // // // // // // // // // //   return (
// // // // // // // // // // // //     <div className="container">
// // // // // // // // // // // //       {/* PAGE HEADER */}
// // // // // // // // // // // //       <div className="page-header">
// // // // // // // // // // // //         <div>
// // // // // // // // // // // //           <h1 className="title">Student Management</h1>
// // // // // // // // // // // //           <p className="subtitle">Students assigned to your cohorts/batches</p>
// // // // // // // // // // // //         </div>
// // // // // // // // // // // //       </div>

// // // // // // // // // // // //       {/* FILTERS */}
// // // // // // // // // // // //       <div className="filter-bar">
// // // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // // //           <Filter className="input-icon" />
// // // // // // // // // // // //           <select
// // // // // // // // // // // //             value={formData.cohort}
// // // // // // // // // // // //             onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}
// // // // // // // // // // // //           >
// // // // // // // // // // // //             <option value="">All Cohorts</option>
// // // // // // // // // // // //             {cohorts.map((c) => (
// // // // // // // // // // // //               <option
// // // // // // // // // // // //                 key={c.cohort_number ?? c.cohort_id}
// // // // // // // // // // // //                 value={c.cohort_number ?? c.cohort_id}
// // // // // // // // // // // //               >
// // // // // // // // // // // //                 {c.cohort_name || `Cohort ${c.cohort_number}`}
// // // // // // // // // // // //               </option>
// // // // // // // // // // // //             ))}
// // // // // // // // // // // //           </select>
// // // // // // // // // // // //         </div>

// // // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // // //           <select
// // // // // // // // // // // //             value={formData.batch}
// // // // // // // // // // // //             disabled={!formData.cohort}
// // // // // // // // // // // //             onChange={(e) =>
// // // // // // // // // // // //               setFormData((p) => ({ ...p, batch: e.target.value }))
// // // // // // // // // // // //             }
// // // // // // // // // // // //           >
// // // // // // // // // // // //             <option value="">All Batches</option>
// // // // // // // // // // // //             {batches.map((b) => (
// // // // // // // // // // // //               <option key={b.batch_id} value={b.batch_id}>
// // // // // // // // // // // //                 {b.batch_name}
// // // // // // // // // // // //               </option>
// // // // // // // // // // // //             ))}
// // // // // // // // // // // //           </select>
// // // // // // // // // // // //         </div>

// // // // // // // // // // // //         <div className="filter-item search-box">
// // // // // // // // // // // //           <Search className="input-icon" />
// // // // // // // // // // // //           <input
// // // // // // // // // // // //             placeholder="Search by name or enrollment ID"
// // // // // // // // // // // //             value={searchQuery}
// // // // // // // // // // // //             onChange={(e) => setSearchQuery(e.target.value)}
// // // // // // // // // // // //           />
// // // // // // // // // // // //         </div>

// // // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // // //           <select
// // // // // // // // // // // //             value={statusFilter}
// // // // // // // // // // // //             onChange={(e) => setStatusFilter(e.target.value)}
// // // // // // // // // // // //           >
// // // // // // // // // // // //             <option value="all">All Status</option>
// // // // // // // // // // // //             <option value="active">Active</option>
// // // // // // // // // // // //             <option value="inactive">Inactive</option>
// // // // // // // // // // // //           </select>
// // // // // // // // // // // //         </div>

// // // // // // // // // // // //         {/* EXPORT DROPDOWN */}
// // // // // // // // // // // //         <div className="export-menu-wrapper">
// // // // // // // // // // // //           <button
// // // // // // // // // // // //             className="export-button"
// // // // // // // // // // // //             onClick={() => setExportOpen((p) => !p)}
// // // // // // // // // // // //           >
// // // // // // // // // // // //             <Download className="icon" />
// // // // // // // // // // // //             <span>Export</span>
// // // // // // // // // // // //             <ChevronDown size={16} />
// // // // // // // // // // // //           </button>

// // // // // // // // // // // //           {exportOpen && (
// // // // // // // // // // // //             <div className="export-dropdown">
// // // // // // // // // // // //               <button onClick={exportCSV}>Export as CSV</button>
// // // // // // // // // // // //               <button onClick={exportPDF}>Export as PDF</button>
// // // // // // // // // // // //               <button onClick={exportExcel}>Export as Excel</button>
// // // // // // // // // // // //             </div>
// // // // // // // // // // // //           )}
// // // // // // // // // // // //         </div>
// // // // // // // // // // // //       </div>

// // // // // // // // // // // //       {/* TABLE */}
// // // // // // // // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // // // // // // // //         <table className="students-table">
// // // // // // // // // // // //           <thead>
// // // // // // // // // // // //             <tr>
// // // // // // // // // // // //               <th>Student</th>
// // // // // // // // // // // //               <th>Cohort</th>
// // // // // // // // // // // //               <th>Batch</th>
// // // // // // // // // // // //               <th>Contact</th>
// // // // // // // // // // // //               <th>Status</th>
// // // // // // // // // // // //               <th style={{ width: 150 }}>Actions</th>
// // // // // // // // // // // //             </tr>
// // // // // // // // // // // //           </thead>

// // // // // // // // // // // //           <tbody>
// // // // // // // // // // // //             {loading ? (
// // // // // // // // // // // //               <tr>
// // // // // // // // // // // //                 <td colSpan="6" className="no-data">
// // // // // // // // // // // //                   Loading...
// // // // // // // // // // // //                 </td>
// // // // // // // // // // // //               </tr>
// // // // // // // // // // // //             ) : filteredStudents.length === 0 ? (
// // // // // // // // // // // //               <tr>
// // // // // // // // // // // //                 <td colSpan="6" className="no-data">
// // // // // // // // // // // //                   No students found.
// // // // // // // // // // // //                 </td>
// // // // // // // // // // // //               </tr>
// // // // // // // // // // // //             ) : (
// // // // // // // // // // // //               filteredStudents.map((s) => (
// // // // // // // // // // // //                 <tr key={s.student_id}>
// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <div className="student-info">
// // // // // // // // // // // //                       <User2 className="icon text-blue-500 mr-2" />
// // // // // // // // // // // //                       <div>
// // // // // // // // // // // //                         <div className="name">{s.student_name}</div>
// // // // // // // // // // // //                         <div className="id">{s.enr_id}</div>
// // // // // // // // // // // //                       </div>
// // // // // // // // // // // //                     </div>
// // // // // // // // // // // //                   </td>

// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <span className="badge">{s.cohort_name || "—"}</span>
// // // // // // // // // // // //                   </td>

// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <span className="badge">{s.batch_name || "—"}</span>
// // // // // // // // // // // //                   </td>

// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <Phone className="inline w-3 h-3 mr-1 text-gray-500" />
// // // // // // // // // // // //                     {s.contact_no1}
// // // // // // // // // // // //                   </td>

// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <span
// // // // // // // // // // // //                       className={`status-badge ${
// // // // // // // // // // // //                         (s.active_yn ?? "").toLowerCase() === "active"
// // // // // // // // // // // //                           ? "active"
// // // // // // // // // // // //                           : "inactive"
// // // // // // // // // // // //                       }`}
// // // // // // // // // // // //                     >
// // // // // // // // // // // //                       {s.active_yn}
// // // // // // // // // // // //                     </span>
// // // // // // // // // // // //                   </td>

// // // // // // // // // // // //                   <td>
// // // // // // // // // // // //                     <div className="actions">
// // // // // // // // // // // //                       <button
// // // // // // // // // // // //                         title="View"
// // // // // // // // // // // //                         onClick={() => setViewStudent(s)}
// // // // // // // // // // // //                       >
// // // // // // // // // // // //                         <Eye className="icon" />
// // // // // // // // // // // //                       </button>

// // // // // // // // // // // //                       <button title="Edit" onClick={() => openEdit(s)}>
// // // // // // // // // // // //                         <Edit className="icon" />
// // // // // // // // // // // //                       </button>

// // // // // // // // // // // //                       {(s.active_yn ?? "").toLowerCase() === "active" && (
// // // // // // // // // // // //                         <button
// // // // // // // // // // // //                           title="Set Inactive"
// // // // // // // // // // // //                           onClick={() => openInactiveModal(s)}
// // // // // // // // // // // //                         >
// // // // // // // // // // // //                           <AlertTriangle className="icon text-red-500" />
// // // // // // // // // // // //                         </button>
// // // // // // // // // // // //                       )}
// // // // // // // // // // // //                     </div>
// // // // // // // // // // // //                   </td>
// // // // // // // // // // // //                 </tr>
// // // // // // // // // // // //               ))
// // // // // // // // // // // //             )}
// // // // // // // // // // // //           </tbody>
// // // // // // // // // // // //         </table>
// // // // // // // // // // // //       </div>

// // // // // // // // // // // //       {/* MODALS BELOW — unchanged */}

// // // // // // // // // // // //       {viewStudent && (
// // // // // // // // // // // //         <div className="modal">
// // // // // // // // // // // //           <div className="modal-content large">
// // // // // // // // // // // //             <button className="close-btn" onClick={() => setViewStudent(null)}>
// // // // // // // // // // // //               <X size={18} />
// // // // // // // // // // // //             </button>
// // // // // // // // // // // //             <h3 className="modal-title">
// // // // // // // // // // // //               <Eye className="inline w-5 h-5 mr-1 text-blue-500" /> Student
// // // // // // // // // // // //               Profile
// // // // // // // // // // // //             </h3>

// // // // // // // // // // // //             <div className="profile-section">
// // // // // // // // // // // //               <h4>Basic Details</h4>
// // // // // // // // // // // //               <div className="profile-grid">
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Name:</strong> {viewStudent.student_name}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Enrollment ID:</strong> {viewStudent.enr_id}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Gender:</strong> {viewStudent.gender}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Status:</strong>{" "}
// // // // // // // // // // // //                   <span
// // // // // // // // // // // //                     className={`status-badge ${
// // // // // // // // // // // //                       (viewStudent.active_yn ?? "").toLowerCase() === "active"
// // // // // // // // // // // //                         ? "active"
// // // // // // // // // // // //                         : "inactive"
// // // // // // // // // // // //                     }`}
// // // // // // // // // // // //                   >
// // // // // // // // // // // //                     {viewStudent.active_yn}
// // // // // // // // // // // //                   </span>
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //               </div>
// // // // // // // // // // // //             </div>

// // // // // // // // // // // //             <div className="profile-section">
// // // // // // // // // // // //               <h4>Parent Details</h4>
// // // // // // // // // // // //               <div className="profile-grid">
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Father:</strong> {viewStudent.father_name} (
// // // // // // // // // // // //                   {viewStudent.father_occupation})
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Mother:</strong> {viewStudent.mother_name} (
// // // // // // // // // // // //                   {viewStudent.mother_occupation})
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Parent Email:</strong> {viewStudent.parent_email}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Parent Contact:</strong> {viewStudent.contact_no2}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //               </div>
// // // // // // // // // // // //             </div>

// // // // // // // // // // // //             <div className="profile-section">
// // // // // // // // // // // //               <h4>Contact & Institution</h4>
// // // // // // // // // // // //               <div className="profile-grid">
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <Mail className="inline w-3 h-3 mr-1 text-gray-500" />{" "}
// // // // // // // // // // // //                   {viewStudent.student_email}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <MapPin className="inline w-3 h-3 mr-1 text-gray-500" />{" "}
// // // // // // // // // // // //                   {viewStudent.home_address}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Current Institute:</strong>{" "}
// // // // // // // // // // // //                   {viewStudent.current_institute}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Previous Institute:</strong>{" "}
// // // // // // // // // // // //                   {viewStudent.previous_institute}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>DISE Code:</strong> {viewStudent.disecode}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //               </div>
// // // // // // // // // // // //             </div>

// // // // // // // // // // // //             <div className="profile-section">
// // // // // // // // // // // //               <h4>Academic & Others</h4>
// // // // // // // // // // // //               <div className="profile-grid">
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Batch:</strong> {viewStudent.batch_name}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Cohort:</strong> {viewStudent.cohort_name}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Teacher:</strong> {viewStudent.teacher_name}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //                 <div>
// // // // // // // // // // // //                   <strong>Inactive Reason:</strong>{" "}
// // // // // // // // // // // //                   {viewStudent.inactive_reason}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //               </div>
// // // // // // // // // // // //             </div>
// // // // // // // // // // // //           </div>
// // // // // // // // // // // //         </div>
// // // // // // // // // // // //       )}

// // // // // // // // // // // //       {editStudent && (
// // // // // // // // // // // //         <div className="modal">
// // // // // // // // // // // //           <div className="modal-content large">
// // // // // // // // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}>
// // // // // // // // // // // //               <X size={18} />
// // // // // // // // // // // //             </button>

// // // // // // // // // // // //             <h3 className="modal-title">
// // // // // // // // // // // //               <Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit
// // // // // // // // // // // //               Student
// // // // // // // // // // // //             </h3>

// // // // // // // // // // // //             <div className="edit-form grid-2-col">
// // // // // // // // // // // //               {editableFields.map((k) => (
// // // // // // // // // // // //                 <div className="form-group" key={k}>
// // // // // // // // // // // //                   <label>{k.replace(/_/g, " ")}</label>

// // // // // // // // // // // //                   {k === "active_yn" ? (
// // // // // // // // // // // //                     <select
// // // // // // // // // // // //                       name={k}
// // // // // // // // // // // //                       value={editForm[k]}
// // // // // // // // // // // //                       onChange={handleEditChange}
// // // // // // // // // // // //                     >
// // // // // // // // // // // //                       <option value="">--select--</option>
// // // // // // // // // // // //                       <option value="active">Active</option>
// // // // // // // // // // // //                       <option value="inactive">Inactive</option>
// // // // // // // // // // // //                     </select>
// // // // // // // // // // // //                   ) : k === "inactive_reason" ? (
// // // // // // // // // // // //                     <input
// // // // // // // // // // // //                       type="text"
// // // // // // // // // // // //                       name={k}
// // // // // // // // // // // //                       value={editForm[k]}
// // // // // // // // // // // //                       onChange={handleEditChange}
// // // // // // // // // // // //                       placeholder="If inactive, enter reason"
// // // // // // // // // // // //                     />
// // // // // // // // // // // //                   ) : (
// // // // // // // // // // // //                     <input
// // // // // // // // // // // //                       type="text"
// // // // // // // // // // // //                       name={k}
// // // // // // // // // // // //                       value={editForm[k]}
// // // // // // // // // // // //                       onChange={handleEditChange}
// // // // // // // // // // // //                     />
// // // // // // // // // // // //                   )}
// // // // // // // // // // // //                 </div>
// // // // // // // // // // // //               ))}
// // // // // // // // // // // //             </div>

// // // // // // // // // // // //             <div className="modal-actions">
// // // // // // // // // // // //               <button
// // // // // // // // // // // //                 className="btn secondary"
// // // // // // // // // // // //                 onClick={() => setEditStudent(null)}
// // // // // // // // // // // //               >
// // // // // // // // // // // //                 Cancel
// // // // // // // // // // // //               </button>
// // // // // // // // // // // //               <button className="btn primary" onClick={saveEdit}>
// // // // // // // // // // // //                 <CheckCircle className="inline mr-1" /> Save
// // // // // // // // // // // //               </button>
// // // // // // // // // // // //             </div>
// // // // // // // // // // // //           </div>
// // // // // // // // // // // //         </div>
// // // // // // // // // // // //       )}

// // // // // // // // // // // //       {inactiveModal && (
// // // // // // // // // // // //         <div className="modal">
// // // // // // // // // // // //           <div className="modal-content small">
// // // // // // // // // // // //             <button
// // // // // // // // // // // //               className="close-btn"
// // // // // // // // // // // //               onClick={() => setInactiveModal(null)}
// // // // // // // // // // // //             >
// // // // // // // // // // // //               <X size={18} />
// // // // // // // // // // // //             </button>

// // // // // // // // // // // //             <h3 className="modal-title text-red-600">
// // // // // // // // // // // //               <AlertTriangle className="inline w-5 h-5 mr-1" /> Mark Inactive
// // // // // // // // // // // //             </h3>

// // // // // // // // // // // //             <p>
// // // // // // // // // // // //               Enter reason for marking{" "}
// // // // // // // // // // // //               <strong>{inactiveModal.student_name}</strong> inactive:
// // // // // // // // // // // //             </p>

// // // // // // // // // // // //             <textarea
// // // // // // // // // // // //               rows={4}
// // // // // // // // // // // //               value={inactiveReason}
// // // // // // // // // // // //               onChange={(e) => setInactiveReason(e.target.value)}
// // // // // // // // // // // //               placeholder="Reason..."
// // // // // // // // // // // //             />

// // // // // // // // // // // //             <div className="modal-actions">
// // // // // // // // // // // //               <button
// // // // // // // // // // // //                 className="btn secondary"
// // // // // // // // // // // //                 onClick={() => setInactiveModal(null)}
// // // // // // // // // // // //               >
// // // // // // // // // // // //                 Cancel
// // // // // // // // // // // //               </button>

// // // // // // // // // // // //               <button className="btn danger" onClick={confirmInactive}>
// // // // // // // // // // // //                 <CheckCircle className="inline mr-1" /> Confirm
// // // // // // // // // // // //               </button>
// // // // // // // // // // // //             </div>
// // // // // // // // // // // //           </div>
// // // // // // // // // // // //         </div>
// // // // // // // // // // // //       )}

// // // // // // // // // // // //       {/* SIMPLE DROPDOWN CSS */}
// // // // // // // // // // // //       <style>{`
// // // // // // // // // // // //         .export-menu-wrapper {
// // // // // // // // // // // //           position: relative;
// // // // // // // // // // // //         }
// // // // // // // // // // // //         .export-dropdown {
// // // // // // // // // // // //           position: absolute;
// // // // // // // // // // // //           top: 110%;
// // // // // // // // // // // //           right: 0;
// // // // // // // // // // // //           background: white;
// // // // // // // // // // // //           border: 1px solid #ddd;
// // // // // // // // // // // //           box-shadow: 0 2px 8px rgba(0,0,0,0.15);
// // // // // // // // // // // //           border-radius: 6px;
// // // // // // // // // // // //           padding: 6px 0;
// // // // // // // // // // // //           z-index: 999;
// // // // // // // // // // // //           min-width: 180px;
// // // // // // // // // // // //         }
// // // // // // // // // // // //         .export-dropdown button {
// // // // // // // // // // // //           width: 100%;
// // // // // // // // // // // //           text-align: left;
// // // // // // // // // // // //           padding: 8px 14px;
// // // // // // // // // // // //           background: white;
// // // // // // // // // // // //           border: none;
// // // // // // // // // // // //           cursor: pointer;
// // // // // // // // // // // //           font-size: 14px;
// // // // // // // // // // // //         }
// // // // // // // // // // // //         .export-dropdown button:hover {
// // // // // // // // // // // //           background: #f5f5f5;
// // // // // // // // // // // //         }
// // // // // // // // // // // //       `}</style>
// // // // // // // // // // // //     </div>
// // // // // // // // // // // //   );
// // // // // // // // // // // // }


// // // // // // // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // // // // // // import React, { useState, useEffect } from "react";

// // // // // // // // // // // import axios from "axios";
// // // // // // // // // // // import "./BatchManagement.css";
// // // // // // // // // // // import {
// // // // // // // // // // //   Search,
// // // // // // // // // // //   Download,
// // // // // // // // // // //   Eye,
// // // // // // // // // // //   Edit,
// // // // // // // // // // //   X,
// // // // // // // // // // //   CheckCircle,
// // // // // // // // // // //   User2,
// // // // // // // // // // //   Phone,
// // // // // // // // // // //   Mail,
// // // // // // // // // // //   MapPin,
// // // // // // // // // // //   AlertTriangle,
// // // // // // // // // // //   Filter,
// // // // // // // // // // //   ChevronDown,
// // // // // // // // // // // } from "lucide-react";
// // // // // // // // // // // import { useAuth } from "../../contexts/AuthContext";
// // // // // // // // // // // import { jsPDF } from "jspdf";
// // // // // // // // // // // import autoTable from "jspdf-autotable";
// // // // // // // // // // // import * as XLSX from "xlsx";
// // // // // // // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // // // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // // // // // // export default function StudentManagement() {

// // // // // // // // // // //   const [fullPhoto, setFullPhoto] = useState(null);

// // // // // // // // // // //   const { user } = useAuth();
// // // // // // // // // // //   const token = user?.token;

// // // // // // // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // // // // // // //   const [batches, setBatches] = useState([]);
// // // // // // // // // // //   const [institutes, setInstitutes] = useState([]);

// // // // // // // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });

// // // // // // // // // // //   const [students, setStudents] = useState([]);
// // // // // // // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // // // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // // // // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // // // // // // // //   const [loading, setLoading] = useState(false);

// // // // // // // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // // // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // // // // // // //   const [editForm, setEditForm] = useState({});

// // // // // // // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // // // // // // //   const [inactiveReason, setInactiveReason] = useState("");

// // // // // // // // // // //   const [photoFile, setPhotoFile] = useState(null);
// // // // // // // // // // //   const [exportOpen, setExportOpen] = useState(false);


// // // // // // // // // // //   const axiosConfig = () => ({
// // // // // // // // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // // // // // // // //   });

// // // // // // // // // // //   /* ---------------- FETCH COHORTS ---------------- */
// // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // //     if (!token) return;
// // // // // // // // // // //     axios
// // // // // // // // // // //       .get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig())
// // // // // // // // // // //       .then(({ data }) => setCohorts(data || []))
// // // // // // // // // // //       .catch(() => setCohorts([]));
// // // // // // // // // // //   }, [token]);

// // // // // // // // // // //   /* ---------------- FETCH BATCHES ---------------- */
// // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // //     if (!token || !formData.cohort) {
// // // // // // // // // // //       setBatches([]);
// // // // // // // // // // //       return;
// // // // // // // // // // //     }
// // // // // // // // // // //     axios
// // // // // // // // // // //       .get(`${BACKEND}/api/coordinator/batches`, {
// // // // // // // // // // //         ...axiosConfig(),
// // // // // // // // // // //         params: { cohort_number: formData.cohort },
// // // // // // // // // // //       })
// // // // // // // // // // //       .then(({ data }) => setBatches(data || []))
// // // // // // // // // // //       .catch(() => setBatches([]));
// // // // // // // // // // //   }, [token, formData.cohort]);

// // // // // // // // // // //   /* ---------------- FETCH INSTITUTES ---------------- */
// // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // //     if (!token) return;
// // // // // // // // // // //     axios
// // // // // // // // // // //       .get(`${BACKEND}/api/institutes`, axiosConfig())
// // // // // // // // // // //       .then(({ data }) => setInstitutes(data || []))
// // // // // // // // // // //       .catch(() => setInstitutes([]));
// // // // // // // // // // //   }, [token]);

// // // // // // // // // // //   /* ---------------- FETCH STUDENTS ---------------- */
// // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // //     if (!token) return;
// // // // // // // // // // //     setLoading(true);

// // // // // // // // // // //     const params = {};
// // // // // // // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // // // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // // // // // // //     axios
// // // // // // // // // // //       .get(`${BACKEND}/api/coordinator/students`, {
// // // // // // // // // // //         ...axiosConfig(),
// // // // // // // // // // //         params,
// // // // // // // // // // //       })
// // // // // // // // // // //       .then(({ data }) => setStudents(data || []))
// // // // // // // // // // //       .catch(() => setStudents([]))
// // // // // // // // // // //       .finally(() => setLoading(false));
// // // // // // // // // // //   }, [token, formData]);

// // // // // // // // // // //   /* ---------------- FILTER ---------------- */
// // // // // // // // // // //   useEffect(() => {
// // // // // // // // // // //     let f = [...students];

// // // // // // // // // // //     if (searchQuery.trim()) {
// // // // // // // // // // //       const q = searchQuery.toLowerCase();
// // // // // // // // // // //       f = f.filter(
// // // // // // // // // // //         (s) =>
// // // // // // // // // // //           s.student_name?.toLowerCase().includes(q) ||
// // // // // // // // // // //           String(s.enr_id ?? "").includes(q)
// // // // // // // // // // //       );
// // // // // // // // // // //     }

// // // // // // // // // // //     if (statusFilter !== "all") {
// // // // // // // // // // //       f = f.filter(
// // // // // // // // // // //         (s) => (s.active_yn || "").toUpperCase() === statusFilter
// // // // // // // // // // //       );
// // // // // // // // // // //     }

// // // // // // // // // // //     setFilteredStudents(f);
// // // // // // // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // // // // // // //   /* ---------------- EDIT ---------------- */
// // // // // // // // // // //   const openEdit = (s) => {
// // // // // // // // // // //     setEditStudent(s);
// // // // // // // // // // //     setEditForm({
// // // // // // // // // // //       student_name: s.student_name ?? "",
// // // // // // // // // // //       father_name: s.father_name ?? "",
// // // // // // // // // // //       father_occupation: s.father_occupation ?? "",
// // // // // // // // // // //       mother_name: s.mother_name ?? "",
// // // // // // // // // // //       mother_occupation: s.mother_occupation ?? "",
// // // // // // // // // // //       student_email: s.student_email ?? "",
// // // // // // // // // // //       parent_email: s.parent_email ?? "",
// // // // // // // // // // //       home_address: s.home_address ?? "",
// // // // // // // // // // //       teacher_name: s.teacher_name ?? "",
// // // // // // // // // // //       active_yn: s.active_yn ?? "",
// // // // // // // // // // //       current_institute_dise_code: s.current_institute_dise_code ?? "",
// // // // // // // // // // //       previous_institute_dise_code: s.previous_institute_dise_code ?? "",
// // // // // // // // // // //     });
// // // // // // // // // // //     setPhotoFile(null);
// // // // // // // // // // //   };

// // // // // // // // // // //   const handleEditChange = (e) =>
// // // // // // // // // // //     setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // // // // // // // //   const saveEdit = async () => {
// // // // // // // // // // //     await axios.put(
// // // // // // // // // // //       `${BACKEND}/api/coordinator/students/${editStudent.student_id}`,
// // // // // // // // // // //       editForm,
// // // // // // // // // // //       axiosConfig()
// // // // // // // // // // //     );

// // // // // // // // // // //     if (photoFile) {
// // // // // // // // // // //       const fd = new FormData();
// // // // // // // // // // //       fd.append("photo", photoFile);
// // // // // // // // // // //       await axios.post(
// // // // // // // // // // //         `${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`,
// // // // // // // // // // //         fd,
// // // // // // // // // // //         {
// // // // // // // // // // //           headers: {
// // // // // // // // // // //             Authorization: `Bearer ${token}`,
// // // // // // // // // // //             "Content-Type": "multipart/form-data",
// // // // // // // // // // //           },
// // // // // // // // // // //         }
// // // // // // // // // // //       );
// // // // // // // // // // //     }

// // // // // // // // // // //     setEditStudent(null);
// // // // // // // // // // //   };

// // // // // // // // // // //   /* ---------------- INACTIVE ---------------- */
// // // // // // // // // // //   const openInactiveModal = (s) => {
// // // // // // // // // // //     setInactiveModal(s);
// // // // // // // // // // //     setInactiveReason(s.inactive_reason || "");
// // // // // // // // // // //   };

// // // // // // // // // // //   const confirmInactive = async () => {
// // // // // // // // // // //     if (!inactiveReason.trim()) return alert("Enter reason");

// // // // // // // // // // //     await axios.put(
// // // // // // // // // // //       `${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`,
// // // // // // // // // // //       { active_yn: "INACTIVE", inactive_reason: inactiveReason },
// // // // // // // // // // //       axiosConfig()
// // // // // // // // // // //     );
// // // // // // // // // // //     setInactiveModal(null);
// // // // // // // // // // //     setInactiveReason("");
// // // // // // // // // // //   };

// // // // // // // // // // //   /* ---------------- UI ---------------- */
// // // // // // // // // // //   return (
// // // // // // // // // // //     <div className="container">
// // // // // // // // // // //       {/* PAGE HEADER */}
// // // // // // // // // // //       <div className="page-header">
// // // // // // // // // // //         <div>
// // // // // // // // // // //           <h1 className="title">Student Management</h1>
// // // // // // // // // // //           <p className="subtitle">Students assigned to your cohorts/batches</p>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* FILTER BAR */}
// // // // // // // // // // //       <div className="filter-bar">
// // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // //           <Filter className="input-icon" />
// // // // // // // // // // //           <select
// // // // // // // // // // //             value={formData.cohort}
// // // // // // // // // // //             onChange={(e) =>
// // // // // // // // // // //               setFormData({ cohort: e.target.value, batch: "" })
// // // // // // // // // // //             }
// // // // // // // // // // //           >
// // // // // // // // // // //             <option value="">All Cohorts</option>
// // // // // // // // // // //             {cohorts.map((c) => (
// // // // // // // // // // //               <option key={c.cohort_number} value={c.cohort_number}>
// // // // // // // // // // //                 {c.cohort_name}
// // // // // // // // // // //               </option>
// // // // // // // // // // //             ))}
// // // // // // // // // // //           </select>
// // // // // // // // // // //         </div>

// // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // //           <select
// // // // // // // // // // //             value={formData.batch}
// // // // // // // // // // //             disabled={!formData.cohort}
// // // // // // // // // // //             onChange={(e) =>
// // // // // // // // // // //               setFormData((p) => ({ ...p, batch: e.target.value }))
// // // // // // // // // // //             }
// // // // // // // // // // //           >
// // // // // // // // // // //             <option value="">All Batches</option>
// // // // // // // // // // //             {batches.map((b) => (
// // // // // // // // // // //               <option key={b.batch_id} value={b.batch_id}>
// // // // // // // // // // //                 {b.batch_name}
// // // // // // // // // // //               </option>
// // // // // // // // // // //             ))}
// // // // // // // // // // //           </select>
// // // // // // // // // // //         </div>

// // // // // // // // // // //         <div className="filter-item search-box">
// // // // // // // // // // //           <Search className="input-icon" />
// // // // // // // // // // //           <input
// // // // // // // // // // //             placeholder="Search by name or enrollment ID"
// // // // // // // // // // //             value={searchQuery}
// // // // // // // // // // //             onChange={(e) => setSearchQuery(e.target.value)}
// // // // // // // // // // //           />
// // // // // // // // // // //         </div>

// // // // // // // // // // //         <div className="filter-item">
// // // // // // // // // // //           <select
// // // // // // // // // // //             value={statusFilter}
// // // // // // // // // // //             onChange={(e) => setStatusFilter(e.target.value)}
// // // // // // // // // // //           >
// // // // // // // // // // //             <option value="all">All Status</option>
// // // // // // // // // // //             <option value="ACTIVE">Active</option>
// // // // // // // // // // //             <option value="INACTIVE">Inactive</option>
// // // // // // // // // // //           </select>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* TABLE */}
// // // // // // // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // // // // // // //         <table className="students-table">
// // // // // // // // // // //           <thead>
// // // // // // // // // // //             <tr>
// // // // // // // // // // //               <th>Student</th>
// // // // // // // // // // //               <th>Cohort</th>
// // // // // // // // // // //               <th>Batch</th>
// // // // // // // // // // //               <th>Contact</th>
// // // // // // // // // // //               <th>Status</th>
// // // // // // // // // // //               <th style={{ width: 150 }}>Actions</th>
// // // // // // // // // // //             </tr>
// // // // // // // // // // //           </thead>
// // // // // // // // // // //           <tbody>
// // // // // // // // // // //             {filteredStudents.map((s) => (
// // // // // // // // // // //               <tr key={s.student_id}>
// // // // // // // // // // //                 <td>
// // // // // // // // // // //                   <div className="student-info">
// // // // // // // // // // //                     <User2 className="icon text-blue-500 mr-2" />
// // // // // // // // // // //                     <div>
// // // // // // // // // // //                       <div className="name">{s.student_name}</div>
// // // // // // // // // // //                       <div className="id">{s.enr_id}</div>
// // // // // // // // // // //                     </div>
// // // // // // // // // // //                   </div>
// // // // // // // // // // //                 </td>
// // // // // // // // // // //                 <td><span className="badge">{s.cohort_name}</span></td>
// // // // // // // // // // //                 <td><span className="badge">{s.batch_name}</span></td>
// // // // // // // // // // //                 <td><Phone className="inline w-3 h-3 mr-1" />{s.contact_no1}</td>
// // // // // // // // // // //                 <td>
// // // // // // // // // // //                   <span className={`status-badge ${s.active_yn === "ACTIVE" ? "active" : "inactive"}`}>
// // // // // // // // // // //                     {s.active_yn}
// // // // // // // // // // //                   </span>
// // // // // // // // // // //                 </td>
// // // // // // // // // // //                 <td>
// // // // // // // // // // //                   <div className="actions">
// // // // // // // // // // //                     <button onClick={() => setViewStudent(s)}><Eye className="icon" /></button>
// // // // // // // // // // //                     <button onClick={() => openEdit(s)}><Edit className="icon" /></button>
// // // // // // // // // // //                     {s.active_yn === "ACTIVE" && (
// // // // // // // // // // //                       <button onClick={() => openInactiveModal(s)}>
// // // // // // // // // // //                         <AlertTriangle className="icon text-red-500" />
// // // // // // // // // // //                       </button>
// // // // // // // // // // //                     )}
// // // // // // // // // // //                   </div>
// // // // // // // // // // //                 </td>
// // // // // // // // // // //               </tr>
// // // // // // // // // // //             ))}
// // // // // // // // // // //           </tbody>
// // // // // // // // // // //         </table>
// // // // // // // // // // //       </div>

// // // // // // // // // // //        {viewStudent && (
// // // // // // // // // // //   <div className="modal">
// // // // // // // // // // //     <div className="modal-content large">
// // // // // // // // // // //       <button className="close-btn" onClick={() => setViewStudent(null)}>
// // // // // // // // // // //         <X size={18} />
// // // // // // // // // // //       </button>

// // // // // // // // // // //       <h3 className="modal-title">
// // // // // // // // // // //         <Eye className="inline w-5 h-5 mr-1 text-blue-500" /> Student Profile
// // // // // // // // // // //       </h3>

// // // // // // // // // // //       {/* STUDENT PHOTO (CIRCULAR) */}
// // // // // // // // // // // {viewStudent?.photo_link && (
// // // // // // // // // // //   <div style={{ textAlign: "center", marginBottom: 16 }}>
// // // // // // // // // // //     <div
// // // // // // // // // // //       style={{
// // // // // // // // // // //         width: 130,
// // // // // // // // // // //         height: 130,
// // // // // // // // // // //         borderRadius: "50%",
// // // // // // // // // // //         overflow: "hidden",
// // // // // // // // // // //         margin: "0 auto",
// // // // // // // // // // //         cursor: "pointer",
// // // // // // // // // // //         border: "3px solid #e5e7eb",
// // // // // // // // // // //       }}
// // // // // // // // // // //       onClick={() =>
// // // // // // // // // // //         setFullPhoto(
// // // // // // // // // // //           `${process.env.REACT_APP_BACKEND_API_URL}/${viewStudent.photo_link}`
// // // // // // // // // // //         )
// // // // // // // // // // //       }
// // // // // // // // // // //     >
// // // // // // // // // // //       <img
// // // // // // // // // // //         src={`${process.env.REACT_APP_BACKEND_API_URL}/${viewStudent.photo_link}`}
// // // // // // // // // // //         alt="Student"
// // // // // // // // // // //         style={{
// // // // // // // // // // //           width: "100%",
// // // // // // // // // // //           height: "100%",
// // // // // // // // // // //           objectFit: "cover",
// // // // // // // // // // //         }}
// // // // // // // // // // //       />
// // // // // // // // // // //     </div>

// // // // // // // // // // //     {/* STUDENT NAME */}
// // // // // // // // // // //     <div style={{ marginTop: 8, fontWeight: 600, fontSize: 15 }}>
// // // // // // // // // // //       {viewStudent.student_name}
// // // // // // // // // // //     </div>
// // // // // // // // // // //   </div>
// // // // // // // // // // // )}


// // // // // // // // // // //       {/* BASIC DETAILS */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>Basic Details</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Name:</strong> {viewStudent.student_name}</div>
// // // // // // // // // // //           <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // // // // // // // //           <div><strong>Gender:</strong> {viewStudent.gender}</div>
// // // // // // // // // // //           <div>
// // // // // // // // // // //             <strong>Status:</strong>{" "}
// // // // // // // // // // //             <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`}>
// // // // // // // // // // //               {viewStudent.active_yn}
// // // // // // // // // // //             </span>
// // // // // // // // // // //           </div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* PARENT DETAILS */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>Parent Details</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Father Name:</strong> {viewStudent.father_name}</div>
// // // // // // // // // // //           <div><strong>Father Occupation:</strong> {viewStudent.father_occupation}</div>
// // // // // // // // // // //           <div><strong>Mother Name:</strong> {viewStudent.mother_name}</div>
// // // // // // // // // // //           <div><strong>Mother Occupation:</strong> {viewStudent.mother_occupation}</div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* CONTACT DETAILS */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>Contact Details</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // // // // // // // //           <div><strong>Email Password:</strong> {viewStudent.student_email_password}</div>
// // // // // // // // // // //           <div><strong>Parent Email:</strong> {viewStudent.parent_email}</div>
// // // // // // // // // // //           <div><strong>Contact No (Student):</strong> {viewStudent.contact_no1}</div>
// // // // // // // // // // //           <div><strong>Contact No (Parent):</strong> {viewStudent.contact_no2}</div>
// // // // // // // // // // //           <div><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* INSTITUTE DETAILS */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>Institute Details</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // // // // // // // //           <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* ACADEMIC & OTHERS */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>Academic & Other Details</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // // // // // // // //           <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number}</div>
// // // // // // // // // // //           <div><strong>Recharge Status:</strong> {viewStudent.recharge_status}</div>
// // // // // // // // // // //           <div><strong>Sponsor:</strong> {viewStudent.sponsor}</div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>

// // // // // // // // // // //       {/* INACTIVE INFO */}
// // // // // // // // // // //       {viewStudent.active_yn === "INACTIVE" && (
// // // // // // // // // // //         <div className="profile-section">
// // // // // // // // // // //           <h4>Inactive Information</h4>
// // // // // // // // // // //           <div className="profile-grid">
// // // // // // // // // // //             <div><strong>Inactive Reason:</strong> {viewStudent.inactive_reason}</div>
// // // // // // // // // // //           </div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       )}

// // // // // // // // // // //       {/* METADATA */}
// // // // // // // // // // //       <div className="profile-section">
// // // // // // // // // // //         <h4>System Information</h4>
// // // // // // // // // // //         <div className="profile-grid">
// // // // // // // // // // //           <div><strong>Created At:</strong> {viewStudent.created_at}</div>
// // // // // // // // // // //           <div><strong>Updated At:</strong> {viewStudent.updated_at}</div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       </div>
// // // // // // // // // // //     </div>
// // // // // // // // // // //   </div>
// // // // // // // // // // // )}


// // // // // // // // // // //       {/* EDIT MODAL */}
// // // // // // // // // // //       {editStudent && (
// // // // // // // // // // //         <div className="modal">
// // // // // // // // // // //           <div className="modal-content large">
// // // // // // // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}>
// // // // // // // // // // //               <X size={18} />
// // // // // // // // // // //             </button>

// // // // // // // // // // //             <h3 className="modal-title">
// // // // // // // // // // //               <Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student
// // // // // // // // // // //             </h3>

// // // // // // // // // // //             <div className="edit-form grid-2-col">
// // // // // // // // // // //               {Object.keys(editForm).map((k) => (
// // // // // // // // // // //                 <div className="form-group" key={k}>
// // // // // // // // // // //                   <label>{k.replace(/_/g, " ")}</label>

// // // // // // // // // // //                   {k.includes("institute") ? (
// // // // // // // // // // //                     <select name={k} value={editForm[k]} onChange={handleEditChange}>
// // // // // // // // // // //                       <option value="">-- select --</option>
// // // // // // // // // // //                       {institutes.map((i) => (
// // // // // // // // // // //                         <option key={i.dise_code} value={i.dise_code}>
// // // // // // // // // // //                           {i.dise_code} - {i.institute_name}
// // // // // // // // // // //                         </option>
// // // // // // // // // // //                       ))}
// // // // // // // // // // //                     </select>
// // // // // // // // // // //                   ) : (
// // // // // // // // // // //                     <input name={k} value={editForm[k]} onChange={handleEditChange} />
// // // // // // // // // // //                   )}
// // // // // // // // // // //                 </div>
// // // // // // // // // // //               ))}

// // // // // // // // // // //               <div className="form-group">
// // // // // // // // // // //                 <label>Student Photo</label>
// // // // // // // // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} />
// // // // // // // // // // //               </div>
// // // // // // // // // // //             </div>

// // // // // // // // // // //             <div className="modal-actions">
// // // // // // // // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Cancel</button>
// // // // // // // // // // //               <button className="btn primary" onClick={saveEdit}>
// // // // // // // // // // //                 <CheckCircle className="inline mr-1" /> Save
// // // // // // // // // // //               </button>
// // // // // // // // // // //             </div>
// // // // // // // // // // //           </div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       )}

// // // // // // // // // // //       {/* INACTIVE MODAL */}
// // // // // // // // // // //       {inactiveModal && (
// // // // // // // // // // //         <div className="modal">
// // // // // // // // // // //           <div className="modal-content small">
// // // // // // // // // // //             <button className="close-btn" onClick={() => setInactiveModal(null)}>
// // // // // // // // // // //               <X size={18} />
// // // // // // // // // // //             </button>

// // // // // // // // // // //             <h3 className="modal-title text-red-600">
// // // // // // // // // // //               <AlertTriangle className="inline w-5 h-5 mr-1" /> Mark Inactive
// // // // // // // // // // //             </h3>

// // // // // // // // // // //             <textarea
// // // // // // // // // // //               rows={4}
// // // // // // // // // // //               value={inactiveReason}
// // // // // // // // // // //               onChange={(e) => setInactiveReason(e.target.value)}
// // // // // // // // // // //               placeholder="Reason..."
// // // // // // // // // // //             />

// // // // // // // // // // //             <div className="modal-actions">
// // // // // // // // // // //               <button className="btn secondary" onClick={() => setInactiveModal(null)}>Cancel</button>
// // // // // // // // // // //               <button className="btn danger" onClick={confirmInactive}>
// // // // // // // // // // //                 <CheckCircle className="inline mr-1" /> Confirm
// // // // // // // // // // //               </button>
// // // // // // // // // // //             </div>
// // // // // // // // // // //           </div>
// // // // // // // // // // //         </div>
// // // // // // // // // // //       )}
    
// // // // // // // // // // // {/* STUDENT PHOTO */}
// // // // // // // // // // // {viewStudent?.photo_link && (
// // // // // // // // // // //   <div style={{ textAlign: "center" }}>
// // // // // // // // // // //     <div
// // // // // // // // // // //       className="student-photo-circle"
// // // // // // // // // // //       onClick={() =>
// // // // // // // // // // //         setFullPhoto(
// // // // // // // // // // //           `${process.env.REACT_APP_BACKEND_API_URL}/${viewStudent.photo_link}`
// // // // // // // // // // //         )
// // // // // // // // // // //       }
// // // // // // // // // // //     >
// // // // // // // // // // //       <img
// // // // // // // // // // //         src={`${process.env.REACT_APP_BACKEND_API_URL}/${viewStudent.photo_link}`}
// // // // // // // // // // //         alt="Student"
// // // // // // // // // // //       />
// // // // // // // // // // //     </div>

// // // // // // // // // // //     {/* Student Name */}
// // // // // // // // // // //     <div style={{ fontWeight: 600, marginTop: 6 }}>
// // // // // // // // // // //       {viewStudent.student_name}
// // // // // // // // // // //     </div>
// // // // // // // // // // //   </div>
// // // // // // // // // // // )}



// // // // // // // // // // // {/* FULL PHOTO MODAL */}
// // // // // // // // // // // {fullPhoto && (
// // // // // // // // // // //   <div
// // // // // // // // // // //     className="modal"
// // // // // // // // // // //     onClick={() => setFullPhoto(null)}
// // // // // // // // // // //   >
// // // // // // // // // // //     <div
// // // // // // // // // // //       className="modal-content"
// // // // // // // // // // //       style={{ maxWidth: "90vw", textAlign: "center" }}
// // // // // // // // // // //       onClick={(e) => e.stopPropagation()}
// // // // // // // // // // //     >
// // // // // // // // // // //       <button
// // // // // // // // // // //         className="close-btn"
// // // // // // // // // // //         onClick={() => setFullPhoto(null)}
// // // // // // // // // // //       >
// // // // // // // // // // //         <X size={18} />
// // // // // // // // // // //       </button>

// // // // // // // // // // //       <img
// // // // // // // // // // //         src={fullPhoto}
// // // // // // // // // // //         alt="Full Student"
// // // // // // // // // // //         style={{
// // // // // // // // // // //           maxWidth: "100%",
// // // // // // // // // // //           maxHeight: "70vh",
// // // // // // // // // // //           objectFit: "contain",
// // // // // // // // // // //           borderRadius: "8px",
          
// // // // // // // // // // //         }}
// // // // // // // // // // //       />

// // // // // // // // // // //       {/* STUDENT NAME */}
// // // // // // // // // // //       <div style={{ marginTop: 10, fontWeight: "600", fontSize: "16px" }}>
// // // // // // // // // // //         {viewStudent?.student_name}
// // // // // // // // // // //       </div>
// // // // // // // // // // //     </div>
// // // // // // // // // // //   </div>
// // // // // // // // // // // )}


// // // // // // // // // // //     </div>
// // // // // // // // // // //   );
// // // // // // // // // // // }




// // // // // // // // // // 22/12/2025
// // // // // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // // // // import React, { useState, useEffect } from "react";
// // // // // // // // // import axios from "axios";
// // // // // // // // // import "./BatchManagement.css";
// // // // // // // // // import {
// // // // // // // // //   Search,
// // // // // // // // //   Eye,
// // // // // // // // //   Edit,
// // // // // // // // //   X,
// // // // // // // // //   CheckCircle,
// // // // // // // // //   Phone,
// // // // // // // // //   AlertTriangle,
// // // // // // // // //   Filter,
// // // // // // // // //   Download,
// // // // // // // // //   ChevronDown
// // // // // // // // // } from "lucide-react";
// // // // // // // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // // // // // // --- EXPORT LOGIC IMPORTS ---
// // // // // // // // // import { jsPDF } from "jspdf";
// // // // // // // // // import autoTable from "jspdf-autotable";
// // // // // // // // // import * as XLSX from "xlsx";
// // // // // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // // // // export default function StudentManagement() {
// // // // // // // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // // // // // // //   const { user } = useAuth();
// // // // // // // // //   const token = user?.token;

// // // // // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // // // // //   const [batches, setBatches] = useState([]);
// // // // // // // // //   const [institutes, setInstitutes] = useState([]);

// // // // // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // // // // // // //   const [students, setStudents] = useState([]);
// // // // // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // // // // // //   const [loading, setLoading] = useState(false);

// // // // // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // // // // //   const [editForm, setEditForm] = useState({});

// // // // // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // // // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // // // // // // //   const [photoFile, setPhotoFile] = useState(null);

// // // // // // // // //   const [exportOpen, setExportOpen] = useState(false);

// // // // // // // // //   const axiosConfig = () => ({
// // // // // // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // // // // // //   });

// // // // // // // // //   /* ---------------- FETCH DATA ---------------- */
// // // // // // // // //   const fetchStudents = () => {
// // // // // // // // //     if (!token) return;
// // // // // // // // //     setLoading(true);
// // // // // // // // //     const params = {};
// // // // // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // // // // //     axios
// // // // // // // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params })
// // // // // // // // //       .then(({ data }) => setStudents(data || []))
// // // // // // // // //       .catch(() => setStudents([]))
// // // // // // // // //       .finally(() => setLoading(false));
// // // // // // // // //   };

// // // // // // // // //   useEffect(() => { fetchStudents(); }, [token, formData]);

// // // // // // // // //   useEffect(() => {
// // // // // // // // //     if (!token) return;
// // // // // // // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // // // // // // //     axios.get(`${BACKEND}/api/institutes`, axiosConfig()).then(({ data }) => setInstitutes(data || []));
// // // // // // // // //   }, [token]);

// // // // // // // // //   useEffect(() => {
// // // // // // // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // // // // // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // // // // // // //       .then(({ data }) => setBatches(data || []));
// // // // // // // // //   }, [token, formData.cohort]);

// // // // // // // // //   /* ---------------- FILTER ---------------- */
// // // // // // // // //   useEffect(() => {
// // // // // // // // //     let f = [...students];
// // // // // // // // //     if (searchQuery.trim()) {
// // // // // // // // //       const q = searchQuery.toLowerCase();
// // // // // // // // //       f = f.filter((s) => s.student_name?.toLowerCase().includes(q) || String(s.enr_id ?? "").toLowerCase().includes(q));
// // // // // // // // //     }
// // // // // // // // //     if (statusFilter !== "all") {
// // // // // // // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // // // // // // //     }
// // // // // // // // //     setFilteredStudents(f);
// // // // // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // // // // //   /**********************************************/
// // // // // // // // //   /* EXPORT: CSV                                */
// // // // // // // // //   /**********************************************/
// // // // // // // // //   const exportCSV = () => {
// // // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // // //     const rows = filteredStudents.map((s) => ({
// // // // // // // // //       "Enrollment ID": s.enr_id,
// // // // // // // // //       "Student Name": s.student_name,
// // // // // // // // //       Cohort: s.cohort_name,
// // // // // // // // //       Batch: s.batch_name,
// // // // // // // // //       Contact: s.contact_no1,
// // // // // // // // //       Status: s.active_yn,
// // // // // // // // //     }));
// // // // // // // // //     const csv = [
// // // // // // // // //       Object.keys(rows[0]).join(","),
// // // // // // // // //       ...rows.map((r) => Object.values(r).map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")),
// // // // // // // // //     ].join("\n");
// // // // // // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // // // // // //     const url = URL.createObjectURL(blob);
// // // // // // // // //     const a = document.createElement("a");
// // // // // // // // //     a.href = url;
// // // // // // // // //     a.download = "Student_Report.csv";
// // // // // // // // //     a.click();
// // // // // // // // //     setExportOpen(false);
// // // // // // // // //   };

// // // // // // // // //   /**********************************************/
// // // // // // // // //   /* EXPORT: PDF                                */
// // // // // // // // //   /**********************************************/
// // // // // // // // //   const exportPDF = async () => {
// // // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // // //     try {
// // // // // // // // //       const doc = new jsPDF({ unit: "pt", format: "a4" });
// // // // // // // // //       const pageWidth = doc.internal.pageSize.getWidth();

// // // // // // // // //       // FETCH LOGO
// // // // // // // // //       let logoDataUrl = null;
// // // // // // // // //       try {
// // // // // // // // //         const resp = await fetch(Logo);
// // // // // // // // //         const blob = await resp.blob();
// // // // // // // // //         logoDataUrl = await new Promise((res) => {
// // // // // // // // //           const reader = new FileReader();
// // // // // // // // //           reader.onloadend = () => res(reader.result);
// // // // // // // // //           reader.readAsDataURL(blob);
// // // // // // // // //         });
// // // // // // // // //       } catch (e) { console.warn("Logo fail"); }

// // // // // // // // //       // DYNAMIC HEADER LOGIC
// // // // // // // // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // // // // // // // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // // // // // // // //       doc.setFont("helvetica", "bold");
// // // // // // // // //       doc.setFontSize(16);
// // // // // // // // //       const titleLines = ["PRATIBHA POSHAK STUDENT REPORT", `${cohortDisplayName} - ${batchDisplayName}`];
      
// // // // // // // // //       titleLines.forEach((line, i) => {
// // // // // // // // //         doc.text(line, (pageWidth - doc.getTextWidth(line)) / 2, 40 + i * 20);
// // // // // // // // //       });

// // // // // // // // //       if (logoDataUrl) doc.addImage(logoDataUrl, "JPEG", pageWidth - 90, 20, 60, 60);

// // // // // // // // //       const tableData = filteredStudents.map((s) => ({
// // // // // // // // //         enr_id: s.enr_id ?? "-",
// // // // // // // // //         student: s.student_name ?? "-",
// // // // // // // // //         cohort: s.cohort_name ?? "-",
// // // // // // // // //         batch: s.batch_name ?? "-",
// // // // // // // // //         contact: s.contact_no1 ?? "-",
// // // // // // // // //         status: s.active_yn ?? "-",
// // // // // // // // //       }));

// // // // // // // // //       autoTable(doc, {
// // // // // // // // //         startY: 110,
// // // // // // // // //         columns: [
// // // // // // // // //           { header: "Enrollment ID", dataKey: "enr_id" },
// // // // // // // // //           { header: "Student Name", dataKey: "student" },
// // // // // // // // //           { header: "Cohort", dataKey: "cohort" },
// // // // // // // // //           { header: "Batch", dataKey: "batch" },
// // // // // // // // //           { header: "Contact", dataKey: "contact" },
// // // // // // // // //           { header: "Status", dataKey: "status" },
// // // // // // // // //         ],
// // // // // // // // //         body: tableData,
// // // // // // // // //         theme: "grid",
// // // // // // // // //         headStyles: { fillColor: [16, 185, 129], halign: "center" },
// // // // // // // // //         styles: { fontSize: 8, halign: "center" },
// // // // // // // // //         columnStyles: { student: { halign: "left", cellWidth: 120 } }
// // // // // // // // //       });

// // // // // // // // //       doc.save("Student_Report.pdf");
// // // // // // // // //     } catch (err) { alert("PDF Error"); }
// // // // // // // // //     finally { setExportOpen(false); }
// // // // // // // // //   };

// // // // // // // // //   /**********************************************/
// // // // // // // // //   /* EXPORT: EXCEL                              */
// // // // // // // // //   /**********************************************/
// // // // // // // // //   const exportExcel = () => {
// // // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // // //     const data = filteredStudents.map((s) => ({
// // // // // // // // //       "Enrollment ID": s.enr_id ?? "-",
// // // // // // // // //       "Student Name": s.student_name ?? "-",
// // // // // // // // //       Cohort: s.cohort_name ?? "-",
// // // // // // // // //       Batch: s.batch_name ?? "-",
// // // // // // // // //       "Contact No": s.contact_no1 ?? "-",
// // // // // // // // //       Status: s.active_yn ?? "-",
// // // // // // // // //     }));
// // // // // // // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // // // // // // //     worksheet["!cols"] = Object.keys(data[0]).map(() => ({ wch: 20 }));
// // // // // // // // //     const workbook = XLSX.utils.book_new();
// // // // // // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // // // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // // // // // //     setExportOpen(false);
// // // // // // // // //   };

// // // // // // // // //   /* ---------------- ACTIONS ---------------- */
// // // // // // // // //   const openEdit = (s) => {
// // // // // // // // //     setEditStudent(s);
// // // // // // // // //     setEditForm({
// // // // // // // // //       student_name: s.student_name ?? "",
// // // // // // // // //       father_name: s.father_name ?? "",
// // // // // // // // //       father_occupation: s.father_occupation ?? "",
// // // // // // // // //       mother_name: s.mother_name ?? "",
// // // // // // // // //       mother_occupation: s.mother_occupation ?? "",
// // // // // // // // //       student_email: s.student_email ?? "",
// // // // // // // // //       parent_email: s.parent_email ?? "",
// // // // // // // // //       home_address: s.home_address ?? "",
// // // // // // // // //       teacher_name: s.teacher_name ?? "",
// // // // // // // // //       active_yn: s.active_yn ?? "",
// // // // // // // // //       current_institute_dise_code: s.current_institute_dise_code ?? "",
// // // // // // // // //       previous_institute_dise_code: s.previous_institute_dise_code ?? "",
// // // // // // // // //     });
// // // // // // // // //     setPhotoFile(null);
// // // // // // // // //   };

// // // // // // // // //   const handleEditChange = (e) => setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // // // // // //   const saveEdit = async () => {
// // // // // // // // //     try {
// // // // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // // // // // // //       if (photoFile) {
// // // // // // // // //         const fd = new FormData();
// // // // // // // // //         fd.append("photo", photoFile);
// // // // // // // // //         await axios.post(`${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`, fd, {
// // // // // // // // //           headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" },
// // // // // // // // //         });
// // // // // // // // //       }
// // // // // // // // //       window.alert("Student profile updated successfully!");
// // // // // // // // //       setEditStudent(null);
// // // // // // // // //       fetchStudents();
// // // // // // // // //     } catch (err) { window.alert("Failed to update student."); }
// // // // // // // // //   };

// // // // // // // // //   const handleStatusChange = async (student, newStatus) => {
// // // // // // // // //     if (newStatus === "INACTIVE") {
// // // // // // // // //       setInactiveModal(student);
// // // // // // // // //       setInactiveReason(student.inactive_reason || "");
// // // // // // // // //     } else {
// // // // // // // // //       try {
// // // // // // // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // // // // // // //         window.alert("Status set to ACTIVE!");
// // // // // // // // //         fetchStudents();
// // // // // // // // //       } catch (err) { window.alert("Error updating status."); }
// // // // // // // // //     }
// // // // // // // // //   };

// // // // // // // // //   const confirmInactive = async () => {
// // // // // // // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // // // // // // //     try {
// // // // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // // // // // // //       window.alert("Marked as INACTIVE successfully.");
// // // // // // // // //       setInactiveModal(null);
// // // // // // // // //       setInactiveReason("");
// // // // // // // // //       fetchStudents();
// // // // // // // // //     } catch (err) { window.alert("Error updating status."); }
// // // // // // // // //   };

// // // // // // // // //   return (
// // // // // // // // //     <div className="container">
// // // // // // // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // // // // // // //         <div>
// // // // // // // // //           <h1 className="title">Student Management</h1>
// // // // // // // // //           <p className="subtitle">Students assigned to your cohorts/batches</p>
// // // // // // // // //         </div>

// // // // // // // // //         <div className="export-menu-wrapper">
// // // // // // // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // // // // // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // // // // // // //           </button>
// // // // // // // // //           {exportOpen && (
// // // // // // // // //             <div className="export-dropdown">
// // // // // // // // //               <button onClick={exportCSV}>Export to CSV (.csv)</button>
// // // // // // // // //               <button onClick={exportExcel}>Export to Excel (.xlsx)</button>
// // // // // // // // //               <button onClick={exportPDF}>Export to PDF (.pdf)</button>
// // // // // // // // //             </div>
// // // // // // // // //           )}
// // // // // // // // //         </div>
// // // // // // // // //       </div>

// // // // // // // // //       <div className="filter-bar">
// // // // // // // // //         <div className="filter-item">
// // // // // // // // //           <Filter className="input-icon" />
// // // // // // // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // // // // // // //             <option value="">All Cohorts</option>
// // // // // // // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // // // // // // //           </select>
// // // // // // // // //         </div>
// // // // // // // // //         <div className="filter-item">
// // // // // // // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // // // // // // //             <option value="">All Batches</option>
// // // // // // // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // // // // // // //           </select>
// // // // // // // // //         </div>
// // // // // // // // //         <div className="filter-item search-box">
// // // // // // // // //           <Search className="input-icon" />
// // // // // // // // //           <input placeholder="Search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // // // // // // //         </div>
// // // // // // // // //       </div>

// // // // // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // // // // //         <table className="students-table">
// // // // // // // // //           <thead>
// // // // // // // // //             <tr>
// // // // // // // // //               <th style={{ width: "45px" }}>SL</th>
// // // // // // // // //               <th>Student</th>
// // // // // // // // //               <th>Cohort</th>
// // // // // // // // //               <th>Batch</th>
// // // // // // // // //               <th>Status</th>
// // // // // // // // //             </tr>
// // // // // // // // //           </thead>
// // // // // // // // //           <tbody>
// // // // // // // // //             {filteredStudents.map((s, index) => (
// // // // // // // // //               <tr key={s.student_id}>
// // // // // // // // //                 <td>{index + 1}</td>
// // // // // // // // //                 <td>
// // // // // // // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // // // // // // //                     <div onClick={() => setViewStudent(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // // // // // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // // // //                     </div>
// // // // // // // // //                     <div>
// // // // // // // // //                       <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // // // // //                         <button onClick={() => setViewStudent(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // // // // // // //                           {s.student_name}
// // // // // // // // //                         </button>
// // // // // // // // //                         <button onClick={() => openEdit(s)} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // // // // // // //                       </div>
// // // // // // // // //                       <div style={{ fontSize: "11px", color: "#6b7280" }}>{s.enr_id}</div>
// // // // // // // // //                     </div>
// // // // // // // // //                   </div>
// // // // // // // // //                 </td>
// // // // // // // // //                 <td>{s.cohort_name}</td>
// // // // // // // // //                 <td>{s.batch_name}</td>
// // // // // // // // //                 <td>
// // // // // // // // //                   <select value={s.active_yn} onChange={(e) => handleStatusChange(s, e.target.value)} style={{ padding: "4px 8px", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", border: "1px solid #ddd", color: s.active_yn === "ACTIVE" ? "#16a34a" : "#dc2626" }}>
// // // // // // // // //                     <option value="ACTIVE">ACTIVE</option>
// // // // // // // // //                     <option value="INACTIVE">INACTIVE</option>
// // // // // // // // //                   </select>
// // // // // // // // //                 </td>
// // // // // // // // //               </tr>
// // // // // // // // //             ))}
// // // // // // // // //           </tbody>
// // // // // // // // //         </table>
// // // // // // // // //       </div>

// // // // // // // // //       {/* VIEW MODAL */}
// // // // // // // // //       {viewStudent && (
// // // // // // // // //         <div className="modal">
// // // // // // // // //           <div className="modal-content large">
// // // // // // // // //             <button className="close-btn" onClick={() => setViewStudent(null)}><X size={18} /></button>
// // // // // // // // //             <h3 className="modal-title"><Eye className="inline w-5 h-5 mr-1 text-blue-500" /> Student Profile</h3>
            
// // // // // // // // //             <div style={{ textAlign: "center", marginBottom: 16 }}>
// // // // // // // // //               <div style={{ width: 130, height: 130, borderRadius: "50%", overflow: "hidden", margin: "0 auto", cursor: "pointer", border: "3px solid #e5e7eb" }} onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // // // // // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/130"} alt="Student" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // // // //               </div>
// // // // // // // // //               <div style={{ marginTop: 8, fontWeight: 600, fontSize: 15 }}>{viewStudent.student_name}</div>
// // // // // // // // //             </div>

// // // // // // // // //             <div className="profile-section">
// // // // // // // // //               <h4>Basic Details</h4>
// // // // // // // // //               <div className="profile-grid">
// // // // // // // // //                 <div><strong>Name:</strong> {viewStudent.student_name}</div>
// // // // // // // // //                 <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // // // // // //                 <div><strong>Gender:</strong> {viewStudent.gender}</div>
// // // // // // // // //                 <div><strong>Status:</strong> <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`}>{viewStudent.active_yn}</span></div>
// // // // // // // // //               </div>
// // // // // // // // //             </div>

// // // // // // // // //             <div className="profile-section">
// // // // // // // // //               <h4>Parent Details</h4>
// // // // // // // // //               <div className="profile-grid">
// // // // // // // // //                 <div><strong>Father Name:</strong> {viewStudent.father_name}</div>
// // // // // // // // //                 <div><strong>Father Occupation:</strong> {viewStudent.father_occupation}</div>
// // // // // // // // //                 <div><strong>Mother Name:</strong> {viewStudent.mother_name}</div>
// // // // // // // // //                 <div><strong>Mother Occupation:</strong> {viewStudent.mother_occupation}</div>
// // // // // // // // //               </div>
// // // // // // // // //             </div>

// // // // // // // // //             <div className="profile-section">
// // // // // // // // //               <h4>Contact Details</h4>
// // // // // // // // //               <div className="profile-grid">
// // // // // // // // //                 <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // // // // // //                 <div><strong>Email Password:</strong> {viewStudent.student_email_password}</div>
// // // // // // // // //                 <div><strong>Parent Email:</strong> {viewStudent.parent_email}</div>
// // // // // // // // //                 <div><strong>Contact No (Student):</strong> {viewStudent.contact_no1}</div>
// // // // // // // // //                 <div><strong>Contact No (Parent):</strong> {viewStudent.contact_no2}</div>
// // // // // // // // //                 <div><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // // // // // // //               </div>
// // // // // // // // //             </div>

// // // // // // // // //             <div className="profile-section">
// // // // // // // // //               <h4>Institute Details</h4>
// // // // // // // // //               <div className="profile-grid">
// // // // // // // // //                 <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // // // // // //                 <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // // // // // //               </div>
// // // // // // // // //             </div>

// // // // // // // // //             <div className="profile-section">
// // // // // // // // //               <h4>Academic & Other Details</h4>
// // // // // // // // //               <div className="profile-grid">
// // // // // // // // //                 <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // // // // // //                 <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number}</div>
// // // // // // // // //                 <div><strong>Recharge Status:</strong> {viewStudent.recharge_status}</div>
// // // // // // // // //                 <div><strong>Sponsor:</strong> {viewStudent.sponsor}</div>
// // // // // // // // //               </div>
// // // // // // // // //             </div>

// // // // // // // // //             {viewStudent.active_yn === "INACTIVE" && (
// // // // // // // // //               <div className="profile-section">
// // // // // // // // //                 <h4>Inactive Information</h4>
// // // // // // // // //                 <div className="profile-grid">
// // // // // // // // //                   <div><strong>Inactive Reason:</strong> {viewStudent.inactive_reason}</div>
// // // // // // // // //                 </div>
// // // // // // // // //               </div>
// // // // // // // // //             )}
// // // // // // // // //           </div>
// // // // // // // // //         </div>
// // // // // // // // //       )}

// // // // // // // // //       {/* EDIT MODAL */}
// // // // // // // // //       {editStudent && (
// // // // // // // // //         <div className="modal">
// // // // // // // // //           <div className="modal-content large">
// // // // // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // // // // // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student</h3>
// // // // // // // // //             <div className="edit-form grid-2-col">
// // // // // // // // //               {Object.keys(editForm).map((k) => (
// // // // // // // // //                 <div className="form-group" key={k}>
// // // // // // // // //                   <label>{k.replace(/_/g, " ")}</label>
// // // // // // // // //                   {k.includes("institute") ? (
// // // // // // // // //                     <select name={k} value={editForm[k]} onChange={handleEditChange}>
// // // // // // // // //                       <option value="">-- select --</option>
// // // // // // // // //                       {institutes.map((i) => <option key={i.dise_code} value={i.dise_code}>{i.dise_code} - {i.institute_name}</option>)}
// // // // // // // // //                     </select>
// // // // // // // // //                   ) : (
// // // // // // // // //                     <input name={k} value={editForm[k]} onChange={handleEditChange} />
// // // // // // // // //                   )}
// // // // // // // // //                 </div>
// // // // // // // // //               ))}
// // // // // // // // //               <div className="form-group">
// // // // // // // // //                 <label>Student Photo</label>
// // // // // // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} />
// // // // // // // // //               </div>
// // // // // // // // //             </div>
// // // // // // // // //             <div className="modal-actions">
// // // // // // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Cancel</button>
// // // // // // // // //               <button className="btn primary" onClick={saveEdit}><CheckCircle className="inline mr-1" /> Save Changes</button>
// // // // // // // // //             </div>
// // // // // // // // //           </div>
// // // // // // // // //         </div>
// // // // // // // // //       )}

// // // // // // // // //       {/* INACTIVE MODAL */}
// // // // // // // // //       {inactiveModal && (
// // // // // // // // //         <div className="modal">
// // // // // // // // //           <div className="modal-content small">
// // // // // // // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Mark Inactive</h3>
// // // // // // // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Reason..." className="w-full border p-2 rounded" />
// // // // // // // // //             <div className="modal-actions">
// // // // // // // // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // // // // // // // //               <button className="btn danger" onClick={confirmInactive}>Confirm</button>
// // // // // // // // //             </div>
// // // // // // // // //           </div>
// // // // // // // // //         </div>
// // // // // // // // //       )}

// // // // // // // // //       {/* FULL PHOTO VIEW */}
// // // // // // // // //       {fullPhoto && (
// // // // // // // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // // // // // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center" }} onClick={e => e.stopPropagation()}>
// // // // // // // // //             <img src={fullPhoto} alt="Full" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // // // // // // //           </div>
// // // // // // // // //         </div>
// // // // // // // // //       )}

// // // // // // // // //       <style>{`
// // // // // // // // //         .export-menu-wrapper { position: relative; }
// // // // // // // // //         .export-dropdown {
// // // // // // // // //           position: absolute;
// // // // // // // // //           top: 110%;
// // // // // // // // //           right: 0;
// // // // // // // // //           background: white;
// // // // // // // // //           border: 1px solid #ddd;
// // // // // // // // //           box-shadow: 0 2px 8px rgba(0,0,0,0.15);
// // // // // // // // //           border-radius: 6px;
// // // // // // // // //           padding: 6px 0;
// // // // // // // // //           z-index: 999;
// // // // // // // // //           min-width: 180px;
// // // // // // // // //         }
// // // // // // // // //         .export-dropdown button {
// // // // // // // // //           width: 100%;
// // // // // // // // //           text-align: left;
// // // // // // // // //           padding: 8px 14px;
// // // // // // // // //           background: white;
// // // // // // // // //           border: none;
// // // // // // // // //           cursor: pointer;
// // // // // // // // //           font-size: 14px;
// // // // // // // // //         }
// // // // // // // // //         .export-dropdown button:hover { background: #f5f5f5; }
// // // // // // // // //       `}</style>
// // // // // // // // //     </div>
// // // // // // // // //   );
// // // // // // // // // }

// // // // // // // // // 22/12/2025
// // // // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // // // import React, { useState, useEffect } from "react";
// // // // // // // // import axios from "axios";
// // // // // // // // import "./BatchManagement.css";
// // // // // // // // import {
// // // // // // // //   Search,
// // // // // // // //   Eye,
// // // // // // // //   Edit,
// // // // // // // //   X,
// // // // // // // //   CheckCircle,
// // // // // // // //   Phone,
// // // // // // // //   AlertTriangle,
// // // // // // // //   Filter,
// // // // // // // //   Download,
// // // // // // // //   ChevronDown
// // // // // // // // } from "lucide-react";
// // // // // // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // // // // // --- EXPORT LOGIC IMPORTS ---
// // // // // // // // import { jsPDF } from "jspdf";
// // // // // // // // import autoTable from "jspdf-autotable";
// // // // // // // // import * as XLSX from "xlsx";
// // // // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // // // export default function StudentManagement() {
// // // // // // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // // // // // //   const { user } = useAuth();
// // // // // // // //   const token = user?.token;

// // // // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // // // //   const [batches, setBatches] = useState([]);
// // // // // // // //   const [institutes, setInstitutes] = useState([]);

// // // // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // // // // // //   const [students, setStudents] = useState([]);
// // // // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // // // // //   const [loading, setLoading] = useState(false);

// // // // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // // // //   const [editForm, setEditForm] = useState({});

// // // // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // // // // // //   const [photoFile, setPhotoFile] = useState(null);

// // // // // // // //   const [exportOpen, setExportOpen] = useState(false);

// // // // // // // //   const axiosConfig = () => ({
// // // // // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // // // // //   });

// // // // // // // //   /* ---------------- FETCH DATA ---------------- */
// // // // // // // //   const fetchStudents = () => {
// // // // // // // //     if (!token) return;
// // // // // // // //     setLoading(true);
// // // // // // // //     const params = {};
// // // // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // // // //     axios
// // // // // // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params })
// // // // // // // //       .then(({ data }) => setStudents(data || []))
// // // // // // // //       .catch(() => setStudents([]))
// // // // // // // //       .finally(() => setLoading(false));
// // // // // // // //   };

// // // // // // // //   useEffect(() => { fetchStudents(); }, [token, formData]);

// // // // // // // //   useEffect(() => {
// // // // // // // //     if (!token) return;
// // // // // // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // // // // // //     axios.get(`${BACKEND}/api/institutes`, axiosConfig()).then(({ data }) => setInstitutes(data || []));
// // // // // // // //   }, [token]);

// // // // // // // //   useEffect(() => {
// // // // // // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // // // // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // // // // // //       .then(({ data }) => setBatches(data || []));
// // // // // // // //   }, [token, formData.cohort]);

// // // // // // // //   /* ---------------- FILTER ---------------- */
// // // // // // // //   useEffect(() => {
// // // // // // // //     let f = [...students];
// // // // // // // //     if (searchQuery.trim()) {
// // // // // // // //       const q = searchQuery.toLowerCase();
// // // // // // // //       f = f.filter((s) => 
// // // // // // // //         s.student_name?.toLowerCase().includes(q) || 
// // // // // // // //         String(s.enr_id ?? "").toLowerCase().includes(q)
// // // // // // // //       );
// // // // // // // //     }
// // // // // // // //     if (statusFilter !== "all") {
// // // // // // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // // // // // //     }
// // // // // // // //     setFilteredStudents(f);
// // // // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // // // //   /**********************************************/
// // // // // // // //   /* EXPORT LOGIC                             */
// // // // // // // //   /**********************************************/
// // // // // // // //   const exportCSV = () => {
// // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // //     const rows = filteredStudents.map((s, index) => ({
// // // // // // // //       "SL NO": index + 1,
// // // // // // // //       "Student Name": s.student_name,
// // // // // // // //       "Enrollment Number": s.enr_id,
// // // // // // // //       Cohort: s.cohort_name,
// // // // // // // //       Batch: s.batch_name,
// // // // // // // //       Status: s.active_yn,
// // // // // // // //     }));
// // // // // // // //     const csv = [
// // // // // // // //       Object.keys(rows[0]).join(","),
// // // // // // // //       ...rows.map((r) => Object.values(r).map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")),
// // // // // // // //     ].join("\n");
// // // // // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // // // // //     const url = URL.createObjectURL(blob);
// // // // // // // //     const a = document.createElement("a");
// // // // // // // //     a.href = url;
// // // // // // // //     a.download = "Student_Report.csv";
// // // // // // // //     a.click();
// // // // // // // //     setExportOpen(false);
// // // // // // // //   };

// // // // // // // //   const exportPDF = async () => {
// // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // //     try {
// // // // // // // //       const doc = new jsPDF({ unit: "pt", format: "a4" });
// // // // // // // //       const pageWidth = doc.internal.pageSize.getWidth();
// // // // // // // //       let logoDataUrl = null;
// // // // // // // //       try {
// // // // // // // //         const resp = await fetch(Logo);
// // // // // // // //         const blob = await resp.blob();
// // // // // // // //         logoDataUrl = await new Promise((res) => {
// // // // // // // //           const reader = new FileReader();
// // // // // // // //           reader.onloadend = () => res(reader.result);
// // // // // // // //           reader.readAsDataURL(blob);
// // // // // // // //         });
// // // // // // // //       } catch (e) { console.warn("Logo fail"); }

// // // // // // // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // // // // // // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // // // // // // //       doc.setFont("helvetica", "bold");
// // // // // // // //       doc.setFontSize(16);
// // // // // // // //       const titleLines = ["PRATIBHA POSHAK", `${cohortDisplayName} - ${batchDisplayName}`, "STUDENT REPORT"];
// // // // // // // //       titleLines.forEach((line, i) => { doc.text(line, (pageWidth - doc.getTextWidth(line)) / 2, 40 + i * 20); });
// // // // // // // //       if (logoDataUrl) doc.addImage(logoDataUrl, "JPEG", pageWidth - 90, 20, 60, 60);

// // // // // // // //       const tableData = filteredStudents.map((s, index) => ({
// // // // // // // //         sl: index + 1,
// // // // // // // //         student: s.student_name ?? "-",
// // // // // // // //         enr_id: s.enr_id ?? "-",
// // // // // // // //         cohort: s.cohort_name ?? "-",
// // // // // // // //         batch: s.batch_name ?? "-",
// // // // // // // //         status: s.active_yn ?? "-",
// // // // // // // //       }));

// // // // // // // //       autoTable(doc, {
// // // // // // // //         startY: 110,
// // // // // // // //         columns: [
// // // // // // // //           { header: "SL NO", dataKey: "sl" },
// // // // // // // //           { header: "Student Name", dataKey: "student" },
// // // // // // // //           { header: "Enrollment Number", dataKey: "enr_id" },
// // // // // // // //           { header: "Cohort", dataKey: "cohort" },
// // // // // // // //           { header: "Batch", dataKey: "batch" },
// // // // // // // //           { header: "Status", dataKey: "status" },
// // // // // // // //         ],
// // // // // // // //         body: tableData,
// // // // // // // //         theme: "grid",
// // // // // // // //         headStyles: { fillColor: [16, 185, 129], halign: "center" },
// // // // // // // //         styles: { fontSize: 8, halign: "center" },
// // // // // // // //       });
// // // // // // // //       doc.save("Student_Report.pdf");
// // // // // // // //     } catch (err) { alert("PDF Error"); }
// // // // // // // //     finally { setExportOpen(false); }
// // // // // // // //   };

// // // // // // // //   const exportExcel = () => {
// // // // // // // //     if (!filteredStudents.length) return alert("No rows to export.");
// // // // // // // //     const data = filteredStudents.map((s, index) => ({
// // // // // // // //       "SL NO": index + 1,
// // // // // // // //       "Student Name": s.student_name ?? "-",
// // // // // // // //       "Enrollment Number": s.enr_id ?? "-",
// // // // // // // //       Cohort: s.cohort_name ?? "-",
// // // // // // // //       Batch: s.batch_name ?? "-",
// // // // // // // //       Status: s.active_yn ?? "-",
// // // // // // // //     }));
// // // // // // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // // // // // //     worksheet["!cols"] = Object.keys(data[0]).map(() => ({ wch: 20 }));
// // // // // // // //     const workbook = XLSX.utils.book_new();
// // // // // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // // // // //     setExportOpen(false);
// // // // // // // //   };

// // // // // // // //   /* ---------------- ACTIONS ---------------- */
// // // // // // // //   const openEdit = (s) => {
// // // // // // // //     setEditStudent(s);
// // // // // // // //     setEditForm({
// // // // // // // //       student_name: s.student_name ?? "",
// // // // // // // //       father_name: s.father_name ?? "",
// // // // // // // //       father_occupation: s.father_occupation ?? "",
// // // // // // // //       mother_name: s.mother_name ?? "",
// // // // // // // //       mother_occupation: s.mother_occupation ?? "",
// // // // // // // //       student_email: s.student_email ?? "",
// // // // // // // //       parent_email: s.parent_email ?? "",
// // // // // // // //       home_address: s.home_address ?? "",
// // // // // // // //       teacher_name: s.teacher_name ?? "",
// // // // // // // //       active_yn: s.active_yn ?? "",
// // // // // // // //       current_institute_dise_code: s.current_institute_dise_code ?? "",
// // // // // // // //       previous_institute_dise_code: s.previous_institute_dise_code ?? "",
// // // // // // // //     });
// // // // // // // //     setPhotoFile(null);
// // // // // // // //   };

// // // // // // // //   const handleEditChange = (e) => setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // // // // //   const saveEdit = async () => {
// // // // // // // //     try {
// // // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // // // // // //       if (photoFile) {
// // // // // // // //         const fd = new FormData();
// // // // // // // //         fd.append("photo", photoFile);
// // // // // // // //         await axios.post(`${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`, fd, {
// // // // // // // //           headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" },
// // // // // // // //         });
// // // // // // // //       }
// // // // // // // //       window.alert("Student profile updated successfully!");
// // // // // // // //       setEditStudent(null);
// // // // // // // //       fetchStudents();
// // // // // // // //     } catch (err) { window.alert("Failed to update student."); }
// // // // // // // //   };

// // // // // // // //   const handleStatusChange = async (student, newStatus) => {
// // // // // // // //     if (newStatus === "INACTIVE") {
// // // // // // // //       setInactiveModal(student);
// // // // // // // //       setInactiveReason(student.inactive_reason || "");
// // // // // // // //     } else {
// // // // // // // //       try {
// // // // // // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // // // // // //         window.alert("Status set to ACTIVE!");
// // // // // // // //         fetchStudents();
// // // // // // // //       } catch (err) { window.alert("Error updating status."); }
// // // // // // // //     }
// // // // // // // //   };

// // // // // // // //   const confirmInactive = async () => {
// // // // // // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // // // // // //     try {
// // // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // // // // // //       window.alert("Marked as INACTIVE successfully.");
// // // // // // // //       setInactiveModal(null);
// // // // // // // //       setInactiveReason("");
// // // // // // // //       fetchStudents();
// // // // // // // //     } catch (err) { window.alert("Error updating status."); }
// // // // // // // //   };

// // // // // // // //   return (
// // // // // // // //     <div className="container">
// // // // // // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // // // // // //         <div>
// // // // // // // //           <h1 className="title">Student Management</h1>
// // // // // // // //           <p className="subtitle">Students assigned to your cohorts/batches</p>
// // // // // // // //         </div>

// // // // // // // //         <div className="export-menu-wrapper">
// // // // // // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // // // // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // // // // // //           </button>
// // // // // // // //           {exportOpen && (
// // // // // // // //             <div className="export-dropdown">
// // // // // // // //               <button onClick={exportCSV}>Export to CSV (.csv)</button>
// // // // // // // //               <button onClick={exportExcel}>Export to Excel (.xlsx)</button>
// // // // // // // //               <button onClick={exportPDF}>Export to PDF (.pdf)</button>
// // // // // // // //             </div>
// // // // // // // //           )}
// // // // // // // //         </div>
// // // // // // // //       </div>

// // // // // // // //       <div className="filter-bar">
// // // // // // // //         <div className="filter-item">
// // // // // // // //           <Filter className="input-icon" />
// // // // // // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // // // // // //             <option value="">All Cohorts</option>
// // // // // // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // // // // // //           </select>
// // // // // // // //         </div>
// // // // // // // //         <div className="filter-item">
// // // // // // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // // // // // //             <option value="">All Batches</option>
// // // // // // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // // // // // //           </select>
// // // // // // // //         </div>
// // // // // // // //         <div className="filter-item search-box">
// // // // // // // //           <Search className="input-icon" />
// // // // // // // //           <input placeholder="Search ID or Name..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // // // // // //         </div>
// // // // // // // //       </div>

// // // // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // // // //         <table className="students-table">
// // // // // // // //           <thead>
// // // // // // // //             <tr>
// // // // // // // //               <th style={{ width: "45px" }}>SL NO</th>
// // // // // // // //               <th>Student Name</th>
// // // // // // // //               <th>Enrollment Number</th>
// // // // // // // //               <th>Cohort</th>
// // // // // // // //               <th>Batch</th>
// // // // // // // //               <th>Status</th>
// // // // // // // //             </tr>
// // // // // // // //           </thead>
// // // // // // // //           <tbody>
// // // // // // // //             {filteredStudents.map((s, index) => (
// // // // // // // //               <tr key={s.student_id}>
// // // // // // // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // // // // // // //                 <td>
// // // // // // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // // // // // //                     <div onClick={() => setViewStudent(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // // // // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // // //                     </div>
// // // // // // // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // // // //                       <button onClick={() => setViewStudent(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // // // // // //                         {s.student_name}
// // // // // // // //                       </button>
// // // // // // // //                       <button onClick={() => openEdit(s)} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // // // // // //                     </div>
// // // // // // // //                   </div>
// // // // // // // //                 </td>
// // // // // // // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // // // // // // //                 <td>{s.cohort_name}</td>
// // // // // // // //                 <td>{s.batch_name}</td>
// // // // // // // //                 <td>
// // // // // // // //                   <select value={s.active_yn} onChange={(e) => handleStatusChange(s, e.target.value)} style={{ padding: "4px 8px", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", border: "1px solid #ddd", color: s.active_yn === "ACTIVE" ? "#16a34a" : "#dc2626" }}>
// // // // // // // //                     <option value="ACTIVE">ACTIVE</option>
// // // // // // // //                     <option value="INACTIVE">INACTIVE</option>
// // // // // // // //                   </select>
// // // // // // // //                 </td>
// // // // // // // //               </tr>
// // // // // // // //             ))}
// // // // // // // //           </tbody>
// // // // // // // //         </table>
// // // // // // // //       </div>

// // // // // // // //       {/* VIEW MODAL */}
// // // // // // // //       {viewStudent && (
// // // // // // // //         <div className="modal">
// // // // // // // //           <div className="modal-content large">
// // // // // // // //             <button className="close-btn" onClick={() => setViewStudent(null)}><X size={18} /></button>
// // // // // // // //             <h3 className="modal-title"><Eye className="inline w-5 h-5 mr-1 text-blue-500" /> Student Profile</h3>
            
// // // // // // // //             <div style={{ textAlign: "center", marginBottom: 16 }}>
// // // // // // // //               <div style={{ width: 130, height: 130, borderRadius: "50%", overflow: "hidden", margin: "0 auto", cursor: "pointer", border: "3px solid #e5e7eb" }} onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // // // // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/130"} alt="Student" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // // //               </div>
// // // // // // // //               <div style={{ marginTop: 8, fontWeight: 600, fontSize: 15 }}>{viewStudent.student_name}</div>
// // // // // // // //             </div>

// // // // // // // //             <div className="profile-section">
// // // // // // // //               <h4>Basic Details</h4>
// // // // // // // //               <div className="profile-grid">
// // // // // // // //                 <div><strong>Name:</strong> {viewStudent.student_name}</div>
// // // // // // // //                 <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // // // // //                 <div><strong>Gender:</strong> {viewStudent.gender}</div>
// // // // // // // //                 <div><strong>Status:</strong> <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`}>{viewStudent.active_yn}</span></div>
// // // // // // // //               </div>
// // // // // // // //             </div>

// // // // // // // //             <div className="profile-section">
// // // // // // // //               <h4>Parent Details</h4>
// // // // // // // //               <div className="profile-grid">
// // // // // // // //                 <div><strong>Father Name:</strong> {viewStudent.father_name}</div>
// // // // // // // //                 <div><strong>Father Occupation:</strong> {viewStudent.father_occupation}</div>
// // // // // // // //                 <div><strong>Mother Name:</strong> {viewStudent.mother_name}</div>
// // // // // // // //                 <div><strong>Mother Occupation:</strong> {viewStudent.mother_occupation}</div>
// // // // // // // //               </div>
// // // // // // // //             </div>

// // // // // // // //             <div className="profile-section">
// // // // // // // //               <h4>Contact Details</h4>
// // // // // // // //               <div className="profile-grid">
// // // // // // // //                 <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // // // // //                 <div><strong>Email Password:</strong> {viewStudent.student_email_password}</div>
// // // // // // // //                 <div><strong>Parent Email:</strong> {viewStudent.parent_email}</div>
// // // // // // // //                 <div><strong>Contact No (Student):</strong> {viewStudent.contact_no1}</div>
// // // // // // // //                 <div><strong>Contact No (Parent):</strong> {viewStudent.contact_no2}</div>
// // // // // // // //                 <div><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // // // // // //               </div>
// // // // // // // //             </div>

// // // // // // // //             <div className="profile-section">
// // // // // // // //               <h4>Institute Details</h4>
// // // // // // // //               <div className="profile-grid">
// // // // // // // //                 <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // // // // //                 <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // // // // //               </div>
// // // // // // // //             </div>

// // // // // // // //             <div className="profile-section">
// // // // // // // //               <h4>Academic & Other Details</h4>
// // // // // // // //               <div className="profile-grid">
// // // // // // // //                 <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // // // // //                 <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number}</div>
// // // // // // // //                 <div><strong>Recharge Status:</strong> {viewStudent.recharge_status}</div>
// // // // // // // //                 <div><strong>Sponsor:</strong> {viewStudent.sponsor}</div>
// // // // // // // //               </div>
// // // // // // // //             </div>

// // // // // // // //             {viewStudent.active_yn === "INACTIVE" && (
// // // // // // // //               <div className="profile-section">
// // // // // // // //                 <h4>Inactive Information</h4>
// // // // // // // //                 <div className="profile-grid">
// // // // // // // //                   <div><strong>Inactive Reason:</strong> {viewStudent.inactive_reason}</div>
// // // // // // // //                 </div>
// // // // // // // //               </div>
// // // // // // // //             )}
// // // // // // // //           </div>
// // // // // // // //         </div>
// // // // // // // //       )}

// // // // // // // //       {/* EDIT MODAL */}
// // // // // // // //       {editStudent && (
// // // // // // // //         <div className="modal">
// // // // // // // //           <div className="modal-content large">
// // // // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // // // // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student</h3>
// // // // // // // //             <div className="edit-form grid-2-col">
// // // // // // // //               {Object.keys(editForm).map((k) => (
// // // // // // // //                 <div className="form-group" key={k}>
// // // // // // // //                   <label>{k.replace(/_/g, " ")}</label>
// // // // // // // //                   {k.includes("institute") ? (
// // // // // // // //                     <select name={k} value={editForm[k]} onChange={handleEditChange}>
// // // // // // // //                       <option value="">-- select --</option>
// // // // // // // //                       {institutes.map((i) => <option key={i.dise_code} value={i.dise_code}>{i.dise_code} - {i.institute_name}</option>)}
// // // // // // // //                     </select>
// // // // // // // //                   ) : (
// // // // // // // //                     <input name={k} value={editForm[k]} onChange={handleEditChange} />
// // // // // // // //                   )}
// // // // // // // //                 </div>
// // // // // // // //               ))}
// // // // // // // //               <div className="form-group">
// // // // // // // //                 <label>Student Photo</label>
// // // // // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} />
// // // // // // // //               </div>
// // // // // // // //             </div>
// // // // // // // //             <div className="modal-actions">
// // // // // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Cancel</button>
// // // // // // // //               <button className="btn primary" onClick={saveEdit}><CheckCircle className="inline mr-1" /> Save Changes</button>
// // // // // // // //             </div>
// // // // // // // //           </div>
// // // // // // // //         </div>
// // // // // // // //       )}

// // // // // // // //       {/* INACTIVE MODAL */}
// // // // // // // //       {inactiveModal && (
// // // // // // // //         <div className="modal">
// // // // // // // //           <div className="modal-content small">
// // // // // // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Mark Inactive</h3>
// // // // // // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Reason..." className="w-full border p-2 rounded" />
// // // // // // // //             <div className="modal-actions">
// // // // // // // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // // // // // // //               <button className="btn danger" onClick={confirmInactive}>Confirm</button>
// // // // // // // //             </div>
// // // // // // // //           </div>
// // // // // // // //         </div>
// // // // // // // //       )}

// // // // // // // //       {/* FULL PHOTO VIEW */}
// // // // // // // //       {fullPhoto && (
// // // // // // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // // // // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center" }} onClick={e => e.stopPropagation()}>
// // // // // // // //             <img src={fullPhoto} alt="Full" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // // // // // //           </div>
// // // // // // // //         </div>
// // // // // // // //       )}

// // // // // // // //       <style>{`
// // // // // // // //         .export-menu-wrapper { position: relative; }
// // // // // // // //         .export-dropdown {
// // // // // // // //           position: absolute;
// // // // // // // //           top: 110%;
// // // // // // // //           right: 0;
// // // // // // // //           background: white;
// // // // // // // //           border: 1px solid #ddd;
// // // // // // // //           box-shadow: 0 2px 8px rgba(0,0,0,0.15);
// // // // // // // //           border-radius: 6px;
// // // // // // // //           padding: 6px 0;
// // // // // // // //           z-index: 999;
// // // // // // // //           min-width: 180px;
// // // // // // // //         }
// // // // // // // //         .export-dropdown button {
// // // // // // // //           width: 100%;
// // // // // // // //           text-align: left;
// // // // // // // //           padding: 8px 14px;
// // // // // // // //           background: white;
// // // // // // // //           border: none;
// // // // // // // //           cursor: pointer;
// // // // // // // //           font-size: 14px;
// // // // // // // //         }
// // // // // // // //         .export-dropdown button:hover { background: #f5f5f5; }
// // // // // // // //       `}</style>
// // // // // // // //     </div>
// // // // // // // //   );
// // // // // // // // }


// // // // // // // // / 22/12/2025
// // // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // // import React, { useState, useEffect, useCallback } from "react";
// // // // // // // import axios from "axios";
// // // // // // // import "./BatchManagement.css";
// // // // // // // import {
// // // // // // //   Search,
// // // // // // //   Eye,
// // // // // // //   Edit,
// // // // // // //   X,
// // // // // // //   CheckCircle,
// // // // // // //   AlertTriangle,
// // // // // // //   Filter,
// // // // // // //   Download,
// // // // // // //   ChevronDown,
// // // // // // //   Phone,
// // // // // // //   User,
// // // // // // //   Mail,
// // // // // // //   MapPin,
// // // // // // //   BookOpen,
// // // // // // //   Settings,
// // // // // // //   ListChecks,
// // // // // // //   Lock,
// // // // // // //   Smartphone
// // // // // // // } from "lucide-react";
// // // // // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // // // // --- EXPORT LOGIC IMPORTS ---
// // // // // // // import { jsPDF } from "jspdf";
// // // // // // // import autoTable from "jspdf-autotable";
// // // // // // // import * as XLSX from "xlsx";
// // // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // // // All available fields for Custom Export
// // // // // // // const STUDENT_MASTER_FIELDS = [
// // // // // // //   { id: "sl_no", label: "SL NO" },
// // // // // // //   { id: "student_name", label: "Student Name" },
// // // // // // //   { id: "enr_id", label: "Enrollment ID" },
// // // // // // //   { id: "sim_name", label: "SIM Name" },
// // // // // // //   { id: "contact_no1", label: "Student Contact" },
// // // // // // //   { id: "contact_no2", label: "Parent Contact" },
// // // // // // //   { id: "student_email", label: "Student Email" },
// // // // // // //   { id: "student_email_password", label: "Email Password" },
// // // // // // //   { id: "parent_email", label: "Parent Email" },
// // // // // // //   { id: "gender", label: "Gender" },
// // // // // // //   { id: "father_name", label: "Father Name" },
// // // // // // //   { id: "father_occupation", label: "Father Occupation" },
// // // // // // //   { id: "mother_name", label: "Mother Name" },
// // // // // // //   { id: "mother_occupation", label: "Mother Occupation" },
// // // // // // //   { id: "home_address", label: "Home Address" },
// // // // // // //   { id: "current_institute", label: "Current Institute" },
// // // // // // //   { id: "previous_institute", label: "Previous Institute" },
// // // // // // //   { id: "teacher_name", label: "Teacher Name" },
// // // // // // //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// // // // // // //   { id: "recharge_status", label: "Recharge Status" },
// // // // // // //   { id: "sponsor", label: "Sponsor" },
// // // // // // //   { id: "active_yn", label: "Status" },
// // // // // // //   { id: "inactive_reason", label: "Inactive Reason" },
// // // // // // //   { id: "cohort_name", label: "Cohort" },
// // // // // // //   { id: "batch_name", label: "Batch" },
// // // // // // // ];

// // // // // // // export default function StudentManagement() {
// // // // // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // // // // //   const { user } = useAuth();
// // // // // // //   const token = user?.token;

// // // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // // //   const [batches, setBatches] = useState([]);
// // // // // // //   const [institutes, setInstitutes] = useState([]);

// // // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // // // // //   const [students, setStudents] = useState([]);
// // // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // // // //   const [loading, setLoading] = useState(false);

// // // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // // //   const [editForm, setEditForm] = useState({});

// // // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // // // // //   const [photoFile, setPhotoFile] = useState(null);

// // // // // // //   // Export States
// // // // // // //   const [exportOpen, setExportOpen] = useState(false);
// // // // // // //   const [customExportModal, setCustomExportModal] = useState(false);
// // // // // // //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "active_yn"]);

// // // // // // //   const axiosConfig = useCallback(() => ({
// // // // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // // // //   }), [token]);

// // // // // // //   /* ---------------- FETCH DATA (WITH DUPLICATE FIX) ---------------- */
// // // // // // //   const fetchStudents = useCallback(() => {
// // // // // // //     if (!token) return;
// // // // // // //     setLoading(true);
// // // // // // //     const params = {};
// // // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // // //     axios
// // // // // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params })
// // // // // // //       .then(({ data }) => {
// // // // // // //         // ENSURE UNIQUE RECORDS BY STUDENT ID
// // // // // // //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// // // // // // //         setStudents(uniqueData || []);
// // // // // // //       })
// // // // // // //       .catch(() => setStudents([]))
// // // // // // //       .finally(() => setLoading(false));
// // // // // // //   }, [token, formData, axiosConfig]);

// // // // // // //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// // // // // // //   useEffect(() => {
// // // // // // //     if (!token) return;
// // // // // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // // // // //     axios.get(`${BACKEND}/api/institutes`, axiosConfig()).then(({ data }) => setInstitutes(data || []));
// // // // // // //   }, [token, axiosConfig]);

// // // // // // //   useEffect(() => {
// // // // // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // // // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // // // // //       .then(({ data }) => setBatches(data || []));
// // // // // // //   }, [token, formData.cohort, axiosConfig]);

// // // // // // //   /* ---------------- FILTER ---------------- */
// // // // // // //   useEffect(() => {
// // // // // // //     let f = [...students];
// // // // // // //     if (searchQuery.trim()) {
// // // // // // //       const q = searchQuery.toLowerCase();
// // // // // // //       f = f.filter((s) => 
// // // // // // //         s.student_name?.toLowerCase().includes(q) || 
// // // // // // //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// // // // // // //         s.sim_name?.toLowerCase().includes(q) || 
// // // // // // //         s.contact_no1?.includes(q)
// // // // // // //       );
// // // // // // //     }
// // // // // // //     if (statusFilter !== "all") {
// // // // // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // // // // //     }
// // // // // // //     setFilteredStudents(f);
// // // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // // //   /* ---------------- EXPORT LOGIC ---------------- */
// // // // // // //   const toggleField = (id) => {
// // // // // // //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// // // // // // //   };

// // // // // // //   const getExportData = () => {
// // // // // // //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// // // // // // //     const rows = filteredStudents.map((s, index) => {
// // // // // // //       let row = {};
// // // // // // //       activeFields.forEach(field => {
// // // // // // //         if (field.id === "sl_no") row[field.label] = index + 1;
// // // // // // //         else row[field.label] = s[field.id] ?? "-";
// // // // // // //       });
// // // // // // //       return row;
// // // // // // //     });
// // // // // // //     return { data: rows, headers: activeFields.map(f => f.label) };
// // // // // // //   };

// // // // // // //   const exportCSV = () => {
// // // // // // //     const { data } = getExportData();
// // // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // // //     const csv = [
// // // // // // //       Object.keys(data[0]).join(","),
// // // // // // //       ...data.map((r) => Object.values(r).map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")),
// // // // // // //     ].join("\n");
// // // // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // // // //     const url = URL.createObjectURL(blob);
// // // // // // //     const a = document.createElement("a");
// // // // // // //     a.href = url;
// // // // // // //     a.download = "Student_Report.csv";
// // // // // // //     a.click();
// // // // // // //     setExportOpen(false);
// // // // // // //     setCustomExportModal(false);
// // // // // // //   };

// // // // // // //   const exportPDF = async () => {
// // // // // // //     const { data, headers } = getExportData();
// // // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // // //     try {
// // // // // // //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// // // // // // //       const pageWidth = doc.internal.pageSize.getWidth();
// // // // // // //       autoTable(doc, {
// // // // // // //         startY: 70,
// // // // // // //         head: [headers],
// // // // // // //         body: data.map(r => Object.values(r)),
// // // // // // //         theme: "grid",
// // // // // // //         headStyles: { fillColor: [16, 185, 129], fontSize: 7 },
// // // // // // //         styles: { fontSize: 7 },
// // // // // // //       });
// // // // // // //       doc.save("Student_Report.pdf");
// // // // // // //     } catch (err) { alert("PDF Error"); }
// // // // // // //     finally { setExportOpen(false); setCustomExportModal(false); }
// // // // // // //   };

// // // // // // //   const exportExcel = () => {
// // // // // // //     const { data } = getExportData();
// // // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // // // // //     const workbook = XLSX.utils.book_new();
// // // // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // // // //     setExportOpen(false);
// // // // // // //     setCustomExportModal(false);
// // // // // // //   };

// // // // // // //   const handleDefaultExport = (format) => {
// // // // // // //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// // // // // // //     setTimeout(() => {
// // // // // // //         if(format === 'csv') exportCSV();
// // // // // // //         if(format === 'excel') exportExcel();
// // // // // // //         if(format === 'pdf') exportPDF();
// // // // // // //     }, 100);
// // // // // // //   };

// // // // // // //   /* ---------------- ACTIONS ---------------- */
// // // // // // //   const openEdit = (s) => {
// // // // // // //     setEditStudent(s);
// // // // // // //     setEditForm({ ...s });
// // // // // // //     setPhotoFile(null);
// // // // // // //   };

// // // // // // //   const handleEditChange = (e) => setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // // // //   const saveEdit = async () => {
// // // // // // //     try {
// // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // // // // //       if (photoFile) {
// // // // // // //         const fd = new FormData();
// // // // // // //         fd.append("photo", photoFile);
// // // // // // //         await axios.post(`${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`, fd, {
// // // // // // //           headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" },
// // // // // // //         });
// // // // // // //       }
// // // // // // //       window.alert("Student profile updated successfully!");
// // // // // // //       setEditStudent(null);
// // // // // // //       fetchStudents();
// // // // // // //     } catch (err) { window.alert("Failed to update student."); }
// // // // // // //   };

// // // // // // //   const handleStatusChange = async (student, newStatus) => {
// // // // // // //     if (newStatus === "INACTIVE") {
// // // // // // //       setInactiveModal(student);
// // // // // // //       setInactiveReason(student.inactive_reason || "");
// // // // // // //     } else {
// // // // // // //       try {
// // // // // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // // // // //         window.alert("Status set to ACTIVE!");
// // // // // // //         fetchStudents();
// // // // // // //       } catch (err) { window.alert("Error updating status."); }
// // // // // // //     }
// // // // // // //   };

// // // // // // //   const confirmInactive = async () => {
// // // // // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // // // // //     try {
// // // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // // // // //       window.alert("Marked as INACTIVE successfully.");
// // // // // // //       setInactiveModal(null);
// // // // // // //       setInactiveReason("");
// // // // // // //       fetchStudents();
// // // // // // //     } catch (err) { window.alert("Error updating status."); }
// // // // // // //   };

// // // // // // //   return (
// // // // // // //     <div className="container">
// // // // // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // // // // //         <div>
// // // // // // //           <h1 className="title">Student Management</h1>
// // // // // // //           <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// // // // // // //         </div>

// // // // // // //         <div className="export-menu-wrapper">
// // // // // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // // // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // // // // //           </button>
// // // // // // //           {exportOpen && (
// // // // // // //             <div className="export-dropdown shadow-lg">
// // // // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// // // // // // //               <button onClick={() => handleDefaultExport('csv')}>Excel (Default CSV)</button>
// // // // // // //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
              
// // // // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// // // // // // //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// // // // // // //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// // // // // // //               </button>
// // // // // // //             </div>
// // // // // // //           )}
// // // // // // //         </div>
// // // // // // //       </div>

// // // // // // //       <div className="filter-bar">
// // // // // // //         <div className="filter-item">
// // // // // // //           <Filter className="input-icon" />
// // // // // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // // // // //             <option value="">All Cohorts</option>
// // // // // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // // // // //           </select>
// // // // // // //         </div>
// // // // // // //         <div className="filter-item">
// // // // // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // // // // //             <option value="">All Batches</option>
// // // // // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // // // // //           </select>
// // // // // // //         </div>
// // // // // // //         <div className="filter-item search-box">
// // // // // // //           <Search className="input-icon" />
// // // // // // //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // // // // //         </div>
// // // // // // //       </div>

// // // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // // //         <table className="students-table">
// // // // // // //           <thead>
// // // // // // //             <tr>
// // // // // // //               <th style={{ width: "45px" }}>SL NO</th>
// // // // // // //               <th>Student Name</th>
// // // // // // //               <th>Enrollment Number</th>
// // // // // // //               <th>Contact No</th>
// // // // // // //               <th>Cohort</th>
// // // // // // //               <th>Batch</th>
// // // // // // //               <th>Status</th>
// // // // // // //             </tr>
// // // // // // //           </thead>
// // // // // // //           <tbody>
// // // // // // //             {filteredStudents.map((s, index) => (
// // // // // // //               <tr key={s.student_id}>
// // // // // // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // // // // // //                 <td>
// // // // // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // // // // //                     <div onClick={() => setViewStudent(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // // // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // //                     </div>
// // // // // // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // // //                       <button onClick={() => setViewStudent(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // // // // //                         {s.student_name}
// // // // // // //                       </button>
// // // // // // //                       <button onClick={() => openEdit(s)} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // // // // //                     </div>
// // // // // // //                   </div>
// // // // // // //                 </td>
// // // // // // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // // // // // //                 <td>
// // // // // // //                   <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // // //                     <Phone size={13} className="text-blue-500" />
// // // // // // //                     <span style={{ fontSize: '13px', fontWeight: '500' }}>{s.contact_no1 || "—"}</span>
// // // // // // //                   </div>
// // // // // // //                 </td>
// // // // // // //                 <td>{s.cohort_name}</td>
// // // // // // //                 <td>{s.batch_name}</td>
// // // // // // //                 <td>
// // // // // // //                   <select value={s.active_yn} onChange={(e) => handleStatusChange(s, e.target.value)} style={{ padding: "4px 8px", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", border: "1px solid #ddd", color: s.active_yn === "ACTIVE" ? "#16a34a" : "#dc2626" }}>
// // // // // // //                     <option value="ACTIVE">ACTIVE</option>
// // // // // // //                     <option value="INACTIVE">INACTIVE</option>
// // // // // // //                   </select>
// // // // // // //                 </td>
// // // // // // //               </tr>
// // // // // // //             ))}
// // // // // // //           </tbody>
// // // // // // //         </table>
// // // // // // //       </div>

// // // // // // //       {/* CUSTOM EXPORT MODAL */}
// // // // // // //       {customExportModal && (
// // // // // // //         <div className="modal">
// // // // // // //           <div className="modal-content medium">
// // // // // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// // // // // // //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// // // // // // //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// // // // // // //             </div>
            
// // // // // // //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// // // // // // //               {STUDENT_MASTER_FIELDS.map(field => (
// // // // // // //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// // // // // // //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// // // // // // //                   {field.label}
// // // // // // //                 </label>
// // // // // // //               ))}
// // // // // // //             </div>

// // // // // // //             <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px' }}>
// // // // // // //               <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// // // // // // //             </div>
// // // // // // //           </div>
// // // // // // //         </div>
// // // // // // //       )}

// // // // // // //       {/* FULL MASTER VIEW MODAL (ALL FIELDS RESTORED) */}
// // // // // // //       {viewStudent && (
// // // // // // //         <div className="modal">
// // // // // // //           <div className="modal-content large">
// // // // // // //             <button className="close-btn" onClick={() => setViewStudent(null)}><X size={18} /></button>
// // // // // // //             <h3 className="modal-title"><User className="inline w-5 h-5 mr-1 text-blue-500" /> Student Profile</h3>
            
// // // // // // //             <div style={{ textAlign: "center", marginBottom: 20 }}>
// // // // // // //               <div style={{ width: 120, height: 120, borderRadius: "50%", overflow: "hidden", margin: "0 auto", cursor: "pointer", border: "4px solid #f3f4f6", boxShadow: "0 4px 6px -1px rgba(0,0,0,0.1)" }} onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // // // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // // //               </div>
// // // // // // //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// // // // // // //               <p style={{ color: '#6b7280', fontSize: '14px', marginBottom: '8px' }}>Gender: <strong>{viewStudent.gender || "-"}</strong></p>
// // // // // // //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// // // // // // //             </div>

// // // // // // //             <div className="profile-section" style={{ borderLeft: '4px solid #3b82f6', backgroundColor: '#f8fafc', padding: '15px', borderRadius: '0 8px 8px 0' }}>
// // // // // // //               <h4 style={{ color: '#1e40af', marginBottom: 10, display: 'flex', alignItems: 'center', gap: '8px' }}><BookOpen size={16}/> Academic & Hardware Details</h4>
// // // // // // //               <div className="profile-grid">
// // // // // // //                 <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // // // //                 <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// // // // // // //                 <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// // // // // // //                 <div><strong>SIM Name:</strong> <span style={{ color: '#be123c', fontWeight: 800 }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// // // // // // //                 <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// // // // // // //                 <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// // // // // // //               </div>
// // // // // // //             </div>

// // // // // // //             <div className="profile-section">
// // // // // // //               <h4 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><Phone size={16}/> Contact Information</h4>
// // // // // // //               <div className="profile-grid">
// // // // // // //                 <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// // // // // // //                 <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // // // //                 <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// // // // // // //                 <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// // // // // // //                 <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// // // // // // //                 <div><strong>Address:</strong> {viewStudent.home_address}</div>
// // // // // // //               </div>
// // // // // // //             </div>

// // // // // // //             <div className="profile-section">
// // // // // // //               <h4 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><User size={16}/> Parent Details</h4>
// // // // // // //               <div className="profile-grid">
// // // // // // //                 <div><strong>Father:</strong> {viewStudent.father_name}</div>
// // // // // // //                 <div><strong>Father Occupation:</strong> {viewStudent.father_occupation}</div>
// // // // // // //                 <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// // // // // // //                 <div><strong>Mother Occupation:</strong> {viewStudent.mother_occupation}</div>
// // // // // // //               </div>
// // // // // // //             </div>

// // // // // // //             <div className="profile-section">
// // // // // // //               <h4 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><MapPin size={16}/> Institute Details</h4>
// // // // // // //               <div className="profile-grid">
// // // // // // //                 <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // // // //                 <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // // // //               </div>
// // // // // // //             </div>

// // // // // // //             <div className="profile-section">
// // // // // // //               <h4 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><Smartphone size={16}/> Teacher Details</h4>
// // // // // // //               <div className="profile-grid">
// // // // // // //                 <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // // // //                 <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// // // // // // //               </div>
// // // // // // //             </div>

// // // // // // //             {viewStudent.active_yn === "INACTIVE" && (
// // // // // // //               <div className="profile-section" style={{ backgroundColor: '#fff1f2', border: '1px solid #fecaca' }}>
// // // // // // //                 <h4 style={{ color: '#be123c' }}><AlertTriangle className="inline w-4 h-4 mr-1"/> Inactive Information</h4>
// // // // // // //                 <p style={{ marginTop: '5px' }}><strong>Reason:</strong> {viewStudent.inactive_reason || "Not specified"}</p>
// // // // // // //               </div>
// // // // // // //             )}
// // // // // // //           </div>
// // // // // // //         </div>
// // // // // // //       )}

// // // // // // //       {/* EDIT MODAL SAME AS PREVIOUS */}
// // // // // // //       {editStudent && (
// // // // // // //         <div className="modal">
// // // // // // //           <div className="modal-content large">
// // // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // // // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student Details</h3>
// // // // // // //             <div className="edit-form grid-2-col">
// // // // // // //               {Object.keys(editForm).map((k) => (
// // // // // // //                 <div className="form-group" key={k}>
// // // // // // //                   <label style={{ textTransform: 'capitalize', fontWeight: '600', color: '#374151' }}>{k.replace(/_/g, " ")}</label>
// // // // // // //                   <input name={k} value={editForm[k]} onChange={handleEditChange} className="form-input" />
// // // // // // //                 </div>
// // // // // // //               ))}
// // // // // // //               <div className="form-group">
// // // // // // //                 <label style={{ fontWeight: '600' }}>Update Profile Photo</label>
// // // // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} className="form-input" />
// // // // // // //               </div>
// // // // // // //             </div>
// // // // // // //             <div className="modal-actions">
// // // // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// // // // // // //               <button className="btn primary" onClick={saveEdit}>Update Student</button>
// // // // // // //             </div>
// // // // // // //           </div>
// // // // // // //         </div>
// // // // // // //       )}

// // // // // // //       {/* INACTIVE MODAL */}
// // // // // // //       {inactiveModal && (
// // // // // // //         <div className="modal">
// // // // // // //           <div className="modal-content small">
// // // // // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// // // // // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
// // // // // // //             <div className="modal-actions">
// // // // // // //               <button className="btn secondary" onClick={() => setInactiveModal(null)}>Cancel</button>
// // // // // // //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// // // // // // //             </div>
// // // // // // //           </div>
// // // // // // //         </div>
// // // // // // //       )}

// // // // // // //       {/* FULL PHOTO VIEW */}
// // // // // // //       {fullPhoto && (
// // // // // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // // // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// // // // // // //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // // // // //           </div>
// // // // // // //         </div>
// // // // // // //       )}
// // // // // // //     </div>
// // // // // // //   );
// // // // // // // }



// // // // // // // / 22/12/2025
// // // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // // import React, { useState, useEffect, useCallback } from "react";
// // // // // // import axios from "axios";
// // // // // // import "./BatchManagement.css";
// // // // // // import {
// // // // // //   Search,
// // // // // //   Eye,
// // // // // //   Edit,
// // // // // //   X,
// // // // // //   CheckCircle,
// // // // // //   AlertTriangle,
// // // // // //   Filter,
// // // // // //   Download,
// // // // // //   ChevronDown,
// // // // // //   Phone,
// // // // // //   User,
// // // // // //   Mail,
// // // // // //   MapPin,
// // // // // //   BookOpen,
// // // // // //   Settings,
// // // // // //   ListChecks,
// // // // // //   Lock,
// // // // // //   Smartphone,
// // // // // //   Briefcase,
// // // // // //   GraduationCap
// // // // // // } from "lucide-react";
// // // // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // // // --- EXPORT LOGIC IMPORTS ---
// // // // // // import { jsPDF } from "jspdf";
// // // // // // import autoTable from "jspdf-autotable";
// // // // // // import * as XLSX from "xlsx";
// // // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // // All available fields for Custom Export
// // // // // // const STUDENT_MASTER_FIELDS = [
// // // // // //   { id: "sl_no", label: "SL NO" },
// // // // // //   { id: "student_name", label: "Student Name" },
// // // // // //   { id: "enr_id", label: "Enrollment ID" },
// // // // // //   { id: "sim_name", label: "SIM Name" },
// // // // // //   { id: "contact_no1", label: "Student Contact" },
// // // // // //   { id: "contact_no2", label: "Parent Contact" },
// // // // // //   { id: "student_email", label: "Student Email" },
// // // // // //   { id: "student_email_password", label: "Email Password" },
// // // // // //   { id: "parent_email", label: "Parent Email" },
// // // // // //   { id: "gender", label: "Gender" },
// // // // // //   { id: "father_name", label: "Father Name" },
// // // // // //   { id: "father_occupation", label: "Father Occupation" },
// // // // // //   { id: "mother_name", label: "Mother Name" },
// // // // // //   { id: "mother_occupation", label: "Mother Occupation" },
// // // // // //   { id: "home_address", label: "Home Address" },
// // // // // //   { id: "current_institute", label: "Current Institute" },
// // // // // //   { id: "previous_institute", label: "Previous Institute" },
// // // // // //   { id: "teacher_name", label: "Teacher Name" },
// // // // // //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// // // // // //   { id: "recharge_status", label: "Recharge Status" },
// // // // // //   { id: "sponsor", label: "Sponsor" },
// // // // // //   { id: "active_yn", label: "Status" },
// // // // // //   { id: "inactive_reason", label: "Inactive Reason" },
// // // // // //   { id: "cohort_name", label: "Cohort" },
// // // // // //   { id: "batch_name", label: "Batch" },
// // // // // // ];

// // // // // // export default function StudentManagement() {
// // // // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // // // //   const { user } = useAuth();
// // // // // //   const token = user?.token;

// // // // // //   const [cohorts, setCohorts] = useState([]);
// // // // // //   const [batches, setBatches] = useState([]);
// // // // // //   const [institutes, setInstitutes] = useState([]);

// // // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // // // //   const [students, setStudents] = useState([]);
// // // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // // //   const [loading, setLoading] = useState(false);

// // // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // // //   const [editForm, setEditForm] = useState({});

// // // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // // // //   const [photoFile, setPhotoFile] = useState(null);

// // // // // //   // Export States
// // // // // //   const [exportOpen, setExportOpen] = useState(false);
// // // // // //   const [customExportModal, setCustomExportModal] = useState(false);
// // // // // //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "active_yn"]);

// // // // // //   const axiosConfig = useCallback(() => ({
// // // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // // //   }), [token]);

// // // // // //   /* ---------------- FETCH DATA (WITH DUPLICATE FIX) ---------------- */
// // // // // //   const fetchStudents = useCallback(() => {
// // // // // //     if (!token) return;
// // // // // //     setLoading(true);
// // // // // //     const params = {};
// // // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // // //     axios
// // // // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params })
// // // // // //       .then(({ data }) => {
// // // // // //         // ENSURE UNIQUE RECORDS BY STUDENT ID
// // // // // //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// // // // // //         setStudents(uniqueData || []);
// // // // // //       })
// // // // // //       .catch(() => setStudents([]))
// // // // // //       .finally(() => setLoading(false));
// // // // // //   }, [token, formData, axiosConfig]);

// // // // // //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// // // // // //   useEffect(() => {
// // // // // //     if (!token) return;
// // // // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // // // //     axios.get(`${BACKEND}/api/institutes`, axiosConfig()).then(({ data }) => setInstitutes(data || []));
// // // // // //   }, [token, axiosConfig]);

// // // // // //   useEffect(() => {
// // // // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // // // //       .then(({ data }) => setBatches(data || []));
// // // // // //   }, [token, formData.cohort, axiosConfig]);

// // // // // //   /* ---------------- FILTER ---------------- */
// // // // // //   useEffect(() => {
// // // // // //     let f = [...students];
// // // // // //     if (searchQuery.trim()) {
// // // // // //       const q = searchQuery.toLowerCase();
// // // // // //       f = f.filter((s) => 
// // // // // //         s.student_name?.toLowerCase().includes(q) || 
// // // // // //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// // // // // //         s.sim_name?.toLowerCase().includes(q) || 
// // // // // //         s.contact_no1?.includes(q)
// // // // // //       );
// // // // // //     }
// // // // // //     if (statusFilter !== "all") {
// // // // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // // // //     }
// // // // // //     setFilteredStudents(f);
// // // // // //   }, [students, searchQuery, statusFilter]);

// // // // // //   /* ---------------- EXPORT LOGIC ---------------- */
// // // // // //   const toggleField = (id) => {
// // // // // //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// // // // // //   };

// // // // // //   const getExportData = () => {
// // // // // //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// // // // // //     const rows = filteredStudents.map((s, index) => {
// // // // // //       let row = {};
// // // // // //       activeFields.forEach(field => {
// // // // // //         if (field.id === "sl_no") {
// // // // // //           row[field.label] = index + 1;
// // // // // //         } else if (field.id === "gender") {
// // // // // //           row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
// // // // // //         } else {
// // // // // //           row[field.label] = s[field.id] ?? "-";
// // // // // //         }
// // // // // //       });
// // // // // //       return row;
// // // // // //     });
// // // // // //     return { data: rows, headers: activeFields.map(f => f.label) };
// // // // // //   };

// // // // // //   const exportCSV = () => {
// // // // // //     const { data } = getExportData();
// // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // //     const csv = [
// // // // // //       Object.keys(data[0]).join(","),
// // // // // //       ...data.map((r) => Object.values(r).map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")),
// // // // // //     ].join("\n");
// // // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // // //     const url = URL.createObjectURL(blob);
// // // // // //     const a = document.createElement("a");
// // // // // //     a.href = url;
// // // // // //     a.download = "Student_Report.csv";
// // // // // //     a.click();
// // // // // //     setExportOpen(false);
// // // // // //     setCustomExportModal(false);
// // // // // //   };

// // // // // //   const exportPDF = async () => {
// // // // // //     const { data, headers } = getExportData();
// // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // //     try {
// // // // // //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// // // // // //       const pageWidth = doc.internal.pageSize.getWidth();

// // // // // //       // --- ADD LOGO AND HEADER TO PDF ---
// // // // // //       let logoDataUrl = null;
// // // // // //       try {
// // // // // //         const resp = await fetch(Logo);
// // // // // //         const blob = await resp.blob();
// // // // // //         logoDataUrl = await new Promise((res) => {
// // // // // //           const reader = new FileReader();
// // // // // //           reader.onloadend = () => res(reader.result);
// // // // // //           reader.readAsDataURL(blob);
// // // // // //         });
// // // // // //       } catch (e) { console.warn("Logo load failed for PDF"); }

// // // // // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // // // // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // // // // //       doc.setFont("helvetica", "bold");
// // // // // //       doc.setFontSize(16);
// // // // // //       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
      
// // // // // //       doc.setFontSize(12);
// // // // // //       const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;
// // // // // //       doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);

// // // // // //       if (logoDataUrl) {
// // // // // //         doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);
// // // // // //       }

// // // // // //       autoTable(doc, {
// // // // // //         startY: 85,
// // // // // //         head: [headers],
// // // // // //         body: data.map(r => Object.values(r)),
// // // // // //         theme: "grid",
// // // // // //         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
// // // // // //         styles: { fontSize: 7, halign: 'center' },
// // // // // //       });

// // // // // //       doc.save("Student_Report.pdf");
// // // // // //     } catch (err) { 
// // // // // //       console.error(err);
// // // // // //       alert("PDF Error"); 
// // // // // //     }
// // // // // //     finally { setExportOpen(false); setCustomExportModal(false); }
// // // // // //   };

// // // // // //   const exportExcel = () => {
// // // // // //     const { data } = getExportData();
// // // // // //     if (!data.length) return alert("No rows to export.");
// // // // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // // // //     const workbook = XLSX.utils.book_new();
// // // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // // //     setExportOpen(false);
// // // // // //     setCustomExportModal(false);
// // // // // //   };

// // // // // //   const handleDefaultExport = (format) => {
// // // // // //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// // // // // //     setTimeout(() => {
// // // // // //         if(format === 'csv') exportCSV();
// // // // // //         if(format === 'excel') exportExcel();
// // // // // //         if(format === 'pdf') exportPDF();
// // // // // //     }, 100);
// // // // // //   };

// // // // // //   /* ---------------- ACTIONS ---------------- */
// // // // // //   const openEdit = (s) => {
// // // // // //     setEditStudent(s);
// // // // // //     setEditForm({ ...s });
// // // // // //     setPhotoFile(null);
// // // // // //   };

// // // // // //   const handleEditChange = (e) => setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // // //   const saveEdit = async () => {
// // // // // //     try {
// // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // // // //       if (photoFile) {
// // // // // //         const fd = new FormData();
// // // // // //         fd.append("photo", photoFile);
// // // // // //         await axios.post(`${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`, fd, {
// // // // // //           headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" },
// // // // // //         });
// // // // // //       }
// // // // // //       window.alert("Student profile updated successfully!");
// // // // // //       setEditStudent(null);
// // // // // //       fetchStudents();
// // // // // //     } catch (err) { window.alert("Failed to update student."); }
// // // // // //   };

// // // // // //   const handleStatusChange = async (student, newStatus) => {
// // // // // //     if (newStatus === "INACTIVE") {
// // // // // //       setInactiveModal(student);
// // // // // //       setInactiveReason(student.inactive_reason || "");
// // // // // //     } else {
// // // // // //       try {
// // // // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // // // //         window.alert("Status set to ACTIVE!");
// // // // // //         fetchStudents();
// // // // // //       } catch (err) { window.alert("Error updating status."); }
// // // // // //     }
// // // // // //   };

// // // // // //   const confirmInactive = async () => {
// // // // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // // // //     try {
// // // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // // // //       window.alert("Marked as INACTIVE successfully.");
// // // // // //       setInactiveModal(null);
// // // // // //       setInactiveReason("");
// // // // // //       fetchStudents();
// // // // // //     } catch (err) { window.alert("Error updating status."); }
// // // // // //   };

// // // // // //   return (
// // // // // //     <div className="container">
// // // // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // // // //         <div>
// // // // // //           <h1 className="title">Student Management</h1>
// // // // // //           <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// // // // // //         </div>

// // // // // //         <div className="export-menu-wrapper">
// // // // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // // // //           </button>
// // // // // //           {exportOpen && (
// // // // // //             <div className="export-dropdown shadow-lg">
// // // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// // // // // //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
// // // // // //               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
// // // // // //               <button onClick={() => handleDefaultExport('csv')}>CSV (.csv)</button>
              
// // // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// // // // // //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// // // // // //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// // // // // //               </button>
// // // // // //             </div>
// // // // // //           )}
// // // // // //         </div>
// // // // // //       </div>

// // // // // //       <div className="filter-bar">
// // // // // //         <div className="filter-item">
// // // // // //           <Filter className="input-icon" />
// // // // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // // // //             <option value="">All Cohorts</option>
// // // // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // // // //           </select>
// // // // // //         </div>
// // // // // //         <div className="filter-item">
// // // // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // // // //             <option value="">All Batches</option>
// // // // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // // // //           </select>
// // // // // //         </div>
// // // // // //         <div className="filter-item search-box">
// // // // // //           <Search className="input-icon" />
// // // // // //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // // // //         </div>
// // // // // //       </div>

// // // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // // //         <table className="students-table">
// // // // // //           <thead>
// // // // // //             <tr>
// // // // // //               <th style={{ width: "45px" }}>SL NO</th>
// // // // // //               <th>Student Name</th>
// // // // // //               <th>Enrollment Number</th>
// // // // // //               <th>Contact No</th>
// // // // // //               <th>Cohort</th>
// // // // // //               <th>Batch</th>
// // // // // //               <th>Status</th>
// // // // // //             </tr>
// // // // // //           </thead>
// // // // // //           <tbody>
// // // // // //             {filteredStudents.map((s, index) => (
// // // // // //               <tr key={s.student_id}>
// // // // // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // // // // //                 <td>
// // // // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // // // //                     <div onClick={() => setViewStudent(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // //                     </div>
// // // // // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // //                       <button onClick={() => setViewStudent(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // // // //                         {s.student_name}
// // // // // //                       </button>
// // // // // //                       <button onClick={() => openEdit(s)} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // // // //                     </div>
// // // // // //                   </div>
// // // // // //                 </td>
// // // // // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // // // // //                 <td>
// // // // // //                   <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // // //                     <Phone size={13} className="text-blue-500" />
// // // // // //                     <span style={{ fontSize: '13px', fontWeight: '500' }}>{s.contact_no1 || "—"}</span>
// // // // // //                   </div>
// // // // // //                 </td>
// // // // // //                 <td>{s.cohort_name}</td>
// // // // // //                 <td>{s.batch_name}</td>
// // // // // //                 <td>
// // // // // //                   <select value={s.active_yn} onChange={(e) => handleStatusChange(s, e.target.value)} style={{ padding: "4px 8px", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", border: "1px solid #ddd", color: s.active_yn === "ACTIVE" ? "#16a34a" : "#dc2626" }}>
// // // // // //                     <option value="ACTIVE">ACTIVE</option>
// // // // // //                     <option value="INACTIVE">INACTIVE</option>
// // // // // //                   </select>
// // // // // //                 </td>
// // // // // //               </tr>
// // // // // //             ))}
// // // // // //           </tbody>
// // // // // //         </table>
// // // // // //       </div>

// // // // // //       {/* CUSTOM EXPORT MODAL */}
// // // // // //       {customExportModal && (
// // // // // //         <div className="modal">
// // // // // //           <div className="modal-content medium">
// // // // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// // // // // //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// // // // // //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// // // // // //             </div>
            
// // // // // //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// // // // // //               {STUDENT_MASTER_FIELDS.map(field => (
// // // // // //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// // // // // //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// // // // // //                   {field.label}
// // // // // //                 </label>
// // // // // //               ))}
// // // // // //             </div>

// // // // // //             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
// // // // // //                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
// // // // // //                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// // // // // //             </div>
// // // // // //           </div>
// // // // // //         </div>
// // // // // //       )}

// // // // // //       {/* VIEW MODAL (REORGANIZED SECTIONS) */}
// // // // // //       {viewStudent && (
// // // // // //         <div className="modal">
// // // // // //           <div className="modal-content large">
// // // // // //             <button className="close-btn" onClick={() => setViewStudent(null)}><X size={18} /></button>
// // // // // //             <h3 className="modal-title"><User className="inline w-5 h-5 mr-1 text-blue-500" /> Student Profile</h3>
            
// // // // // //             <div style={{ textAlign: "center", marginBottom: 20 }}>
// // // // // //               <div style={{ width: 120, height: 120, borderRadius: "50%", overflow: "hidden", margin: "0 auto", cursor: "pointer", border: "4px solid #f3f4f6", boxShadow: "0 4px 6px -1px rgba(0,0,0,0.1)" }} onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // // //               </div>
// // // // // //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// // // // // //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// // // // // //             </div>

// // // // // //             <div className="profile-sections-container">
// // // // // //               {/* 1. PERSONAL DETAILS */}
// // // // // //               <div className="profile-section-block">
// // // // // //                 <h4 className="section-title"><User size={18} /> Personal Details</h4>
// // // // // //                 <div className="profile-grid">
// // // // // //                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
// // // // // //                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // // //                 </div>
// // // // // //               </div>

// // // // // //               {/* 2. ACADEMIC & HARDWARE */}
// // // // // //               <div className="profile-section-block highlight-hardware">
// // // // // //                 <h4 className="section-title"><BookOpen size={18} /> Academic & Hardware</h4>
// // // // // //                 <div className="profile-grid">
// // // // // //                   <div><strong>SIM Name:</strong> <span style={{ color: '#be123c', fontWeight: 800 }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// // // // // //                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// // // // // //                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// // // // // //                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// // // // // //                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// // // // // //                 </div>
// // // // // //               </div>

// // // // // //               {/* 3. CONTACT INFORMATION */}
// // // // // //               <div className="profile-section-block">
// // // // // //                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
// // // // // //                 <div className="profile-grid">
// // // // // //                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// // // // // //                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // // //                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// // // // // //                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// // // // // //                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// // // // // //                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // // // //                 </div>
// // // // // //               </div>

// // // // // //               {/* 4. FAMILY DETAILS */}
// // // // // //               <div className="profile-section-block">
// // // // // //                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
// // // // // //                 <div className="profile-grid">
// // // // // //                   <div><strong>Father:</strong> {viewStudent.father_name}</div>
// // // // // //                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
// // // // // //                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// // // // // //                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
// // // // // //                 </div>
// // // // // //               </div>

// // // // // //               {/* 5. INSTITUTE & TEACHER */}
// // // // // //               <div className="profile-section-block">
// // // // // //                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
// // // // // //                 <div className="profile-grid">
// // // // // //                   <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // // //                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // // //                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // // //                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// // // // // //                 </div>
// // // // // //               </div>

// // // // // //               {viewStudent.active_yn === "INACTIVE" && (
// // // // // //                 <div className="profile-section-block deactivation-block">
// // // // // //                   <h4 className="section-title text-red-600"><AlertTriangle size={18}/> Inactive Information</h4>
// // // // // //                   <p><strong>Reason:</strong> {viewStudent.inactive_reason || "Not specified"}</p>
// // // // // //                 </div>
// // // // // //               )}
// // // // // //             </div>
// // // // // //           </div>
// // // // // //         </div>
// // // // // //       )}

// // // // // //       {/* EDIT MODAL */}
// // // // // //       {editStudent && (
// // // // // //         <div className="modal">
// // // // // //           <div className="modal-content large">
// // // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student Details</h3>
// // // // // //             <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto', paddingRight: '10px' }}>
// // // // // //               {Object.keys(editForm).map((k) => {
// // // // // //                 if (['student_id', 'photo_link', 'batch_id', 'cohort_number'].includes(k)) return null;
// // // // // //                 return (
// // // // // //                   <div className="form-group" key={k}>
// // // // // //                     <label style={{ textTransform: 'capitalize', fontWeight: '600', color: '#374151' }}>{k.replace(/_/g, " ")}</label>
// // // // // //                     <input name={k} value={editForm[k] || ""} onChange={handleEditChange} className="form-input" />
// // // // // //                   </div>
// // // // // //                 )
// // // // // //               })}
// // // // // //               <div className="form-group">
// // // // // //                 <label style={{ fontWeight: '600' }}>Update Profile Photo</label>
// // // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} className="form-input" />
// // // // // //               </div>
// // // // // //             </div>
// // // // // //             <div className="modal-actions">
// // // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// // // // // //               <button className="btn primary" onClick={saveEdit}>Update Student</button>
// // // // // //             </div>
// // // // // //           </div>
// // // // // //         </div>
// // // // // //       )}

// // // // // //       {/* INACTIVE MODAL */}
// // // // // //       {inactiveModal && (
// // // // // //         <div className="modal">
// // // // // //           <div className="modal-content small">
// // // // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// // // // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
// // // // // //             <div className="modal-actions">
// // // // // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // // // // //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// // // // // //             </div>
// // // // // //           </div>
// // // // // //         </div>
// // // // // //       )}

// // // // // //       {/* FULL PHOTO VIEW */}
// // // // // //       {fullPhoto && (
// // // // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// // // // // //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // // // //           </div>
// // // // // //         </div>
// // // // // //       )}

// // // // // //       <style>{`
// // // // // //         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
// // // // // //         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
// // // // // //         .highlight-hardware { background: #fff1f2; border-color: #fecaca; }
// // // // // //         .deactivation-block { background: #fff1f2; border: 1px solid #fecaca; }
// // // // // //         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
// // // // // //         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
// // // // // //         .full-row { grid-column: span 2; }
// // // // // //         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
// // // // // //       `}</style>
// // // // // //     </div>
// // // // // //   );
// // // // // // }



// // // // // // / 22/12/2025
// // // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // // import React, { useState, useEffect, useCallback } from "react";
// // // // // import axios from "axios";
// // // // // import "./BatchManagement.css";
// // // // // import {
// // // // //   Search,
// // // // //   Eye,
// // // // //   Edit,
// // // // //   X,
// // // // //   CheckCircle,
// // // // //   AlertTriangle,
// // // // //   Filter,
// // // // //   Download,
// // // // //   ChevronDown,
// // // // //   Phone,
// // // // //   User,
// // // // //   Mail,
// // // // //   MapPin,
// // // // //   BookOpen,
// // // // //   Settings,
// // // // //   ListChecks,
// // // // //   Lock,
// // // // //   Smartphone,
// // // // //   Briefcase,
// // // // //   GraduationCap,
// // // // //   History,
// // // // //   Calendar
// // // // // } from "lucide-react";
// // // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // // --- EXPORT LOGIC IMPORTS ---
// // // // // import { jsPDF } from "jspdf";
// // // // // import autoTable from "jspdf-autotable";
// // // // // import * as XLSX from "xlsx";
// // // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // // All available fields for Custom Export
// // // // // const STUDENT_MASTER_FIELDS = [
// // // // //   { id: "sl_no", label: "SL NO" },
// // // // //   { id: "student_name", label: "Student Name" },
// // // // //   { id: "enr_id", label: "Enrollment ID" },
// // // // //   { id: "sim_name", label: "SIM Name" },
// // // // //   { id: "contact_no1", label: "Student Contact" },
// // // // //   { id: "contact_no2", label: "Parent Contact" },
// // // // //   { id: "student_email", label: "Student Email" },
// // // // //   { id: "student_email_password", label: "Email Password" },
// // // // //   { id: "parent_email", label: "Parent Email" },
// // // // //   { id: "gender", label: "Gender" },
// // // // //   { id: "father_name", label: "Father Name" },
// // // // //   { id: "father_occupation", label: "Father Occupation" },
// // // // //   { id: "mother_name", label: "Mother Name" },
// // // // //   { id: "mother_occupation", label: "Mother Occupation" },
// // // // //   { id: "home_address", label: "Home Address" },
// // // // //   { id: "current_institute", label: "Current Institute" },
// // // // //   { id: "previous_institute", label: "Previous Institute" },
// // // // //   { id: "teacher_name", label: "Teacher Name" },
// // // // //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// // // // //   { id: "recharge_status", label: "Recharge Status" },
// // // // //   { id: "sponsor", label: "Sponsor" },
// // // // //   { id: "active_yn", label: "Status" },
// // // // //   { id: "inactive_reason", label: "Inactive Reason" },
// // // // //   { id: "cohort_name", label: "Cohort" },
// // // // //   { id: "batch_name", label: "Batch" },
// // // // // ];

// // // // // export default function StudentManagement() {
// // // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // // //   const { user } = useAuth();
// // // // //   const token = user?.token;

// // // // //   const [cohorts, setCohorts] = useState([]);
// // // // //   const [batches, setBatches] = useState([]);
// // // // //   const [institutes, setInstitutes] = useState([]);

// // // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // // //   const [students, setStudents] = useState([]);
// // // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // // //   const [searchQuery, setSearchQuery] = useState("");
// // // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // // //   const [loading, setLoading] = useState(false);

// // // // //   const [viewStudent, setViewStudent] = useState(null);
// // // // //   const [inactiveHistory, setInactiveHistory] = useState([]); // State for history table
// // // // //   const [editStudent, setEditStudent] = useState(null);
// // // // //   const [editForm, setEditForm] = useState({});

// // // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // // //   const [photoFile, setPhotoFile] = useState(null);

// // // // //   // Export States
// // // // //   const [exportOpen, setExportOpen] = useState(false);
// // // // //   const [customExportModal, setCustomExportModal] = useState(false);
// // // // //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "active_yn"]);

// // // // //   const axiosConfig = useCallback(() => ({
// // // // //     headers: { Authorization: `Bearer ${token}` },
// // // // //   }), [token]);

// // // // //   /* ---------------- FETCH DATA (WITH DUPLICATE FIX) ---------------- */
// // // // //   const fetchStudents = useCallback(() => {
// // // // //     if (!token) return;
// // // // //     setLoading(true);
// // // // //     const params = {};
// // // // //     if (formData.cohort) params.cohortNumber = formData.cohort;
// // // // //     if (formData.batch) params.batchId = formData.batch;

// // // // //     axios
// // // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params })
// // // // //       .then(({ data }) => {
// // // // //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// // // // //         setStudents(uniqueData || []);
// // // // //       })
// // // // //       .catch(() => setStudents([]))
// // // // //       .finally(() => setLoading(false));
// // // // //   }, [token, formData, axiosConfig]);

// // // // //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// // // // //   /* ---------------- FETCH INACTIVE HISTORY ---------------- */
// // // // //   const fetchInactiveHistory = async (studentId) => {
// // // // //     try {
// // // // //       const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());
// // // // //       setInactiveHistory(data || []);
// // // // //     } catch (err) {
// // // // //       setInactiveHistory([]);
// // // // //     }
// // // // //   };

// // // // //   const handleOpenProfile = (student) => {
// // // // //     setViewStudent(student);
// // // // //     fetchInactiveHistory(student.student_id);
// // // // //   };

// // // // //   useEffect(() => {
// // // // //     if (!token) return;
// // // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // // //     axios.get(`${BACKEND}/api/institutes`, axiosConfig()).then(({ data }) => setInstitutes(data || []));
// // // // //   }, [token, axiosConfig]);

// // // // //   useEffect(() => {
// // // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // // //       .then(({ data }) => setBatches(data || []));
// // // // //   }, [token, formData.cohort, axiosConfig]);

// // // // //   /* ---------------- FILTER ---------------- */
// // // // //   useEffect(() => {
// // // // //     let f = [...students];
// // // // //     if (searchQuery.trim()) {
// // // // //       const q = searchQuery.toLowerCase();
// // // // //       f = f.filter((s) => 
// // // // //         s.student_name?.toLowerCase().includes(q) || 
// // // // //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// // // // //         s.sim_name?.toLowerCase().includes(q) || 
// // // // //         s.contact_no1?.includes(q)
// // // // //       );
// // // // //     }
// // // // //     if (statusFilter !== "all") {
// // // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // // //     }
// // // // //     setFilteredStudents(f);
// // // // //   }, [students, searchQuery, statusFilter]);

// // // // //   /* ---------------- EXPORT LOGIC ---------------- */
// // // // //   const toggleField = (id) => {
// // // // //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// // // // //   };

// // // // //   const getExportData = () => {
// // // // //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// // // // //     const rows = filteredStudents.map((s, index) => {
// // // // //       let row = {};
// // // // //       activeFields.forEach(field => {
// // // // //         if (field.id === "sl_no") {
// // // // //           row[field.label] = index + 1;
// // // // //         } else if (field.id === "gender") {
// // // // //           row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
// // // // //         } else {
// // // // //           row[field.label] = s[field.id] ?? "-";
// // // // //         }
// // // // //       });
// // // // //       return row;
// // // // //     });
// // // // //     return { data: rows, headers: activeFields.map(f => f.label) };
// // // // //   };

// // // // //   const exportCSV = () => {
// // // // //     const { data } = getExportData();
// // // // //     if (!data.length) return alert("No rows to export.");
// // // // //     const csv = [
// // // // //       Object.keys(data[0]).join(","),
// // // // //       ...data.map((r) => Object.values(r).map((v) => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")),
// // // // //     ].join("\n");
// // // // //     const blob = new Blob([csv], { type: "text/csv" });
// // // // //     const url = URL.createObjectURL(blob);
// // // // //     const a = document.createElement("a");
// // // // //     a.href = url;
// // // // //     a.download = "Student_Report.csv";
// // // // //     a.click();
// // // // //     setExportOpen(false);
// // // // //     setCustomExportModal(false);
// // // // //   };

// // // // //   const exportPDF = async () => {
// // // // //     const { data, headers } = getExportData();
// // // // //     if (!data.length) return alert("No rows to export.");
// // // // //     try {
// // // // //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// // // // //       const pageWidth = doc.internal.pageSize.getWidth();

// // // // //       // --- ADD LOGO AND HEADER TO PDF ---
// // // // //       let logoDataUrl = null;
// // // // //       try {
// // // // //         const resp = await fetch(Logo);
// // // // //         const blob = await resp.blob();
// // // // //         logoDataUrl = await new Promise((res) => {
// // // // //           const reader = new FileReader();
// // // // //           reader.onloadend = () => res(reader.result);
// // // // //           reader.readAsDataURL(blob);
// // // // //         });
// // // // //       } catch (e) { console.warn("Logo load failed for PDF"); }

// // // // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // // // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // // // //       doc.setFont("helvetica", "bold");
// // // // //       doc.setFontSize(16);
// // // // //       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
      
// // // // //       doc.setFontSize(12);
// // // // //       const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;
// // // // //       doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);

// // // // //       if (logoDataUrl) {
// // // // //         doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);
// // // // //       }

// // // // //       autoTable(doc, {
// // // // //         startY: 85,
// // // // //         head: [headers],
// // // // //         body: data.map(r => Object.values(r)),
// // // // //         theme: "grid",
// // // // //         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
// // // // //         styles: { fontSize: 7, halign: 'center' },
// // // // //       });

// // // // //       doc.save("Student_Report.pdf");
// // // // //     } catch (err) { 
// // // // //       console.error(err);
// // // // //       alert("PDF Error"); 
// // // // //     }
// // // // //     finally { setExportOpen(false); setCustomExportModal(false); }
// // // // //   };

// // // // //   const exportExcel = () => {
// // // // //     const { data } = getExportData();
// // // // //     if (!data.length) return alert("No rows to export.");
// // // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // // //     const workbook = XLSX.utils.book_new();
// // // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // // //     setExportOpen(false);
// // // // //     setCustomExportModal(false);
// // // // //   };

// // // // //   const handleDefaultExport = (format) => {
// // // // //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// // // // //     setTimeout(() => {
// // // // //         if(format === 'csv') exportCSV();
// // // // //         if(format === 'excel') exportExcel();
// // // // //         if(format === 'pdf') exportPDF();
// // // // //     }, 100);
// // // // //   };

// // // // //   /* ---------------- ACTIONS ---------------- */
// // // // //   const openEdit = (s) => {
// // // // //     setEditStudent(s);
// // // // //     setEditForm({ ...s });
// // // // //     setPhotoFile(null);
// // // // //   };

// // // // //   const handleEditChange = (e) => setEditForm((p) => ({ ...p, [e.target.name]: e.target.value }));

// // // // //   const saveEdit = async () => {
// // // // //     try {
// // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // // //       if (photoFile) {
// // // // //         const fd = new FormData();
// // // // //         fd.append("photo", photoFile);
// // // // //         await axios.post(`${BACKEND}/api/coordinator/students/${editStudent.student_id}/photo`, fd, {
// // // // //           headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" },
// // // // //         });
// // // // //       }
// // // // //       window.alert("Student profile updated successfully!");
// // // // //       setEditStudent(null);
// // // // //       fetchStudents();
// // // // //     } catch (err) { window.alert("Failed to update student."); }
// // // // //   };

// // // // //   const handleStatusChange = async (student, newStatus) => {
// // // // //     if (newStatus === "INACTIVE") {
// // // // //       setInactiveModal(student);
// // // // //       setInactiveReason("");
// // // // //     } else {
// // // // //       try {
// // // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // // //         window.alert("Status set to ACTIVE!");
// // // // //         fetchStudents();
// // // // //       } catch (err) { window.alert("Error updating status."); }
// // // // //     }
// // // // //   };

// // // // //   const confirmInactive = async () => {
// // // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // // //     try {
// // // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // // //       window.alert("Marked as INACTIVE successfully.");
// // // // //       setInactiveModal(null);
// // // // //       setInactiveReason("");
// // // // //       fetchStudents();
// // // // //     } catch (err) { window.alert("Error updating status."); }
// // // // //   };

// // // // //   return (
// // // // //     <div className="container">
// // // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // // //         <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
// // // // //           <img src={Logo} alt="RCF Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />
// // // // //           <div>
// // // // //             <h1 className="title">Student Management</h1>
// // // // //             <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// // // // //           </div>
// // // // //         </div>

// // // // //         <div className="export-menu-wrapper">
// // // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // // //           </button>
// // // // //           {exportOpen && (
// // // // //             <div className="export-dropdown shadow-lg">
// // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// // // // //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
// // // // //               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
// // // // //               <button onClick={() => handleDefaultExport('csv')}>CSV (.csv)</button>
              
// // // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// // // // //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// // // // //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// // // // //               </button>
// // // // //             </div>
// // // // //           )}
// // // // //         </div>
// // // // //       </div>

// // // // //       <div className="filter-bar">
// // // // //         <div className="filter-item">
// // // // //           <Filter className="input-icon" />
// // // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // // //             <option value="">All Cohorts</option>
// // // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // // //           </select>
// // // // //         </div>
// // // // //         <div className="filter-item">
// // // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // // //             <option value="">All Batches</option>
// // // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // // //           </select>
// // // // //         </div>
// // // // //         <div className="filter-item search-box">
// // // // //           <Search className="input-icon" />
// // // // //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // // //         </div>
// // // // //       </div>

// // // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // // //         <table className="students-table">
// // // // //           <thead>
// // // // //             <tr>
// // // // //               <th style={{ width: "45px" }}>SL NO</th>
// // // // //               <th>Student Name</th>
// // // // //               <th>Enrollment Number</th>
// // // // //               <th>Contact No</th>
// // // // //               <th>Cohort</th>
// // // // //               <th>Batch</th>
// // // // //               <th>Status</th>
// // // // //             </tr>
// // // // //           </thead>
// // // // //           <tbody>
// // // // //             {filteredStudents.map((s, index) => (
// // // // //               <tr key={s.student_id}>
// // // // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // // // //                 <td>
// // // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // // //                     <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // // //                     </div>
// // // // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // //                       <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // // //                         {s.student_name}
// // // // //                       </button>
// // // // //                       <button onClick={() => openEdit(s)} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // // //                     </div>
// // // // //                   </div>
// // // // //                 </td>
// // // // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // // // //                 <td>
// // // // //                   <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // // //                     <Phone size={13} className="text-blue-500" />
// // // // //                     <span style={{ fontSize: '13px', fontWeight: '500' }}>{s.contact_no1 || "—"}</span>
// // // // //                   </div>
// // // // //                 </td>
// // // // //                 <td>{s.cohort_name}</td>
// // // // //                 <td>{s.batch_name}</td>
// // // // //                 <td>
// // // // //                   <select value={s.active_yn} onChange={(e) => handleStatusChange(s, e.target.value)} style={{ padding: "4px 8px", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", border: "1px solid #ddd", color: s.active_yn === "ACTIVE" ? "#16a34a" : "#dc2626" }}>
// // // // //                     <option value="ACTIVE">ACTIVE</option>
// // // // //                     <option value="INACTIVE">INACTIVE</option>
// // // // //                   </select>
// // // // //                 </td>
// // // // //               </tr>
// // // // //             ))}
// // // // //           </tbody>
// // // // //         </table>
// // // // //       </div>

// // // // //       {/* CUSTOM EXPORT MODAL */}
// // // // //       {customExportModal && (
// // // // //         <div className="modal">
// // // // //           <div className="modal-content medium">
// // // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// // // // //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// // // // //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// // // // //             </div>
            
// // // // //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// // // // //               {STUDENT_MASTER_FIELDS.map(field => (
// // // // //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// // // // //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// // // // //                   {field.label}
// // // // //                 </label>
// // // // //               ))}
// // // // //             </div>

// // // // //             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
// // // // //                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
// // // // //                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// // // // //             </div>
// // // // //           </div>
// // // // //         </div>
// // // // //       )}

// // // // //       {/* VIEW MODAL (WITH INACTIVE HISTORY SECTION) */}
// // // // //       {viewStudent && (
// // // // //         <div className="modal">
// // // // //           <div className="modal-content large">
// // // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
// // // // //                <img src={Logo} alt="Logo" style={{ width: '50px' }} />
// // // // //                <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>
// // // // //             </div>
            
// // // // //             <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>
// // // // //               <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />
// // // // //               </div>
// // // // //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// // // // //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// // // // //             </div>

// // // // //             <div className="profile-sections-container">
// // // // //               {/* 1. PERSONAL DETAILS */}
// // // // //               <div className="profile-section-block">
// // // // //                 <h4 className="section-title"><User size={18} /> Personal Details</h4>
// // // // //                 <div className="profile-grid">
// // // // //                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
// // // // //                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // // //                 </div>
// // // // //               </div>

// // // // //               {/* 2. ACADEMIC & HARDWARE */}
// // // // //               <div className="profile-section-block highlight-hardware">
// // // // //                 <h4 className="section-title"><BookOpen size={18} /> Academic & Hardware</h4>
// // // // //                 <div className="profile-grid">
// // // // //                   <div><strong>SIM Name:</strong> <span style={{ color: '#be123c', fontWeight: 800 }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// // // // //                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// // // // //                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// // // // //                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// // // // //                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// // // // //                 </div>
// // // // //               </div>

// // // // //               {/* 3. INACTIVE HISTORY (NEW SECTION) */}
// // // // //               <div className="profile-section-block">
// // // // //                 <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>
// // // // //                 <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>
// // // // //                   {inactiveHistory.length > 0 ? (
// // // // //                     inactiveHistory.map((h, i) => (
// // // // //                       <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>
// // // // //                         <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>
// // // // //                           <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}
// // // // //                         </div>
// // // // //                         <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>
// // // // //                       </div>
// // // // //                     ))
// // // // //                   ) : (
// // // // //                     <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>
// // // // //                   )}
// // // // //                 </div>
// // // // //               </div>

// // // // //               {/* 4. CONTACT INFORMATION */}
// // // // //               <div className="profile-section-block">
// // // // //                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
// // // // //                 <div className="profile-grid">
// // // // //                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// // // // //                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // // //                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// // // // //                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// // // // //                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// // // // //                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // // //                 </div>
// // // // //               </div>

// // // // //               {/* 5. FAMILY DETAILS */}
// // // // //               <div className="profile-section-block">
// // // // //                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
// // // // //                 <div className="profile-grid">
// // // // //                   <div><strong>Father:</strong> {viewStudent.father_name}</div>
// // // // //                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
// // // // //                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// // // // //                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
// // // // //                 </div>
// // // // //               </div>

// // // // //               {/* 6. INSTITUTE & TEACHER */}
// // // // //               <div className="profile-section-block">
// // // // //                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
// // // // //                 <div className="profile-grid">
// // // // //                   <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // // //                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // // //                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // // //                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// // // // //                 </div>
// // // // //               </div>
// // // // //             </div>
// // // // //           </div>
// // // // //         </div>
// // // // //       )}

// // // // //       {/* EDIT MODAL */}
// // // // //       {editStudent && (
// // // // //         <div className="modal">
// // // // //           <div className="modal-content large">
// // // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student Details</h3>
// // // // //             <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto', paddingRight: '10px' }}>
// // // // //               {Object.keys(editForm).map((k) => {
// // // // //                 if (['student_id', 'photo_link', 'batch_id', 'cohort_number'].includes(k)) return null;
// // // // //                 return (
// // // // //                   <div className="form-group" key={k}>
// // // // //                     <label style={{ textTransform: 'capitalize', fontWeight: '600', color: '#374151' }}>{k.replace(/_/g, " ")}</label>
// // // // //                     <input name={k} value={editForm[k] || ""} onChange={handleEditChange} className="form-input" />
// // // // //                   </div>
// // // // //                 )
// // // // //               })}
// // // // //               <div className="form-group">
// // // // //                 <label style={{ fontWeight: '600' }}>Update Profile Photo</label>
// // // // //                 <input type="file" accept="image/*" onChange={(e) => setPhotoFile(e.target.files[0])} className="form-input" />
// // // // //               </div>
// // // // //             </div>
// // // // //             <div className="modal-actions">
// // // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// // // // //               <button className="btn primary" onClick={saveEdit}>Update Student</button>
// // // // //             </div>
// // // // //           </div>
// // // // //         </div>
// // // // //       )}

// // // // //       {/* INACTIVE MODAL */}
// // // // //       {inactiveModal && (
// // // // //         <div className="modal">
// // // // //           <div className="modal-content small">
// // // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// // // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
// // // // //             <div className="modal-actions">
// // // // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // // // //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// // // // //             </div>
// // // // //           </div>
// // // // //         </div>
// // // // //       )}

// // // // //       {/* FULL PHOTO VIEW */}
// // // // //       {fullPhoto && (
// // // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// // // // //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // // //           </div>
// // // // //         </div>
// // // // //       )}

// // // // //       <style>{`
// // // // //         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
// // // // //         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
// // // // //         .highlight-hardware { background: #fff1f2; border-color: #fecaca; }
// // // // //         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
// // // // //         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
// // // // //         .full-row { grid-column: span 2; }
// // // // //         .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
// // // // //         .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
// // // // //         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
// // // // //         .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
// // // // //         .status-select.active { color: #16a34a; }
// // // // //         .status-select.inactive { color: #dc2626; }
// // // // //       `}</style>
// // // // //     </div>
// // // // //   );
// // // // // }





// // // // // / 22/12/2025
// // // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // // import React, { useState, useEffect, useCallback } from "react";
// // // // import axios from "axios";
// // // // import "./BatchManagement.css";
// // // // import {
// // // //   Search,
// // // //   Eye,
// // // //   Edit,
// // // //   X,
// // // //   CheckCircle,
// // // //   AlertTriangle,
// // // //   Filter,
// // // //   Download,
// // // //   ChevronDown,
// // // //   Phone,
// // // //   User,
// // // //   Mail,
// // // //   MapPin,
// // // //   BookOpen,
// // // //   Settings,
// // // //   ListChecks,
// // // //   Lock,
// // // //   Smartphone,
// // // //   Briefcase,
// // // //   History,
// // // //   Calendar,
// // // //   GraduationCap,
// // // //   MoreHorizontal
// // // // } from "lucide-react";
// // // // import { useAuth } from "../../contexts/AuthContext";

// // // // // --- EXPORT LOGIC IMPORTS ---
// // // // import { jsPDF } from "jspdf";
// // // // import autoTable from "jspdf-autotable";
// // // // import * as XLSX from "xlsx";
// // // // import Logo from "../../assets/RCF-PP.jpg";

// // // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // // All available fields for Custom Export
// // // // const STUDENT_MASTER_FIELDS = [
// // // //   { id: "sl_no", label: "SL NO" },
// // // //   { id: "student_name", label: "Student Name" },
// // // //   { id: "enr_id", label: "Enrollment ID" },
// // // //   { id: "sim_name", label: "SIM Name" },
// // // //   { id: "contact_no1", label: "Student Contact" },
// // // //   { id: "contact_no2", label: "Parent Contact" },
// // // //   { id: "student_email", label: "Student Email" },
// // // //   { id: "student_email_password", label: "Email Password" },
// // // //   { id: "parent_email", label: "Parent Email" },
// // // //   { id: "gender", label: "Gender" },
// // // //   { id: "father_name", label: "Father Name" },
// // // //   { id: "father_occupation", label: "Father Occupation" },
// // // //   { id: "mother_name", label: "Mother Name" },
// // // //   { id: "mother_occupation", label: "Mother Occupation" },
// // // //   { id: "home_address", label: "Home Address" },
// // // //   { id: "current_institute", label: "Current Institute" },
// // // //   { id: "previous_institute", label: "Previous Institute" },
// // // //   { id: "teacher_name", label: "Teacher Name" },
// // // //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// // // //   { id: "recharge_status", label: "Recharge Status" },
// // // //   { id: "sponsor", label: "Sponsor" },
// // // //   { id: "active_yn", label: "Status" },
// // // //   { id: "inactive_reason", label: "Inactive Reason" },
// // // //   { id: "cohort_name", label: "Cohort" },
// // // //   { id: "batch_name", label: "Batch" },
// // // // ];

// // // // export default function StudentManagement() {
// // // //   const [fullPhoto, setFullPhoto] = useState(null);
// // // //   const { user } = useAuth();
// // // //   const token = user?.token;

// // // //   const [cohorts, setCohorts] = useState([]);
// // // //   const [batches, setBatches] = useState([]);
// // // //   const [institutes, setInstitutes] = useState([]);

// // // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // // //   const [students, setStudents] = useState([]);
// // // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // // //   const [searchQuery, setSearchQuery] = useState("");
// // // //   const [statusFilter, setStatusFilter] = useState("all");
// // // //   const [loading, setLoading] = useState(false);

// // // //   const [viewStudent, setViewStudent] = useState(null);
// // // //   const [inactiveHistory, setInactiveHistory] = useState([]);
// // // //   const [editStudent, setEditStudent] = useState(null);
// // // //   const [editForm, setEditForm] = useState({});

// // // //   const [inactiveModal, setInactiveModal] = useState(null);
// // // //   const [inactiveReason, setInactiveReason] = useState("");
// // // //   const [photoFile, setPhotoFile] = useState(null);

// // // //   // Export States
// // // //   const [exportOpen, setExportOpen] = useState(false);
// // // //   const [customExportModal, setCustomExportModal] = useState(false);
// // // //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);

// // // //   const axiosConfig = useCallback(() => ({
// // // //     headers: { Authorization: `Bearer ${token}` },
// // // //   }), [token]);

// // // //   /* ---------------- FETCH DATA ---------------- */
// // // //   const fetchStudents = useCallback(() => {
// // // //     if (!token) return;
// // // //     setLoading(true);
// // // //     axios
// // // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params: { cohortNumber: formData.cohort, batchId: formData.batch } })
// // // //       .then(({ data }) => {
// // // //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// // // //         setStudents(uniqueData || []);
// // // //       })
// // // //       .catch(() => setStudents([]))
// // // //       .finally(() => setLoading(false));
// // // //   }, [token, formData, axiosConfig]);

// // // //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// // // //   const fetchInactiveHistory = async (studentId) => {
// // // //     try {
// // // //       const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());
// // // //       setInactiveHistory(data || []);
// // // //     } catch (err) {
// // // //       setInactiveHistory([]);
// // // //     }
// // // //   };

// // // //   const handleOpenProfile = (student) => {
// // // //     setViewStudent(student);
// // // //     fetchInactiveHistory(student.student_id);
// // // //   };

// // // //   useEffect(() => {
// // // //     if (!token) return;
// // // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // // //   }, [token, axiosConfig]);

// // // //   useEffect(() => {
// // // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // // //       .then(({ data }) => setBatches(data || []));
// // // //   }, [token, formData.cohort, axiosConfig]);

// // // //   /* ---------------- FILTER ---------------- */
// // // //   useEffect(() => {
// // // //     let f = [...students];
// // // //     if (searchQuery.trim()) {
// // // //       const q = searchQuery.toLowerCase();
// // // //       f = f.filter((s) => 
// // // //         s.student_name?.toLowerCase().includes(q) || 
// // // //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// // // //         s.sim_name?.toLowerCase().includes(q) || 
// // // //         s.contact_no1?.includes(q)
// // // //       );
// // // //     }
// // // //     if (statusFilter !== "all") {
// // // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // // //     }
// // // //     setFilteredStudents(f);
// // // //   }, [students, searchQuery, statusFilter]);

// // // //   /* ---------------- EXPORT LOGIC ---------------- */
// // // //   const toggleField = (id) => {
// // // //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// // // //   };

// // // //   const getExportData = () => {
// // // //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// // // //     const rows = filteredStudents.map((s, index) => {
// // // //       let row = {};
// // // //       activeFields.forEach(field => {
// // // //         if (field.id === "sl_no") {
// // // //           row[field.label] = index + 1;
// // // //         } else if (field.id === "gender") {
// // // //           row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
// // // //         } else {
// // // //           row[field.label] = s[field.id] ?? "-";
// // // //         }
// // // //       });
// // // //       return row;
// // // //     });
// // // //     return { data: rows, headers: activeFields.map(f => f.label) };
// // // //   };

// // // //   const exportPDF = async () => {
// // // //     const { data, headers } = getExportData();
// // // //     if (!data.length) return alert("No rows to export.");
// // // //     try {
// // // //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// // // //       const pageWidth = doc.internal.pageSize.getWidth();

// // // //       let logoDataUrl = null;
// // // //       try {
// // // //         const resp = await fetch(Logo);
// // // //         const blob = await resp.blob();
// // // //         logoDataUrl = await new Promise((res) => {
// // // //           const reader = new FileReader();
// // // //           reader.onloadend = () => res(reader.result);
// // // //           reader.readAsDataURL(blob);
// // // //         });
// // // //       } catch (e) { console.warn("Logo load failed for PDF"); }

// // // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // // //       doc.setFont("helvetica", "bold");
// // // //       doc.setFontSize(16);
// // // //       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
      
// // // //       doc.setFontSize(12);
// // // //       const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;
// // // //       doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);

// // // //       if (logoDataUrl) {
// // // //         doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);
// // // //       }

// // // //       autoTable(doc, {
// // // //         startY: 85,
// // // //         head: [headers],
// // // //         body: data.map(r => Object.values(r)),
// // // //         theme: "grid",
// // // //         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
// // // //         styles: { fontSize: 7, halign: 'center' },
// // // //       });

// // // //       doc.save("Student_Report.pdf");
// // // //     } catch (err) { alert("PDF Error"); }
// // // //     finally { setExportOpen(false); setCustomExportModal(false); }
// // // //   };

// // // //   const exportExcel = () => {
// // // //     const { data } = getExportData();
// // // //     if (!data.length) return alert("No rows to export.");
// // // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // // //     const workbook = XLSX.utils.book_new();
// // // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // // //     setExportOpen(false);
// // // //     setCustomExportModal(false);
// // // //   };

// // // //   const handleDefaultExport = (format) => {
// // // //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// // // //     setTimeout(() => {
// // // //         if(format === 'excel') exportExcel();
// // // //         if(format === 'pdf') exportPDF();
// // // //     }, 100);
// // // //   };

// // // //   /* ---------------- ACTIONS ---------------- */
// // // //   const saveEdit = async () => {
// // // //     try {
// // // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // // //       window.alert("Student profile updated successfully!");
// // // //       setEditStudent(null);
// // // //       fetchStudents();
// // // //     } catch (err) { window.alert("Failed to update student."); }
// // // //   };

// // // //   const handleStatusChange = async (student, newStatus) => {
// // // //     if (student.active_yn === "INACTIVE" && newStatus === "ACTIVE") {
// // // //       window.alert("YOU CANT MAKE THE STUDENT AS ACTIVE . CONTACT THE ADMIN");
// // // //       return;
// // // //     }
// // // //     if (newStatus === "INACTIVE") {
// // // //       setInactiveModal(student);
// // // //       setInactiveReason("");
// // // //     } else {
// // // //       try {
// // // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // // //         window.alert("Status set to ACTIVE!");
// // // //         fetchStudents();
// // // //       } catch (err) { window.alert("Error updating status."); }
// // // //     }
// // // //   };

// // // //   const confirmInactive = async () => {
// // // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // // //     try {
// // // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // // //       window.alert("Marked as INACTIVE successfully.");
// // // //       setInactiveModal(null);
// // // //       setInactiveReason("");
// // // //       fetchStudents();
// // // //     } catch (err) { window.alert("Error updating status."); }
// // // //   };

// // // //   return (
// // // //     <div className="container">
// // // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // // //         <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
// // // //           <img src={Logo} alt="RCF Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />
// // // //           <div>
// // // //             <h1 className="title">Student Management</h1>
// // // //             <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// // // //           </div>
// // // //         </div>

// // // //         <div className="export-menu-wrapper">
// // // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // // //             <Download size={18} /> Export <ChevronDown size={14} />
// // // //           </button>
// // // //           {exportOpen && (
// // // //             <div className="export-dropdown shadow-lg">
// // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// // // //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
// // // //               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
              
// // // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// // // //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// // // //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// // // //               </button>
// // // //             </div>
// // // //           )}
// // // //         </div>
// // // //       </div>

// // // //       {/* RESTORED FILTER BAR AND SEARCH BAR */}
// // // //       <div className="filter-bar">
// // // //         <div className="filter-item">
// // // //           <Filter className="input-icon" />
// // // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // // //             <option value="">All Cohorts</option>
// // // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // // //           </select>
// // // //         </div>
// // // //         <div className="filter-item">
// // // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // // //             <option value="">All Batches</option>
// // // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // // //           </select>
// // // //         </div>
// // // //         <div className="filter-item search-box">
// // // //           <Search className="input-icon" />
// // // //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // // //         </div>
// // // //       </div>

// // // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // // //         <table className="students-table">
// // // //           <thead>
// // // //             <tr>
// // // //               <th style={{ width: "45px" }}>SL NO</th>
// // // //               <th>Student Name</th>
// // // //               <th>Enrollment Number</th>
// // // //               <th>Contact No</th>
// // // //               <th>Cohort</th>
// // // //               <th>Batch</th> {/* RESTORED COLUMN */}
// // // //               <th>Status</th>
// // // //             </tr>
// // // //           </thead>
// // // //           <tbody>
// // // //             {filteredStudents.map((s, index) => (
// // // //               <tr key={s.student_id}>
// // // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // // //                 <td>
// // // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // // //                     <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // // //                     </div>
// // // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // // //                       <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // // //                         {s.student_name}
// // // //                       </button>
// // // //                       <button onClick={() => { setEditStudent(s); setEditForm({...s}); }} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // // //                     </div>
// // // //                   </div>
// // // //                 </td>
// // // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // // //                 <td>{s.contact_no1 || "—"}</td>
// // // //                 <td>{s.cohort_name}</td>
// // // //                 <td>{s.batch_name}</td> {/* RESTORED CELL */}
// // // //                 <td>
// // // //                   <select 
// // // //                     value={s.active_yn} 
// // // //                     onChange={(e) => handleStatusChange(s, e.target.value)} 
// // // //                     className={`status-select ${s.active_yn === 'ACTIVE' ? 'active' : 'inactive'}`}
// // // //                   >
// // // //                     <option value="ACTIVE">ACTIVE</option>
// // // //                     <option value="INACTIVE">INACTIVE</option>
// // // //                   </select>
// // // //                 </td>
// // // //               </tr>
// // // //             ))}
// // // //           </tbody>
// // // //         </table>
// // // //       </div>

// // // //       {/* CUSTOM EXPORT MODAL */}
// // // //       {customExportModal && (
// // // //         <div className="modal">
// // // //           <div className="modal-content medium">
// // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// // // //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// // // //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// // // //             </div>
// // // //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// // // //               {STUDENT_MASTER_FIELDS.map(field => (
// // // //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// // // //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// // // //                   {field.label}
// // // //                 </label>
// // // //               ))}
// // // //             </div>
// // // //             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
// // // //                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
// // // //                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// // // //             </div>
// // // //           </div>
// // // //         </div>
// // // //       )}

// // // //       {/* VIEW PROFILE MODAL */}
// // // //       {viewStudent && (
// // // //         <div className="modal">
// // // //           <div className="modal-content large">
// // // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
// // // //                <img src={Logo} alt="Logo" style={{ width: '50px' }} />
// // // //                <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>
// // // //             </div>
            
// // // //             <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>
// // // //               <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />
// // // //               </div>
// // // //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// // // //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// // // //             </div>

// // // //             <div className="profile-sections-container">
// // // //               {/* 1. PERSONAL DETAILS */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><User size={18} /> Personal Details</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
// // // //                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // // //                 </div>
// // // //               </div>

// // // //               {/* 2. ACADEMIC DETAILS */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><BookOpen size={18} /> Academic Details</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// // // //                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// // // //                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// // // //                 </div>
// // // //               </div>

// // // //               {/* 3. INACTIVE HISTORY */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>
// // // //                 <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>
// // // //                   {inactiveHistory.length > 0 ? (
// // // //                     inactiveHistory.map((h, i) => (
// // // //                       <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>
// // // //                         <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>
// // // //                           <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}
// // // //                         </div>
// // // //                         <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>
// // // //                       </div>
// // // //                     ))
// // // //                   ) : (
// // // //                     <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>
// // // //                   )}
// // // //                 </div>
// // // //               </div>

// // // //               {/* 4. CONTACT INFORMATION */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// // // //                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // // //                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// // // //                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// // // //                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// // // //                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // // //                 </div>
// // // //               </div>

// // // //               {/* 5. FAMILY DETAILS */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>Father:</strong> {viewStudent.father_name}</div>
// // // //                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
// // // //                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// // // //                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
// // // //                 </div>
// // // //               </div>

// // // //               {/* 6. INSTITUTE & TEACHER */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // // //                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // // //                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // // //                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// // // //                 </div>
// // // //               </div>

// // // //               {/* 7. OTHER DETAILS */}
// // // //               <div className="profile-section-block">
// // // //                 <h4 className="section-title"><MoreHorizontal size={18} /> Other Details</h4>
// // // //                 <div className="profile-grid">
// // // //                   <div><strong>SIM Name:</strong> <span style={{ fontWeight: 'bold' }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// // // //                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// // // //                 </div>
// // // //               </div>
// // // //             </div>
// // // //           </div>
// // // //         </div>
// // // //       )}

// // // //       {/* EDIT MODAL */}
// // // //       {editStudent && (
// // // //         <div className="modal">
// // // //           <div className="modal-content large">
// // // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student Details</h3>
// // // //             <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto' }}>
// // // //               {Object.keys(editForm).map((k) => {
// // // //                 if (['student_id', 'photo_link', 'batch_id', 'cohort_number', 'inactive_reason'].includes(k)) return null;
// // // //                 return (
// // // //                   <div className="form-group" key={k}>
// // // //                     <label style={{ textTransform: 'capitalize', fontWeight: '600' }}>{k.replace(/_/g, " ")}</label>
// // // //                     <input name={k} value={editForm[k] || ""} onChange={handleEditChange} className="form-input" />
// // // //                   </div>
// // // //                 )
// // // //               })}
// // // //             </div>
// // // //             <div className="modal-actions">
// // // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// // // //               <button className="btn primary" onClick={saveEdit}>Update Student</button>
// // // //             </div>
// // // //           </div>
// // // //         </div>
// // // //       )}

// // // //       {/* INACTIVE MODAL */}
// // // //       {inactiveModal && (
// // // //         <div className="modal">
// // // //           <div className="modal-content small">
// // // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// // // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
// // // //             <div className="modal-actions">
// // // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // // //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// // // //             </div>
// // // //           </div>
// // // //         </div>
// // // //       )}

// // // //       {/* FULL PHOTO VIEW */}
// // // //       {fullPhoto && (
// // // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// // // //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // //           </div>
// // // //         </div>
// // // //       )}

// // // //       <style>{`
// // // //         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
// // // //         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
// // // //         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
// // // //         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
// // // //         .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
// // // //         .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
// // // //         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
// // // //         .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
// // // //         .status-select.active { color: #16a34a; }
// // // //         .status-select.inactive { color: #dc2626; }
// // // //       `}</style>
// // // //     </div>
// // // //   );
// // // // }




// // // // / 22/12/2025
// // // // client/src/pages/Coordinator/StudentManagement.jsx
// // // import React, { useState, useEffect, useCallback } from "react";
// // // import axios from "axios";
// // // import "./BatchManagement.css";
// // // import {
// // //   Search,
// // //   Eye,
// // //   Edit,
// // //   X,
// // //   CheckCircle,
// // //   AlertTriangle,
// // //   Filter,
// // //   Download,
// // //   ChevronDown,
// // //   Phone,
// // //   User,
// // //   Mail,
// // //   MapPin,
// // //   BookOpen,
// // //   Settings,
// // //   ListChecks,
// // //   Lock,
// // //   Smartphone,
// // //   Briefcase,
// // //   History,
// // //   Calendar,
// // //   GraduationCap,
// // //   MoreHorizontal
// // // } from "lucide-react";
// // // import { useAuth } from "../../contexts/AuthContext";

// // // // --- EXPORT LOGIC IMPORTS ---
// // // import { jsPDF } from "jspdf";
// // // import autoTable from "jspdf-autotable";
// // // import * as XLSX from "xlsx";
// // // import Logo from "../../assets/RCF-PP.jpg";

// // // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // // All available fields for Custom Export
// // // const STUDENT_MASTER_FIELDS = [
// // //   { id: "sl_no", label: "SL NO" },
// // //   { id: "student_name", label: "Student Name" },
// // //   { id: "enr_id", label: "Enrollment ID" },
// // //   { id: "sim_name", label: "SIM Name" },
// // //   { id: "contact_no1", label: "Student Contact" },
// // //   { id: "contact_no2", label: "Parent Contact" },
// // //   { id: "student_email", label: "Student Email" },
// // //   { id: "student_email_password", label: "Email Password" },
// // //   { id: "parent_email", label: "Parent Email" },
// // //   { id: "gender", label: "Gender" },
// // //   { id: "father_name", label: "Father Name" },
// // //   { id: "father_occupation", label: "Father Occupation" },
// // //   { id: "mother_name", label: "Mother Name" },
// // //   { id: "mother_occupation", label: "Mother Occupation" },
// // //   { id: "home_address", label: "Home Address" },
// // //   { id: "current_institute", label: "Current Institute" },
// // //   { id: "previous_institute", label: "Previous Institute" },
// // //   { id: "teacher_name", label: "Teacher Name" },
// // //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// // //   { id: "recharge_status", label: "Recharge Status" },
// // //   { id: "sponsor", label: "Sponsor" },
// // //   { id: "active_yn", label: "Status" },
// // //   { id: "inactive_reason", label: "Inactive Reason" },
// // //   { id: "cohort_name", label: "Cohort" },
// // //   { id: "batch_name", label: "Batch" },
// // // ];

// // // export default function StudentManagement() {
// // //   const [fullPhoto, setFullPhoto] = useState(null);
// // //   const { user } = useAuth();
// // //   const token = user?.token;

// // //   const [cohorts, setCohorts] = useState([]);
// // //   const [batches, setBatches] = useState([]);
// // //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// // //   const [students, setStudents] = useState([]);
// // //   const [filteredStudents, setFilteredStudents] = useState([]);

// // //   const [searchQuery, setSearchQuery] = useState("");
// // //   const [statusFilter, setStatusFilter] = useState("all");
// // //   const [loading, setLoading] = useState(false);

// // //   const [viewStudent, setViewStudent] = useState(null);
// // //   const [inactiveHistory, setInactiveHistory] = useState([]);
// // //   const [editStudent, setEditStudent] = useState(null);
// // //   const [editForm, setEditForm] = useState({});

// // //   const [inactiveModal, setInactiveModal] = useState(null);
// // //   const [inactiveReason, setInactiveReason] = useState("");

// // //   // Export States
// // //   const [exportOpen, setExportOpen] = useState(false);
// // //   const [customExportModal, setCustomExportModal] = useState(false);
// // //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);

// // //   const axiosConfig = useCallback(() => ({
// // //     headers: { Authorization: `Bearer ${token}` },
// // //   }), [token]);

// // //   /* ---------------- FETCH DATA ---------------- */
// // //   const fetchStudents = useCallback(() => {
// // //     if (!token) return;
// // //     setLoading(true);
// // //     axios
// // //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params: { cohortNumber: formData.cohort, batchId: formData.batch } })
// // //       .then(({ data }) => {
// // //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// // //         setStudents(uniqueData || []);
// // //       })
// // //       .catch(() => setStudents([]))
// // //       .finally(() => setLoading(false));
// // //   }, [token, formData, axiosConfig]);

// // //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// // //   const fetchInactiveHistory = async (studentId) => {
// // //     try {
// // //       const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());
// // //       setInactiveHistory(data || []);
// // //     } catch (err) {
// // //       setInactiveHistory([]);
// // //     }
// // //   };

// // //   const handleOpenProfile = (student) => {
// // //     setViewStudent(student);
// // //     fetchInactiveHistory(student.student_id);
// // //   };

// // //   useEffect(() => {
// // //     if (!token) return;
// // //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// // //   }, [token, axiosConfig]);

// // //   useEffect(() => {
// // //     if (!token || !formData.cohort) { setBatches([]); return; }
// // //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// // //       .then(({ data }) => setBatches(data || []));
// // //   }, [token, formData.cohort, axiosConfig]);

// // //   /* ---------------- FILTER ---------------- */
// // //   useEffect(() => {
// // //     let f = [...students];
// // //     if (searchQuery.trim()) {
// // //       const q = searchQuery.toLowerCase();
// // //       f = f.filter((s) => 
// // //         s.student_name?.toLowerCase().includes(q) || 
// // //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// // //         s.sim_name?.toLowerCase().includes(q) || 
// // //         s.contact_no1?.includes(q)
// // //       );
// // //     }
// // //     if (statusFilter !== "all") {
// // //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// // //     }
// // //     setFilteredStudents(f);
// // //   }, [students, searchQuery, statusFilter]);

// // //   /* ---------------- EXPORT LOGIC ---------------- */
// // //   const toggleField = (id) => {
// // //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// // //   };

// // //   const getExportData = () => {
// // //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// // //     const rows = filteredStudents.map((s, index) => {
// // //       let row = {};
// // //       activeFields.forEach(field => {
// // //         if (field.id === "sl_no") {
// // //           row[field.label] = index + 1;
// // //         } else if (field.id === "gender") {
// // //           row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
// // //         } else {
// // //           row[field.label] = s[field.id] ?? "-";
// // //         }
// // //       });
// // //       return row;
// // //     });
// // //     return { data: rows, headers: activeFields.map(f => f.label) };
// // //   };

// // //   const exportPDF = async () => {
// // //     const { data, headers } = getExportData();
// // //     if (!data.length) return alert("No rows to export.");
// // //     try {
// // //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// // //       const pageWidth = doc.internal.pageSize.getWidth();

// // //       let logoDataUrl = null;
// // //       try {
// // //         const resp = await fetch(Logo);
// // //         const blob = await resp.blob();
// // //         logoDataUrl = await new Promise((res) => {
// // //           const reader = new FileReader();
// // //           reader.onloadend = () => res(reader.result);
// // //           reader.readAsDataURL(blob);
// // //         });
// // //       } catch (e) { console.warn("Logo load failed for PDF"); }

// // //       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
// // //       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";

// // //       doc.setFont("helvetica", "bold");
// // //       doc.setFontSize(16);
// // //       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
      
// // //       doc.setFontSize(12);
// // //       const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;
// // //       doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);

// // //       if (logoDataUrl) {
// // //         doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);
// // //       }

// // //       autoTable(doc, {
// // //         startY: 85,
// // //         head: [headers],
// // //         body: data.map(r => Object.values(r)),
// // //         theme: "grid",
// // //         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
// // //         styles: { fontSize: 7, halign: 'center' },
// // //       });

// // //       doc.save("Student_Report.pdf");
// // //     } catch (err) { alert("PDF Error"); }
// // //     finally { setExportOpen(false); setCustomExportModal(false); }
// // //   };

// // //   const exportExcel = () => {
// // //     const { data } = getExportData();
// // //     if (!data.length) return alert("No rows to export.");
// // //     const worksheet = XLSX.utils.json_to_sheet(data);
// // //     const workbook = XLSX.utils.book_new();
// // //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// // //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// // //     setExportOpen(false);
// // //     setCustomExportModal(false);
// // //   };

// // //   const handleDefaultExport = (format) => {
// // //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// // //     setTimeout(() => {
// // //         if(format === 'excel') exportExcel();
// // //         if(format === 'pdf') exportPDF();
// // //     }, 100);
// // //   };

// // //   /* ---------------- ACTIONS ---------------- */
  
// // //   // ADDED: The missing handleEditChange function
// // //   const handleEditChange = (e) => {
// // //     const { name, value } = e.target;
// // //     setEditForm((prev) => ({
// // //       ...prev,
// // //       [name]: value,
// // //     }));
// // //   };

// // //   const saveEdit = async () => {
// // //     try {
// // //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());
// // //       window.alert("Student profile updated successfully!");
// // //       setEditStudent(null);
// // //       fetchStudents();
// // //     } catch (err) { window.alert("Failed to update student."); }
// // //   };

// // //   const handleStatusChange = async (student, newStatus) => {
// // //     if (student.active_yn === "INACTIVE" && newStatus === "ACTIVE") {
// // //       window.alert("YOU CANT MAKE THE STUDENT AS ACTIVE . CONTACT THE ADMIN");
// // //       return;
// // //     }
// // //     if (newStatus === "INACTIVE") {
// // //       setInactiveModal(student);
// // //       setInactiveReason("");
// // //     } else {
// // //       try {
// // //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// // //         window.alert("Status set to ACTIVE!");
// // //         fetchStudents();
// // //       } catch (err) { window.alert("Error updating status."); }
// // //     }
// // //   };

// // //   const confirmInactive = async () => {
// // //     if (!inactiveReason.trim()) return alert("Enter reason");
// // //     try {
// // //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// // //       window.alert("Marked as INACTIVE successfully.");
// // //       setInactiveModal(null);
// // //       setInactiveReason("");
// // //       fetchStudents();
// // //     } catch (err) { window.alert("Error updating status."); }
// // //   };

// // //   return (
// // //     <div className="container">
// // //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// // //         <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
// // //           <img src={Logo} alt="RCF Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />
// // //           <div>
// // //             <h1 className="title">Student Management</h1>
// // //             <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// // //           </div>
// // //         </div>

// // //         <div className="export-menu-wrapper">
// // //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// // //             <Download size={18} /> Export <ChevronDown size={14} />
// // //           </button>
// // //           {exportOpen && (
// // //             <div className="export-dropdown shadow-lg">
// // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// // //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
// // //               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
              
// // //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// // //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// // //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// // //               </button>
// // //             </div>
// // //           )}
// // //         </div>
// // //       </div>

// // //       <div className="filter-bar">
// // //         <div className="filter-item">
// // //           <Filter className="input-icon" />
// // //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// // //             <option value="">All Cohorts</option>
// // //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// // //           </select>
// // //         </div>
// // //         <div className="filter-item">
// // //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// // //             <option value="">All Batches</option>
// // //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// // //           </select>
// // //         </div>
// // //         <div className="filter-item search-box">
// // //           <Search className="input-icon" />
// // //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// // //         </div>
// // //       </div>

// // //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// // //         <table className="students-table">
// // //           <thead>
// // //             <tr>
// // //               <th style={{ width: "45px" }}>SL NO</th>
// // //               <th>Student Name</th>
// // //               <th>Enrollment Number</th>
// // //               <th>Contact No</th>
// // //               <th>Cohort</th>
// // //               <th>Batch</th>
// // //               <th>Status</th>
// // //             </tr>
// // //           </thead>
// // //           <tbody>
// // //             {filteredStudents.map((s, index) => (
// // //               <tr key={s.student_id}>
// // //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// // //                 <td>
// // //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// // //                     <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// // //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// // //                     </div>
// // //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// // //                       <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// // //                         {s.student_name}
// // //                       </button>
// // //                       <button onClick={() => { setEditStudent(s); setEditForm({...s}); }} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// // //                     </div>
// // //                   </div>
// // //                 </td>
// // //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// // //                 <td>{s.contact_no1 || "—"}</td>
// // //                 <td>{s.cohort_name}</td>
// // //                 <td>{s.batch_name}</td>
// // //                 <td>
// // //                   <select 
// // //                     value={s.active_yn} 
// // //                     onChange={(e) => handleStatusChange(s, e.target.value)} 
// // //                     className={`status-select ${s.active_yn === 'ACTIVE' ? 'active' : 'inactive'}`}
// // //                   >
// // //                     <option value="ACTIVE">ACTIVE</option>
// // //                     <option value="INACTIVE">INACTIVE</option>
// // //                   </select>
// // //                 </td>
// // //               </tr>
// // //             ))}
// // //           </tbody>
// // //         </table>
// // //       </div>

// // //       {/* CUSTOM EXPORT MODAL */}
// // //       {customExportModal && (
// // //         <div className="modal">
// // //           <div className="modal-content medium">
// // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// // //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// // //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// // //             </div>
// // //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// // //               {STUDENT_MASTER_FIELDS.map(field => (
// // //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// // //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// // //                   {field.label}
// // //                 </label>
// // //               ))}
// // //             </div>
// // //             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
// // //                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
// // //                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       )}

// // //       {/* VIEW PROFILE MODAL */}
// // //       {viewStudent && (
// // //         <div className="modal">
// // //           <div className="modal-content large">
// // //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
// // //                <img src={Logo} alt="Logo" style={{ width: '50px' }} />
// // //                <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>
// // //             </div>
            
// // //             <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>
// // //               <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// // //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />
// // //               </div>
// // //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// // //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// // //             </div>

// // //             <div className="profile-sections-container">
// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><User size={18} /> Personal Details</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
// // //                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><BookOpen size={18} /> Academic Details</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// // //                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// // //                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>
// // //                 <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>
// // //                   {inactiveHistory.length > 0 ? (
// // //                     inactiveHistory.map((h, i) => (
// // //                       <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>
// // //                         <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>
// // //                           <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}
// // //                         </div>
// // //                         <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>
// // //                       </div>
// // //                     ))
// // //                   ) : (
// // //                     <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>
// // //                   )}
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// // //                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// // //                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// // //                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// // //                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// // //                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>Father:</strong> {viewStudent.father_name}</div>
// // //                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
// // //                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// // //                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>
// // //                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>
// // //                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// // //                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// // //                 </div>
// // //               </div>

// // //               <div className="profile-section-block">
// // //                 <h4 className="section-title"><MoreHorizontal size={18} /> Other Details</h4>
// // //                 <div className="profile-grid">
// // //                   <div><strong>SIM Name:</strong> <span style={{ fontWeight: 'bold' }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// // //                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// // //                 </div>
// // //               </div>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       )}

// // //       {/* EDIT MODAL */}
// // //       {editStudent && (
// // //         <div className="modal">
// // //           <div className="modal-content large">
// // //             <button className="close-btn" onClick={() => setEditStudent(null)}><X size={18} /></button>
// // //             <h3 className="modal-title"><Edit className="inline w-5 h-5 mr-1 text-amber-600" /> Edit Student Details</h3>
// // //             <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto' }}>
// // //               {Object.keys(editForm).map((k) => {
// // //                 // Filter out non-editable or internal technical fields
// // //                 if (['student_id', 'photo_link', 'batch_id', 'cohort_number', 'inactive_reason', 'batch_name', 'cohort_name', 'created_at', 'updated_at'].includes(k)) return null;
// // //                 return (
// // //                   <div className="form-group" key={k}>
// // //                     <label style={{ textTransform: 'capitalize', fontWeight: '600' }}>{k.replace(/_/g, " ")}</label>
// // //                     <input name={k} value={editForm[k] || ""} onChange={handleEditChange} className="form-input" />
// // //                   </div>
// // //                 )
// // //               })}
// // //             </div>
// // //             <div className="modal-actions">
// // //               <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// // //               <button className="btn primary" onClick={saveEdit}>Update Student</button>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       )}

// // //       {/* INACTIVE MODAL */}
// // //       {inactiveModal && (
// // //         <div className="modal">
// // //           <div className="modal-content small">
// // //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// // //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
// // //             <div className="modal-actions">
// // //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// // //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       )}

// // //       {/* FULL PHOTO VIEW */}
// // //       {fullPhoto && (
// // //         <div className="modal" onClick={() => setFullPhoto(null)}>
// // //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// // //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // //           </div>
// // //         </div>
// // //       )}

// // //       <style>{`
// // //         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
// // //         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
// // //         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
// // //         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
// // //         .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
// // //         .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
// // //         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
// // //         .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
// // //         .status-select.active { color: #16a34a; }
// // //         .status-select.inactive { color: #dc2626; }
// // //       `}</style>
// // //     </div>
// // //   );
// // // }



// // // / 22/12/2025
// // // client/src/pages/Coordinator/StudentManagement.jsx
// // import React, { useState, useEffect, useCallback } from "react";
// // import axios from "axios";
// // import "./BatchManagement.css";
// // import {
// //   Search,
// //   Eye,
// //   Edit,
// //   X,
// //   CheckCircle,
// //   AlertTriangle,
// //   Filter,
// //   Download,
// //   ChevronDown,
// //   Phone,
// //   User,
// //   Mail,
// //   MapPin,
// //   BookOpen,
// //   Settings,
// //   ListChecks,
// //   Lock,
// //   Smartphone,
// //   Briefcase,
// //   History,
// //   Calendar,
// //   GraduationCap,
// //   MoreHorizontal,
// //   ArrowRight,
// //   Loader2
// // } from "lucide-react";
// // import { useAuth } from "../../contexts/AuthContext";

// // // --- EXPORT LOGIC IMPORTS ---
// // import { jsPDF } from "jspdf";
// // import autoTable from "jspdf-autotable";
// // import * as XLSX from "xlsx";
// // import Logo from "../../assets/RCF-PP.jpg";

// // const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

// // // All available fields for Custom Export
// // const STUDENT_MASTER_FIELDS = [
// //   { id: "sl_no", label: "SL NO" },
// //   { id: "student_name", label: "Student Name" },
// //   { id: "enr_id", label: "Enrollment ID" },
// //   { id: "sim_name", label: "SIM Name" },
// //   { id: "contact_no1", label: "Student Contact" },
// //   { id: "contact_no2", label: "Parent Contact" },
// //   { id: "student_email", label: "Student Email" },
// //   { id: "student_email_password", label: "Email Password" },
// //   { id: "parent_email", label: "Parent Email" },
// //   { id: "gender", label: "Gender" },
// //   { id: "father_name", label: "Father Name" },
// //   { id: "father_occupation", label: "Father Occupation" },
// //   { id: "mother_name", label: "Mother Name" },
// //   { id: "mother_occupation", label: "Mother Occupation" },
// //   { id: "home_address", label: "Home Address" },
// //   { id: "current_institute_dise_code", label: "Current Institute (DISE)" },
// //   { id: "previous_institute_dise_code", label: "Previous Institute (DISE)" },
// //   { id: "teacher_name", label: "Teacher Name" },
// //   { id: "teacher_mobile_number", label: "Teacher Mobile" },
// //   { id: "recharge_status", label: "Recharge Status" },
// //   { id: "sponsor", label: "Sponsor" },
// //   { id: "active_yn", label: "Status" },
// //   { id: "inactive_reason", label: "Inactive Reason" },
// //   { id: "cohort_name", label: "Cohort" },
// //   { id: "batch_name", label: "Batch" },
// // ];

// // export default function StudentManagement() {
// //   const [fullPhoto, setFullPhoto] = useState(null);
// //   const { user } = useAuth();
// //   const token = user?.token;

// //   const [cohorts, setCohorts] = useState([]);
// //   const [batches, setBatches] = useState([]);
// //   const [formData, setFormData] = useState({ cohort: "", batch: "" });
// //   const [students, setStudents] = useState([]);
// //   const [filteredStudents, setFilteredStudents] = useState([]);

// //   const [searchQuery, setSearchQuery] = useState("");
// //   const [statusFilter, setStatusFilter] = useState("all");
// //   const [loading, setLoading] = useState(false);

// //   const [viewStudent, setViewStudent] = useState(null);
// //   const [inactiveHistory, setInactiveHistory] = useState([]);
// //   const [editStudent, setEditStudent] = useState(null);
// //   const [editForm, setEditForm] = useState({});

// //   // Async search for 2 Lakh+ records
// //   const [instSearch, setInstSearch] = useState("");
// //   const [instOptions, setInstOptions] = useState([]);
// //   const [isSearchingInst, setIsSearchingInst] = useState(false);

// //   const [showCommitConfirm, setShowCommitConfirm] = useState(false);
// //   const [changesSummary, setChangesSummary] = useState([]);

// //   const [inactiveModal, setInactiveModal] = useState(null);
// //   const [inactiveReason, setInactiveReason] = useState("");

// //   // RESTORED: Export States
// //   const [exportOpen, setExportOpen] = useState(false);
// //   const [customExportModal, setCustomExportModal] = useState(false);
// //   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);

// //   const axiosConfig = useCallback(() => ({
// //     headers: { Authorization: `Bearer ${token}` },
// //   }), [token]);

// //   /* ---------------- INSTITUTE SEARCH (DEBOUNCED) ---------------- */
// //   useEffect(() => {
// //     if (instSearch.length < 3 || instSearch.includes(" | ")) {
// //       setInstOptions([]);
// //       return;
// //     }
// //     const timer = setTimeout(async () => {
// //       setIsSearchingInst(true);
// //       try {
// //         const { data } = await axios.get(`${BACKEND}/api/coordinator/institutes/search`, {
// //           ...axiosConfig(),
// //           params: { q: instSearch }
// //         });
// //         setInstOptions(data || []);
// //       } catch (e) { console.error("Search error"); }
// //       finally { setIsSearchingInst(false); }
// //     }, 400);
// //     return () => clearTimeout(timer);
// //   }, [instSearch, axiosConfig]);

// //   /* ---------------- FETCH DATA ---------------- */
// //   const fetchStudents = useCallback(() => {
// //     if (!token) return;
// //     setLoading(true);
// //     axios
// //       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params: { cohortNumber: formData.cohort, batchId: formData.batch } })
// //       .then(({ data }) => {
// //         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
// //         setStudents(uniqueData || []);
// //       })
// //       .catch(() => setStudents([]))
// //       .finally(() => setLoading(false));
// //   }, [token, formData, axiosConfig]);

// //   useEffect(() => { fetchStudents(); }, [fetchStudents]);

// //   const fetchInactiveHistory = async (studentId) => {
// //     try {
// //       const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());
// //       setInactiveHistory(data || []);
// //     } catch (err) { setInactiveHistory([]); }
// //   };

// //   const handleOpenProfile = (student) => {
// //     setViewStudent(student);
// //     fetchInactiveHistory(student.student_id);
// //   };

// //   useEffect(() => {
// //     if (!token) return;
// //     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
// //   }, [token, axiosConfig]);

// //   useEffect(() => {
// //     if (!token || !formData.cohort) { setBatches([]); return; }
// //     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
// //       .then(({ data }) => setBatches(data || []));
// //   }, [token, formData.cohort, axiosConfig]);

// //   /* ---------------- FILTER ---------------- */
// //   useEffect(() => {
// //     let f = [...students];
// //     if (searchQuery.trim()) {
// //       const q = searchQuery.toLowerCase();
// //       f = f.filter((s) => 
// //         s.student_name?.toLowerCase().includes(q) || 
// //         String(s.enr_id ?? "").toLowerCase().includes(q) ||
// //         s.sim_name?.toLowerCase().includes(q) || 
// //         s.contact_no1?.includes(q)
// //       );
// //     }
// //     if (statusFilter !== "all") {
// //       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
// //     }
// //     setFilteredStudents(f);
// //   }, [students, searchQuery, statusFilter]);

// //   /* ---------------- EXPORT LOGIC (RESTORED) ---------------- */
// //   const toggleField = (id) => {
// //     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
// //   };

// //   const getExportData = () => {
// //     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
// //     const rows = filteredStudents.map((s, index) => {
// //       let row = {};
// //       activeFields.forEach(field => {
// //         if (field.id === "sl_no") row[field.label] = index + 1;
// //         else if (field.id === "gender") row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
// //         else row[field.label] = s[field.id] ?? "-";
// //       });
// //       return row;
// //     });
// //     return { data: rows, headers: activeFields.map(f => f.label) };
// //   };

// //   const exportPDF = async () => {
// //     const { data, headers } = getExportData();
// //     if (!data.length) return alert("No rows to export.");
// //     try {
// //       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
// //       const pageWidth = doc.internal.pageSize.getWidth();
// //       let logoDataUrl = null;
// //       try {
// //         const resp = await fetch(Logo);
// //         const blob = await resp.blob();
// //         logoDataUrl = await new Promise((res) => {
// //           const reader = new FileReader();
// //           reader.onloadend = () => res(reader.result);
// //           reader.readAsDataURL(blob);
// //         });
// //       } catch (e) { console.warn("Logo fail"); }

// //       doc.setFont("helvetica", "bold"); doc.setFontSize(16);
// //       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
// //       autoTable(doc, {
// //         startY: 85, head: [headers], body: data.map(r => Object.values(r)), theme: "grid",
// //         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
// //         styles: { fontSize: 7, halign: 'center' },
// //       });
// //       doc.save("Student_Report.pdf");
// //     } catch (err) { alert("PDF Error"); }
// //     finally { setExportOpen(false); setCustomExportModal(false); }
// //   };

// //   const exportExcel = () => {
// //     const { data } = getExportData();
// //     if (!data.length) return alert("No rows to export.");
// //     const worksheet = XLSX.utils.json_to_sheet(data);
// //     const workbook = XLSX.utils.book_new();
// //     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
// //     XLSX.writeFile(workbook, "Student_Report.xlsx");
// //     setExportOpen(false); setCustomExportModal(false);
// //   };

// //   const handleDefaultExport = (format) => {
// //     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
// //     setTimeout(() => {
// //         if(format === 'excel') exportExcel();
// //         if(format === 'pdf') exportPDF();
// //     }, 100);
// //   };

// //   /* ---------------- ACTIONS ---------------- */
// //   const handleEditChange = (e) => {
// //     const { name, value } = e.target;
// //     setEditForm((prev) => ({ ...prev, [name]: value }));
// //   };

// //   const handleReviewChanges = () => {
// //     const summary = [];
// //     Object.keys(editForm).forEach(key => {
// //       if (editForm[key] !== editStudent[key]) {
// //         const ignore = ['updated_at', 'created_at', 'batch_name', 'cohort_name', 'applicant_id', 'previous_institute_dise_code', 'current_institute', 'previous_institute'];
// //         if (!ignore.includes(key)) {
// //           summary.push({
// //             field: key === 'student_id' ? 'APPLICANT ID' : key.replace(/_dise_code/g, "").replace(/_/g, " ").toUpperCase(),
// //             from: editStudent[key] || "—",
// //             to: editForm[key] || "—"
// //           });
// //         }
// //       }
// //     });
// //     if (summary.length === 0) return window.alert("No changes detected to update.");
// //     setChangesSummary(summary);
// //     setShowCommitConfirm(true);
// //   };

// //   /* ===========================================================
// //      SAVE EDIT WITH AUTOMATIC HISTORY SHIFTING
// //      =========================================================== */
// //   const saveEdit = async () => {
// //     try {
// //       const cleanedData = { ...editForm };
      
// //       // LOGIC: Shift current institute to previous column if school is updated
// //       if (editForm.current_institute_dise_code !== editStudent.current_institute_dise_code) {
// //         cleanedData.previous_institute_dise_code = editStudent.current_institute_dise_code;
// //       }

// //       // Remove non-database fields to avoid SQL "column does not exist" errors
// //       const fieldsToRemove = ['current_institute', 'previous_institute', 'batch_name', 'cohort_name', 'cohort_number', 'inactive_reason', 'created_at', 'updated_at'];
// //       fieldsToRemove.forEach(f => delete cleanedData[f]);

// //       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, cleanedData, axiosConfig());
// //       window.alert("Student profile updated successfully!");
// //       setEditStudent(null);
// //       setShowCommitConfirm(false);
// //       fetchStudents();
// //     } catch (err) { window.alert("Failed to update student profile."); }
// //   };

// //   const handleStatusChange = async (student, newStatus) => {
// //     if (student.active_yn === "INACTIVE" && newStatus === "ACTIVE") {
// //       window.alert("YOU CANT MAKE THE STUDENT AS ACTIVE . CONTACT THE ADMIN");
// //       return;
// //     }
// //     if (newStatus === "INACTIVE") {
// //       setInactiveModal(student);
// //       setInactiveReason("");
// //     } else {
// //       try {
// //         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
// //         fetchStudents();
// //       } catch (err) { window.alert("Error updating status."); }
// //     }
// //   };

// //   const confirmInactive = async () => {
// //     if (!inactiveReason.trim()) return alert("Enter reason");
// //     try {
// //       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
// //       setInactiveModal(null); setInactiveReason(""); fetchStudents();
// //     } catch (err) { window.alert("Error."); }
// //   };

// //   return (
// //     <div className="container">
// //       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
// //         <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
// //           <img src={Logo} alt="Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />
// //           <div>
// //             <h1 className="title">Student Management</h1>
// //             <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
// //           </div>
// //         </div>

// //         <div className="export-menu-wrapper">
// //           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
// //             <Download size={18} /> Export <ChevronDown size={14} />
// //           </button>
// //           {exportOpen && (
// //             <div className="export-dropdown shadow-lg">
// //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
// //               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
// //               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
              
// //               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
// //               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
// //                 <Settings size={14} className="inline mr-2" /> Custom Master Export
// //               </button>
// //             </div>
// //           )}
// //         </div>
// //       </div>

// //       <div className="filter-bar">
// //         <div className="filter-item">
// //           <Filter className="input-icon" />
// //           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
// //             <option value="">All Cohorts</option>
// //             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
// //           </select>
// //         </div>
// //         <div className="filter-item">
// //           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
// //             <option value="">All Batches</option>
// //             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
// //           </select>
// //         </div>
// //         <div className="filter-item search-box">
// //           <Search className="input-icon" />
// //           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
// //         </div>
// //       </div>

// //       <div className="table-wrapper shadow-md rounded-lg bg-white">
// //         <table className="students-table">
// //           <thead>
// //             <tr>
// //               <th style={{ width: "45px" }}>SL NO</th>
// //               <th>Student Name</th>
// //               <th>Enrollment Number</th>
// //               <th>Contact No</th>
// //               <th>Cohort</th>
// //               <th>Batch</th>
// //               <th>Status</th>
// //             </tr>
// //           </thead>
// //           <tbody>
// //             {filteredStudents.map((s, index) => (
// //               <tr key={s.student_id}>
// //                 <td style={{ textAlign: 'center' }}>{index + 1}</td>
// //                 <td>
// //                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
// //                     <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
// //                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
// //                     </div>
// //                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
// //                       <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
// //                         {s.student_name}
// //                       </button>
// //                       <button onClick={() => { setEditStudent(s); setEditForm({...s}); setInstSearch(""); setShowCommitConfirm(false); }} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
// //                     </div>
// //                   </div>
// //                 </td>
// //                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
// //                 <td>{s.contact_no1 || "—"}</td>
// //                 <td>{s.cohort_name}</td>
// //                 <td>{s.batch_name}</td>
// //                 <td>
// //                   <select 
// //                     value={s.active_yn} 
// //                     onChange={(e) => handleStatusChange(s, e.target.value)} 
// //                     className={`status-select ${s.active_yn === 'ACTIVE' ? 'active' : 'inactive'}`}
// //                   >
// //                     <option value="ACTIVE">ACTIVE</option>
// //                     <option value="INACTIVE">INACTIVE</option>
// //                   </select>
// //                 </td>
// //               </tr>
// //             ))}
// //           </tbody>
// //         </table>
// //       </div>

// //       {/* CUSTOM EXPORT MODAL (RESTORED) */}
// //       {customExportModal && (
// //         <div className="modal">
// //           <div className="modal-content medium">
// //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
// //               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
// //               <button onClick={() => setCustomExportModal(false)}><X /></button>
// //             </div>
// //             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
// //               {STUDENT_MASTER_FIELDS.map(field => (
// //                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
// //                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
// //                   {field.label}
// //                 </label>
// //               ))}
// //             </div>
// //             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
// //                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
// //                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
// //             </div>
// //           </div>
// //         </div>
// //       )}

// //       {/* VIEW PROFILE MODAL (DISE IN BRACKETS) */}
// //       {viewStudent && (
// //         <div className="modal">
// //           <div className="modal-content large">
// //             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
// //                <img src={Logo} alt="Logo" style={{ width: '50px' }} />
// //                <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>
// //             </div>
            
// //             <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>
// //               <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
// //                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />
// //               </div>
// //               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
// //               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
// //             </div>

// //             <div className="profile-sections-container">
// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><User size={18} /> Personal Details</h4>
// //                 <div className="profile-grid">
// //                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
// //                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><BookOpen size={18} /> Academic Details</h4>
// //                 <div className="profile-grid">
// //                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
// //                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
// //                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>
// //                 <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>
// //                   {inactiveHistory.length > 0 ? (
// //                     inactiveHistory.map((h, i) => (
// //                       <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>
// //                         <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>
// //                           <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}
// //                         </div>
// //                         <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>
// //                       </div>
// //                     ))
// //                   ) : (
// //                     <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>
// //                   )}
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
// //                 <div className="profile-grid">
// //                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
// //                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
// //                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
// //                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
// //                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
// //                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
// //                 <div className="profile-grid">
// //                   <div><strong>Father:</strong> {viewStudent.father_name}</div>
// //                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
// //                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
// //                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
// //                 <div className="profile-grid">
// //                   {/* UPDATED: Bracketed DISE Code */}
// //                   <div><strong>Current Institute:</strong> {viewStudent.current_institute} ({viewStudent.current_institute_dise_code || "N/A"})</div>
// //                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute} ({viewStudent.previous_institute_dise_code || "N/A"})</div>
// //                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
// //                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
// //                 </div>
// //               </div>

// //               <div className="profile-section-block">
// //                 <h4 className="section-title"><MoreHorizontal size={18} /> Other Details</h4>
// //                 <div className="profile-grid">
// //                   <div><strong>SIM Name:</strong> <span style={{ fontWeight: 'bold' }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
// //                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
// //                 </div>
// //               </div>
// //             </div>
// //           </div>
// //         </div>
// //       )}

// //       {/* EDIT MODAL WITH ASYNC SEARCH VISIBILITY FIX */}
// //       {editStudent && (
// //         <div className="modal">
// //           <div className="modal-content large">
// //             <button className="close-btn" onClick={() => { setEditStudent(null); setShowCommitConfirm(false); }}><X size={18} /></button>
// //             <h3 className="modal-title">{showCommitConfirm ? "Review Changes" : "Edit Student Details"}</h3>
// //             {!showCommitConfirm ? (
// //               <>
// //                 <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto' }}>
// //                   {Object.keys(editForm).map((k) => {
// //                     if (['applicant_id', 'photo_link', 'batch_id', 'cohort_number', 'inactive_reason', 'batch_name', 'cohort_name', 'created_at', 'updated_at', 'previous_institute_dise_code', 'current_institute', 'previous_institute'].includes(k)) return null;
// //                     const isLocked = ['student_id', 'enr_id', 'student_email', 'student_email_password', 'parent_email', 'student_name', 'sponsor', 'active_yn'].includes(k);

// //                     if (k === 'current_institute_dise_code') {
// //                       return (
// //                         <div className="form-group" key={k} style={{ gridColumn: 'span 2', position: 'relative' }}>
// //                           <label style={{ fontWeight: '600' }}><GraduationCap size={14} className="inline mr-1"/> Current Institute Search</label>
// //                           <div style={{ position: 'relative' }}>
// //                             <input type="text" className="form-input" placeholder="Type to search..." value={instSearch} onChange={(e) => setInstSearch(e.target.value)} />
// //                             {isSearchingInst && <Loader2 className="animate-spin" size={16} style={{ position: 'absolute', right: '10px', top: '10px' }} />}
// //                           </div>
// //                           {instOptions.length > 0 && (
// //                             <div className="inst-search-results">
// //                               {instOptions.map(inst => (
// //                                 <div key={inst.dise_code} className="inst-item" onClick={() => {
// //                                     setEditForm(prev => ({ ...prev, current_institute_dise_code: inst.dise_code }));
// //                                     setInstSearch(`${inst.dise_code} | ${inst.institute_name}`);
// //                                     setInstOptions([]);
// //                                   }}>
// //                                   <strong>{inst.dise_code}</strong> | {inst.institute_name}
// //                                 </div>
// //                               ))}
// //                             </div>
// //                           )}
// //                         </div>
// //                       );
// //                     }
// //                     return (
// //                       <div className="form-group" key={k}>
// //                         <label style={{ textTransform: 'capitalize', fontWeight: '600' }}>{k === 'student_id' ? 'Applicant ID' : k.replace(/_/g, " ")} {isLocked && <Lock size={12} className="text-gray-400" />}</label>
// //                         <input name={k} value={editForm[k] || ""} onChange={handleEditChange} readOnly={isLocked} className={`form-input ${isLocked ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`} />
// //                       </div>
// //                     )
// //                   })}
// //                 </div>
// //                 <div className="modal-actions">
// //                   <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
// //                   <button className="btn primary" onClick={handleReviewChanges}>Review Changes</button>
// //                 </div>
// //               </>
// //             ) : (
// //               <div className="commit-preview-container">
// //                 <div className="change-list shadow-inner" style={{ background: '#f8fafc', borderRadius: '8px', padding: '15px' }}>
// //                     {changesSummary.map((c, i) => (
// //                         <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #e2e8f0' }}>
// //                             <span style={{ fontWeight: 'bold' }}>{c.field}</span>
// //                             <div style={{ textAlign: 'right' }}>
// //                                 <span style={{ color: '#ef4444', textDecoration: 'line-through' }}>{c.from}</span>
// //                                 <ArrowRight size={14} className="mx-2 inline text-gray-400" />
// //                                 <span style={{ color: '#059669', fontWeight: 'bold' }}>{c.to}</span>
// //                             </div>
// //                         </div>
// //                     ))}
// //                 </div>
// //                 <div className="modal-actions" style={{ marginTop: '20px' }}>
// //                   <button className="btn secondary" onClick={() => setShowCommitConfirm(false)}>Back</button>
// //                   <button className="btn primary" onClick={saveEdit} style={{ background: '#059669' }}>Confirm & Commit Changes</button>
// //                 </div>
// //               </div>
// //             )}
// //           </div>
// //         </div>
// //       )}

// //       {/* INACTIVE MODAL */}
// //       {inactiveModal && (
// //         <div className="modal">
// //           <div className="modal-content small">
// //             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
// //             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Reason..." className="w-full border p-2 rounded" />
// //             <div className="modal-actions">
// //               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
// //               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
// //             </div>
// //           </div>
// //         </div>
// //       )}

// //       {/* FULL PHOTO VIEW */}
// //       {fullPhoto && (
// //         <div className="modal" onClick={() => setFullPhoto(null)}>
// //           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
// //             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
// //           </div>
// //         </div>
// //       )}

// //       <style>{`
// //         /* FIXED: Dropdown sits below search input and doesn't hide it */
// //         .inst-search-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; background: white; max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-top: 5px; }
// //         .inst-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
// //         .inst-item:hover { background-color: #f8fafc; color: #2563eb; }
// //         .animate-spin { animation: spin 1s linear infinite; }
// //         @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
// //         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
// //         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
// //         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
// //         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
// //         .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
// //         .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
// //         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
// //         .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
// //         .status-select.active { color: #16a34a; }
// //         .status-select.inactive { color: #dc2626; }
// //       `}</style>
// //     </div>
// //   );
// // }




// // / 22/12/2025

// // client/src/pages/Coordinator/StudentManagement.jsx

// import React, { useState, useEffect, useCallback } from "react";

// import axios from "axios";

// import "./BatchManagement.css";

// import {

//   Search,

//   Eye,

//   Edit,

//   X,

//   CheckCircle,

//   AlertTriangle,

//   Filter,

//   Download,

//   ChevronDown,

//   Phone,

//   User,

//   Mail,

//   MapPin,

//   BookOpen,

//   Settings,

//   ListChecks,

//   Lock,

//   Smartphone,

//   Briefcase,

//   History,

//   Calendar,

//   GraduationCap,

//   MoreHorizontal,

//   ArrowRight

// } from "lucide-react";

// import { useAuth } from "../../contexts/AuthContext";



// // --- EXPORT LOGIC IMPORTS ---

// import { jsPDF } from "jspdf";

// import autoTable from "jspdf-autotable";

// import * as XLSX from "xlsx";

// import Logo from "../../assets/RCF-PP.jpg";



// const BACKEND = process.env.REACT_APP_BACKEND_API_URL;



// // All available fields for Custom Export

// const STUDENT_MASTER_FIELDS = [

//   { id: "sl_no", label: "SL NO" },

//   { id: "student_name", label: "Student Name" },

//   { id: "enr_id", label: "Enrollment ID" },

//   { id: "sim_name", label: "SIM Name" },

//   { id: "contact_no1", label: "Student Contact" },

//   { id: "contact_no2", label: "Parent Contact" },

//   { id: "student_email", label: "Student Email" },

//   { id: "student_email_password", label: "Email Password" },

//   { id: "parent_email", label: "Parent Email" },

//   { id: "gender", label: "Gender" },

//   { id: "father_name", label: "Father Name" },

//   { id: "father_occupation", label: "Father Occupation" },

//   { id: "mother_name", label: "Mother Name" },

//   { id: "mother_occupation", label: "Mother Occupation" },

//   { id: "home_address", label: "Home Address" },

//   { id: "current_institute", label: "Current Institute" },

//   { id: "previous_institute", label: "Previous Institute" },

//   { id: "teacher_name", label: "Teacher Name" },

//   { id: "teacher_mobile_number", label: "Teacher Mobile" },

//   { id: "recharge_status", label: "Recharge Status" },

//   { id: "sponsor", label: "Sponsor" },

//   { id: "active_yn", label: "Status" },

//   { id: "inactive_reason", label: "Inactive Reason" },

//   { id: "cohort_name", label: "Cohort" },

//   { id: "batch_name", label: "Batch" },

// ];



// export default function StudentManagement() {

//   const [fullPhoto, setFullPhoto] = useState(null);

//   const { user } = useAuth();

//   const token = user?.token;



//   const [cohorts, setCohorts] = useState([]);

//   const [batches, setBatches] = useState([]);

//   const [formData, setFormData] = useState({ cohort: "", batch: "" });

//   const [students, setStudents] = useState([]);

//   const [filteredStudents, setFilteredStudents] = useState([]);



//   const [searchQuery, setSearchQuery] = useState("");

//   const [statusFilter, setStatusFilter] = useState("all");

//   const [loading, setLoading] = useState(false);



//   const [viewStudent, setViewStudent] = useState(null);

//   const [inactiveHistory, setInactiveHistory] = useState([]);

//   const [editStudent, setEditStudent] = useState(null);

//   const [editForm, setEditForm] = useState({});



//   // ADDED: States for Two-Step Confirmation

//   const [showCommitConfirm, setShowCommitConfirm] = useState(false);

//   const [changesSummary, setChangesSummary] = useState([]);



//   const [inactiveModal, setInactiveModal] = useState(null);

//   const [inactiveReason, setInactiveReason] = useState("");



//   // Export States

//   const [exportOpen, setExportOpen] = useState(false);

//   const [customExportModal, setCustomExportModal] = useState(false);

//   const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);



//   const axiosConfig = useCallback(() => ({

//     headers: { Authorization: `Bearer ${token}` },

//   }), [token]);



//   /* ---------------- FETCH DATA ---------------- */

//   const fetchStudents = useCallback(() => {

//     if (!token) return;

//     setLoading(true);

//     axios

//       .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params: { cohortNumber: formData.cohort, batchId: formData.batch } })

//       .then(({ data }) => {

//         const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());

//         setStudents(uniqueData || []);

//       })

//       .catch(() => setStudents([]))

//       .finally(() => setLoading(false));

//   }, [token, formData, axiosConfig]);



//   useEffect(() => { fetchStudents(); }, [fetchStudents]);



//   const fetchInactiveHistory = async (studentId) => {

//     try {

//       const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());

//       setInactiveHistory(data || []);

//     } catch (err) {

//       setInactiveHistory([]);

//     }

//   };



//   const handleOpenProfile = (student) => {

//     setViewStudent(student);

//     fetchInactiveHistory(student.student_id);

//   };



//   useEffect(() => {

//     if (!token) return;

//     axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));

//   }, [token, axiosConfig]);



//   useEffect(() => {

//     if (!token || !formData.cohort) { setBatches([]); return; }

//     axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })

//       .then(({ data }) => setBatches(data || []));

//   }, [token, formData.cohort, axiosConfig]);



//   /* ---------------- FILTER ---------------- */

//   useEffect(() => {

//     let f = [...students];

//     if (searchQuery.trim()) {

//       const q = searchQuery.toLowerCase();

//       f = f.filter((s) =>

//         s.student_name?.toLowerCase().includes(q) ||

//         String(s.enr_id ?? "").toLowerCase().includes(q) ||

//         s.sim_name?.toLowerCase().includes(q) ||

//         s.contact_no1?.includes(q)

//       );

//     }

//     if (statusFilter !== "all") {

//       f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);

//     }

//     setFilteredStudents(f);

//   }, [students, searchQuery, statusFilter]);



//   /* ---------------- EXPORT LOGIC ---------------- */

//   const toggleField = (id) => {

//     setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);

//   };



//   const getExportData = () => {

//     const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));

//     const rows = filteredStudents.map((s, index) => {

//       let row = {};

//       activeFields.forEach(field => {

//         if (field.id === "sl_no") {

//           row[field.label] = index + 1;

//         } else if (field.id === "gender") {

//           row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";

//         } else {

//           row[field.label] = s[field.id] ?? "-";

//         }

//       });

//       return row;

//     });

//     return { data: rows, headers: activeFields.map(f => f.label) };

//   };



//   const exportPDF = async () => {

//     const { data, headers } = getExportData();

//     if (!data.length) return alert("No rows to export.");

//     try {

//       const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });

//       const pageWidth = doc.internal.pageSize.getWidth();



//       let logoDataUrl = null;

//       try {

//         const resp = await fetch(Logo);

//         const blob = await resp.blob();

//         logoDataUrl = await new Promise((res) => {

//           const reader = new FileReader();

//           reader.onloadend = () => res(reader.result);

//           reader.readAsDataURL(blob);

//         });

//       } catch (e) { console.warn("Logo load failed for PDF"); }



//       const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";

//       const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";



//       doc.setFont("helvetica", "bold");

//       doc.setFontSize(16);

//       doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);

     

//       doc.setFontSize(12);

//       const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;

//       doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);



//       if (logoDataUrl) {

//         doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);

//       }



//       autoTable(doc, {

//         startY: 85,

//         head: [headers],

//         body: data.map(r => Object.values(r)),

//         theme: "grid",

//         headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },

//         styles: { fontSize: 7, halign: 'center' },

//       });



//       doc.save("Student_Report.pdf");

//     } catch (err) { alert("PDF Error"); }

//     finally { setExportOpen(false); setCustomExportModal(false); }

//   };



//   const exportExcel = () => {

//     const { data } = getExportData();

//     if (!data.length) return alert("No rows to export.");

//     const worksheet = XLSX.utils.json_to_sheet(data);

//     const workbook = XLSX.utils.book_new();

//     XLSX.utils.book_append_sheet(workbook, worksheet, "Students");

//     XLSX.writeFile(workbook, "Student_Report.xlsx");

//     setExportOpen(false);

//     setCustomExportModal(false);

//   };



//   const handleDefaultExport = (format) => {

//     setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);

//     setTimeout(() => {

//         if(format === 'excel') exportExcel();

//         if(format === 'pdf') exportPDF();

//     }, 100);

//   };



//   /* ---------------- ACTIONS ---------------- */

 

//   const handleEditChange = (e) => {

//     const { name, value } = e.target;

//     setEditForm((prev) => ({

//       ...prev,

//       [name]: value,

//     }));

//   };



//   // ADDED: Logic to Review Changes before Save

//   const handleReviewChanges = () => {

//     const summary = [];

//     Object.keys(editForm).forEach(key => {

//       if (editForm[key] !== editStudent[key]) {

//         // Exclude internal technical fields from summary table

//         if (!['updated_at', 'created_at', 'batch_name', 'cohort_name', 'applicant_id'].includes(key)) {

//           summary.push({

//             field: key === 'student_id' ? 'APPLICANT ID' : key.replace(/_/g, " ").toUpperCase(),

//             from: editStudent[key] || "—",

//             to: editForm[key] || "—"

//           });

//         }

//       }

//     });



//     if (summary.length === 0) return window.alert("No changes detected to update.");

//     setChangesSummary(summary);

//     setShowCommitConfirm(true);

//   };



//   const saveEdit = async () => {

//     try {

//       await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, editForm, axiosConfig());

//       window.alert("Student profile updated successfully!");

//       setEditStudent(null);

//       setShowCommitConfirm(false);

//       fetchStudents();

//     } catch (err) { window.alert("Failed to update student profile."); }

//   };



//   const handleStatusChange = async (student, newStatus) => {

//     if (student.active_yn === "INACTIVE" && newStatus === "ACTIVE") {

//       window.alert("YOU CANT MAKE THE STUDENT AS ACTIVE . CONTACT THE ADMIN");

//       return;

//     }

//     if (newStatus === "INACTIVE") {

//       setInactiveModal(student);

//       setInactiveReason("");

//     } else {

//       try {

//         await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());

//         window.alert("Status set to ACTIVE!");

//         fetchStudents();

//       } catch (err) { window.alert("Error updating status."); }

//     }

//   };



//   const confirmInactive = async () => {

//     if (!inactiveReason.trim()) return alert("Enter reason");

//     try {

//       await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());

//       window.alert("Marked as INACTIVE successfully.");

//       setInactiveModal(null);

//       setInactiveReason("");

//       fetchStudents();

//     } catch (err) { window.alert("Error updating status."); }

//   };



//   return (

//     <div className="container">

//       <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>

//         <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>

//           <img src={Logo} alt="RCF Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />

//           <div>

//             <h1 className="title">Student Management</h1>

//             <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>

//           </div>

//         </div>



//         <div className="export-menu-wrapper">

//           <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>

//             <Download size={18} /> Export <ChevronDown size={14} />

//           </button>

//           {exportOpen && (

//             <div className="export-dropdown shadow-lg">

//               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>

//               <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>

//               <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>

             

//               <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>

//               <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>

//                 <Settings size={14} className="inline mr-2" /> Custom Master Export

//               </button>

//             </div>

//           )}

//         </div>

//       </div>



//       <div className="filter-bar">

//         <div className="filter-item">

//           <Filter className="input-icon" />

//           <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>

//             <option value="">All Cohorts</option>

//             {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}

//           </select>

//         </div>

//         <div className="filter-item">

//           <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>

//             <option value="">All Batches</option>

//             {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}

//           </select>

//         </div>

//         <div className="filter-item search-box">

//           <Search className="input-icon" />

//           <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />

//         </div>

//       </div>



//       <div className="table-wrapper shadow-md rounded-lg bg-white">

//         <table className="students-table">

//           <thead>

//             <tr>

//               <th style={{ width: "45px" }}>SL NO</th>

//               <th>Student Name</th>

//               <th>Enrollment Number</th>

//               <th>Contact No</th>

//               <th>Cohort</th>

//               <th>Batch</th>

//               <th>Status</th>

//             </tr>

//           </thead>

//           <tbody>

//             {filteredStudents.map((s, index) => (

//               <tr key={s.student_id}>

//                 <td style={{ textAlign: 'center' }}>{index + 1}</td>

//                 <td>

//                   <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>

//                     <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>

//                       <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />

//                     </div>

//                     <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>

//                       <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>

//                         {s.student_name}

//                       </button>

//                       <button onClick={() => { setEditStudent(s); setEditForm({...s}); setShowCommitConfirm(false); }} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>

//                     </div>

//                   </div>

//                 </td>

//                 <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>

//                 <td>{s.contact_no1 || "—"}</td>

//                 <td>{s.cohort_name}</td>

//                 <td>{s.batch_name}</td>

//                 <td>

//                   <select

//                     value={s.active_yn}

//                     onChange={(e) => handleStatusChange(s, e.target.value)}

//                     className={`status-select ${s.active_yn === 'ACTIVE' ? 'active' : 'inactive'}`}

//                   >

//                     <option value="ACTIVE">ACTIVE</option>

//                     <option value="INACTIVE">INACTIVE</option>

//                   </select>

//                 </td>

//               </tr>

//             ))}

//           </tbody>

//         </table>

//       </div>



//       {/* CUSTOM EXPORT MODAL */}

//       {customExportModal && (

//         <div className="modal">

//           <div className="modal-content medium">

//             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>

//               <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>

//               <button onClick={() => setCustomExportModal(false)}><X /></button>

//             </div>

//             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>

//               {STUDENT_MASTER_FIELDS.map(field => (

//                 <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>

//                   <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />

//                   {field.label}

//                 </label>

//               ))}

//             </div>

//             <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>

//                 <button className="btn secondary" onClick={exportPDF}>Export PDF</button>

//                 <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>

//             </div>

//           </div>

//         </div>

//       )}



//       {/* VIEW PROFILE MODAL */}

//       {viewStudent && (

//         <div className="modal">

//           <div className="modal-content large">

//             <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>

//                <img src={Logo} alt="Logo" style={{ width: '50px' }} />

//                <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>

//             </div>

           

//             <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>

//               <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>

//                 <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />

//               </div>

//               <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>

//               <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>

//             </div>



//             <div className="profile-sections-container">

//               <div className="profile-section-block">

//                 <h4 className="section-title"><User size={18} /> Personal Details</h4>

//                 <div className="profile-grid">

//                   <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>

//                   <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title"><BookOpen size={18} /> Academic Details</h4>

//                 <div className="profile-grid">

//                   <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>

//                   <div><strong>Batch:</strong> {viewStudent.batch_name}</div>

//                   <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>

//                 <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>

//                   {inactiveHistory.length > 0 ? (

//                     inactiveHistory.map((h, i) => (

//                       <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>

//                         <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>

//                           <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}

//                         </div>

//                         <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>

//                       </div>

//                     ))

//                   ) : (

//                     <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>

//                   )}

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title"><Phone size={18} /> Contact Information</h4>

//                 <div className="profile-grid">

//                   <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>

//                   <div><strong>Student Email:</strong> {viewStudent.student_email}</div>

//                   <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>

//                   <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>

//                   <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>

//                   <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>

//                 <div className="profile-grid">

//                   <div><strong>Father:</strong> {viewStudent.father_name}</div>

//                   <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>

//                   <div><strong>Mother:</strong> {viewStudent.mother_name}</div>

//                   <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>

//                 <div className="profile-grid">

//                   <div><strong>Current Institute:</strong> {viewStudent.current_institute}</div>

//                   <div><strong>Previous Institute:</strong> {viewStudent.previous_institute}</div>

//                   <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>

//                   <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>

//                 </div>

//               </div>



//               <div className="profile-section-block">

//                 <h4 className="section-title"><MoreHorizontal size={18} /> Other Details</h4>

//                 <div className="profile-grid">

//                   <div><strong>SIM Name:</strong> <span style={{ fontWeight: 'bold' }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>

//                   <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>

//                 </div>

//               </div>

//             </div>

//           </div>

//         </div>

//       )}



//       {/* EDIT MODAL WITH TWO-STEP CONFIRMATION */}

//       {editStudent && (

//         <div className="modal">

//           <div className="modal-content large">

//             <button className="close-btn" onClick={() => { setEditStudent(null); setShowCommitConfirm(false); }}><X size={18} /></button>

//             <h3 className="modal-title">

//               {showCommitConfirm ? "Review & Confirm Changes" : "Edit Student Details"}

//             </h3>

           

//             {!showCommitConfirm ? (

//               <>

//                 <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto' }}>

//                   {Object.keys(editForm).map((k) => {

//                     // EXCLUDE technical fields and the duplicate lowercase 'applicant_id'

//                     if (['applicant_id', 'photo_link', 'batch_id', 'cohort_number', 'inactive_reason', 'batch_name', 'cohort_name', 'created_at', 'updated_at'].includes(k)) return null;

                   

//                     // Fields user EXPLICITLY asked to block from editing

//                     const isLocked = [

//                         'student_id', // Labelled as Applicant ID

//                         'enr_id',

//                         'student_email',

//                         'student_email_password',

//                         'parent_email',

//                         'student_name',

//                         'sponsor',

//                         'active_yn'

//                     ].includes(k);



//                     return (

//                       <div className="form-group" key={k}>

//                         <label style={{ textTransform: 'capitalize', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '5px' }}>

//                             {k === 'student_id' ? 'Applicant ID' : k.replace(/_/g, " ")} {isLocked && <Lock size={12} className="text-gray-400" />}

//                         </label>

//                         <input

//                             name={k}

//                             value={editForm[k] || ""}

//                             onChange={handleEditChange}

//                             readOnly={isLocked}

//                             className={`form-input ${isLocked ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`}

//                         />

//                       </div>

//                     )

//                   })}

//                 </div>

//                 <div className="modal-actions">

//                   <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>

//                   <button className="btn primary" onClick={handleReviewChanges}>Review Changes</button>

//                 </div>

//               </>

//             ) : (

//               <div className="commit-preview-container">

//                 <div className="alert-banner" style={{ background: '#fffbeb', border: '1px solid #fcd34d', padding: '12px', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px' }}>

//                     <AlertTriangle size={20} className="text-amber-600" />

//                     <p style={{ color: '#92400e', fontWeight: '600', margin: 0 }}>Review modifications before committing to the database.</p>

//                 </div>

               

//                 <div className="change-list" style={{ border: '1px solid #eee', borderRadius: '8px', overflow: 'hidden', marginBottom: '25px' }}>

//                     <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>

//                         <thead style={{ background: '#f9fafb' }}>

//                             <tr>

//                                 <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #eee' }}>Field</th>

//                                 <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #eee' }}>Old Value</th>

//                                 <th style={{ padding: '12px', textAlign: 'center', borderBottom: '1px solid #eee' }}></th>

//                                 <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #eee' }}>New Value</th>

//                             </tr>

//                         </thead>

//                         <tbody>

//                             {changesSummary.map((c, i) => (

//                                 <tr key={i}>

//                                     <td style={{ padding: '12px', fontWeight: 'bold', borderBottom: '1px solid #f3f4f6' }}>{c.field === 'STUDENT ID' ? 'APPLICANT ID' : c.field}</td>

//                                     <td style={{ padding: '12px', color: '#ef4444', textDecoration: 'line-through', borderBottom: '1px solid #f3f4f6' }}>{c.from}</td>

//                                     <td style={{ padding: '12px', textAlign: 'center', borderBottom: '1px solid #f3f4f6' }}><ArrowRight size={16} className="text-gray-400" /></td>

//                                     <td style={{ padding: '12px', color: '#10b981', fontWeight: '700', borderBottom: '1px solid #f3f4f6' }}>{c.to}</td>

//                                 </tr>

//                             ))}

//                         </tbody>

//                     </table>

//                 </div>



//                 <div className="modal-actions" style={{ background: '#f8fafc', padding: '15px', borderRadius: '8px' }}>

//                   <button className="btn secondary" onClick={() => setShowCommitConfirm(false)}>Go Back & Edit</button>

//                   <button className="btn primary" onClick={saveEdit} style={{ background: '#059669', color: 'white' }}>

//                     <CheckCircle size={18} className="mr-2 inline" /> Confirm & Commit Changes

//                   </button>

//                 </div>

//               </div>

//             )}

//           </div>

//         </div>

//       )}



//       {/* INACTIVE MODAL */}

//       {inactiveModal && (

//         <div className="modal">

//           <div className="modal-content small">

//             <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>

//             <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />

//             <div className="modal-actions">

//               <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>

//               <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>

//             </div>

//           </div>

//         </div>

//       )}



//       {/* FULL PHOTO VIEW */}

//       {fullPhoto && (

//         <div className="modal" onClick={() => setFullPhoto(null)}>

//           <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>

//             <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />

//           </div>

//         </div>

//       )}



//       <style>{`

//         .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }

//         .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }

//         .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }

//         .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }

//         .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }

//         .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }

//         .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }

//         .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }

//         .status-select.active { color: #16a34a; }

//         .status-select.inactive { color: #dc2626; }

//       `}</style>

//     </div>

//   );

// }




// / 22/12/2025
// client/src/pages/Coordinator/StudentManagement.jsx
import React, { useState, useEffect, useCallback } from "react";
import axios from "axios";
import "./BatchManagement.css";
import {
  Search,
  Eye,
  Edit,
  X,
  CheckCircle,
  AlertTriangle,
  Filter,
  Download,
  ChevronDown,
  Phone,
  User,
  Mail,
  MapPin,
  BookOpen,
  Settings,
  ListChecks,
  Lock,
  Smartphone,
  Briefcase,
  History,
  Calendar,
  GraduationCap,
  MoreHorizontal,
  ArrowRight,
  Loader2
} from "lucide-react";
import { useAuth } from "../../contexts/AuthContext";

// --- EXPORT LOGIC IMPORTS ---
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";
import * as XLSX from "xlsx";
import Logo from "../../assets/RCF-PP.jpg";

const BACKEND = process.env.REACT_APP_BACKEND_API_URL;

const STUDENT_MASTER_FIELDS = [
  { id: "sl_no", label: "SL NO" },
  { id: "student_name", label: "Student Name" },
  { id: "enr_id", label: "Enrollment ID" },
  { id: "sim_name", label: "SIM Name" },
  { id: "contact_no1", label: "Student Contact" },
  { id: "contact_no2", label: "Parent Contact" },
  { id: "student_email", label: "Student Email" },
  { id: "student_email_password", label: "Email Password" },
  { id: "parent_email", label: "Parent Email" },
  { id: "gender", label: "Gender" },
  { id: "father_name", label: "Father Name" },
  { id: "father_occupation", label: "Father Occupation" },
  { id: "mother_name", label: "Mother Name" },
  { id: "mother_occupation", label: "Mother Occupation" },
  { id: "home_address", label: "Home Address" },
  { id: "current_institute_dise_code", label: "Current Institute (DISE)" },
  { id: "previous_institute_dise_code", label: "Previous Institute (DISE)" },
  { id: "teacher_name", label: "Teacher Name" },
  { id: "teacher_mobile_number", label: "Teacher Mobile" },
  { id: "recharge_status", label: "Recharge Status" },
  { id: "sponsor", label: "Sponsor" },
  { id: "active_yn", label: "Status" },
  { id: "inactive_reason", label: "Inactive Reason" },
  { id: "cohort_name", label: "Cohort" },
  { id: "batch_name", label: "Batch" },
];

export default function StudentManagement() {
  const [fullPhoto, setFullPhoto] = useState(null);
  const { user } = useAuth();
  const token = user?.token;

  const [cohorts, setCohorts] = useState([]);
  const [batches, setBatches] = useState([]);
  const [formData, setFormData] = useState({ cohort: "", batch: "" });
  const [students, setStudents] = useState([]);
  const [filteredStudents, setFilteredStudents] = useState([]);

  const [searchQuery, setSearchQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [loading, setLoading] = useState(false);

  const [viewStudent, setViewStudent] = useState(null);
  const [inactiveHistory, setInactiveHistory] = useState([]);
  const [editStudent, setEditStudent] = useState(null);
  const [editForm, setEditForm] = useState({});

  const [instSearch, setInstSearch] = useState("");
  const [instOptions, setInstOptions] = useState([]);
  const [isSearchingInst, setIsSearchingInst] = useState(false);

  const [showCommitConfirm, setShowCommitConfirm] = useState(false);
  const [changesSummary, setChangesSummary] = useState([]);

  const [inactiveModal, setInactiveModal] = useState(null);
  const [inactiveReason, setInactiveReason] = useState("");

  const [exportOpen, setExportOpen] = useState(false);
  const [customExportModal, setCustomExportModal] = useState(false);
  const [selectedFields, setSelectedFields] = useState(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);

  const axiosConfig = useCallback(() => ({
    headers: { Authorization: `Bearer ${token}` },
  }), [token]);

  /* ---------------- INSTITUTE SEARCH (DEBOUNCED) ---------------- */
  useEffect(() => {
    if (instSearch.length < 3 || instSearch.includes(" | ")) {
      setInstOptions([]);
      return;
    }
    const timer = setTimeout(async () => {
      setIsSearchingInst(true);
      try {
        const { data } = await axios.get(`${BACKEND}/api/coordinator/institutes/search`, {
          ...axiosConfig(),
          params: { q: instSearch }
        });
        setInstOptions(data || []);
      } catch (e) { console.error("Search error"); }
      finally { setIsSearchingInst(false); }
    }, 400);
    return () => clearTimeout(timer);
  }, [instSearch, axiosConfig]);

  /* ---------------- FETCH DATA ---------------- */
  const fetchStudents = useCallback(() => {
    if (!token) return;
    setLoading(true);
    axios
      .get(`${BACKEND}/api/coordinator/students`, { ...axiosConfig(), params: { cohortNumber: formData.cohort, batchId: formData.batch } })
      .then(({ data }) => {
        const uniqueData = Array.from(new Map(data.map(item => [item.student_id, item])).values());
        setStudents(uniqueData || []);
      })
      .catch(() => setStudents([]))
      .finally(() => setLoading(false));
  }, [token, formData, axiosConfig]);

  useEffect(() => { fetchStudents(); }, [fetchStudents]);

  const fetchInactiveHistory = async (studentId) => {
    try {
      const { data } = await axios.get(`${BACKEND}/api/coordinator/students/${studentId}/inactive-history`, axiosConfig());
      setInactiveHistory(data || []);
    } catch (err) { setInactiveHistory([]); }
  };

  const handleOpenProfile = (student) => {
    setViewStudent(student);
    fetchInactiveHistory(student.student_id);
  };

  useEffect(() => {
    if (!token) return;
    axios.get(`${BACKEND}/api/coordinator/cohorts`, axiosConfig()).then(({ data }) => setCohorts(data || []));
  }, [token, axiosConfig]);

  useEffect(() => {
    if (!token || !formData.cohort) { setBatches([]); return; }
    axios.get(`${BACKEND}/api/coordinator/batches`, { ...axiosConfig(), params: { cohort_number: formData.cohort } })
      .then(({ data }) => setBatches(data || []));
  }, [token, formData.cohort, axiosConfig]);

  /* ---------------- FILTER ---------------- */
  useEffect(() => {
    let f = [...students];
    if (searchQuery.trim()) {
      const q = searchQuery.toLowerCase();
      f = f.filter((s) => 
        s.student_name?.toLowerCase().includes(q) || 
        String(s.enr_id ?? "").toLowerCase().includes(q) ||
        s.sim_name?.toLowerCase().includes(q) || 
        s.contact_no1?.includes(q)
      );
    }
    if (statusFilter !== "all") {
      f = f.filter((s) => (s.active_yn || "").toUpperCase() === statusFilter);
    }
    setFilteredStudents(f);
  }, [students, searchQuery, statusFilter]);

  /* ---------------- EXPORTS ---------------- */
  const toggleField = (id) => {
    setSelectedFields(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
  };

  const getExportData = () => {
    const activeFields = STUDENT_MASTER_FIELDS.filter(f => selectedFields.includes(f.id));
    const rows = filteredStudents.map((s, index) => {
      let row = {};
      activeFields.forEach(field => {
        if (field.id === "sl_no") row[field.label] = index + 1;
        else if (field.id === "gender") row[field.label] = s.gender === "M" ? "Male" : s.gender === "F" ? "Female" : s.gender || "-";
        else row[field.label] = s[field.id] ?? "-";
      });
      return row;
    });
    return { data: rows, headers: activeFields.map(f => f.label) };
  };

  const exportPDF = async () => {
    const { data, headers } = getExportData();
    if (!data.length) return alert("No rows to export.");
    try {
      const doc = new jsPDF({ unit: "pt", format: "a4", orientation: headers.length > 6 ? "landscape" : "portrait" });
      const pageWidth = doc.internal.pageSize.getWidth();

      // Convert Logo to Base64 for embedding
      let logoDataUrl = null;
      try {
        const resp = await fetch(Logo);
        const blob = await resp.blob();
        logoDataUrl = await new Promise((res) => {
          const reader = new FileReader();
          reader.onloadend = () => res(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (e) { console.warn("Logo failed to load into PDF"); }

      // Header Text
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("PRATIBHA POSHAK", (pageWidth - doc.getTextWidth("PRATIBHA POSHAK")) / 2, 40);
      
      doc.setFontSize(12);
      const cohortDisplayName = cohorts.find(c => String(c.cohort_number) === String(formData.cohort))?.cohort_name || "All Cohorts";
      const batchDisplayName = batches.find(b => String(b.batch_id) === String(formData.batch))?.batch_name || "All Batches";
      const subTitle = `${cohortDisplayName} - ${batchDisplayName} - STUDENT REPORT`;
      doc.text(subTitle, (pageWidth - doc.getTextWidth(subTitle)) / 2, 60);

      // Add Logo on the Right
      if (logoDataUrl) {
        doc.addImage(logoDataUrl, "JPEG", pageWidth - 80, 15, 50, 50);
      }

      autoTable(doc, {
        startY: 85,
        head: [headers],
        body: data.map(r => Object.values(r)),
        theme: "grid",
        headStyles: { fillColor: [16, 185, 129], fontSize: 8, halign: 'center' },
        styles: { fontSize: 7, halign: 'center' },
      });

      doc.save("Student_Report.pdf");
    } catch (err) { console.error(err); alert("PDF Export Error"); }
    finally { setExportOpen(false); setCustomExportModal(false); }
  };

  const exportExcel = () => {
    const { data } = getExportData();
    if (!data.length) return alert("No rows to export.");
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
    XLSX.writeFile(workbook, "Student_Report.xlsx");
    setExportOpen(false);
    setCustomExportModal(false);
  };

  const handleDefaultExport = (format) => {
    setSelectedFields(["sl_no", "student_name", "enr_id", "contact_no1", "cohort_name", "batch_name", "active_yn"]);
    setTimeout(() => {
        if(format === 'excel') exportExcel();
        if(format === 'pdf') exportPDF();
    }, 100);
  };

  /* ---------------- ACTIONS ---------------- */
  const handleEditChange = (e) => {
    const { name, value } = e.target;
    setEditForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleReviewChanges = () => {
    const summary = [];
    Object.keys(editForm).forEach(key => {
      if (editForm[key] !== editStudent[key]) {
        const ignore = ['updated_at', 'created_at', 'batch_name', 'cohort_name', 'applicant_id', 'previous_institute_dise_code', 'current_institute', 'previous_institute'];
        if (!ignore.includes(key)) {
          summary.push({
            field: key === 'student_id' ? 'APPLICANT ID' : key.replace(/_dise_code/g, "").replace(/_/g, " ").toUpperCase(),
            from: editStudent[key] || "—",
            to: editForm[key] || "—"
          });
        }
      }
    });
    if (summary.length === 0) return window.alert("No changes detected.");
    setChangesSummary(summary);
    setShowCommitConfirm(true);
  };

  const saveEdit = async () => {
    try {
      const cleanedData = { ...editForm };
      
      // LOGIC: Shift current to previous if school changed
      if (editForm.current_institute_dise_code !== editStudent.current_institute_dise_code) {
        cleanedData.previous_institute_dise_code = editStudent.current_institute_dise_code;
      }

      // Cleanup Payload for DB
      const fieldsToRemove = ['current_institute', 'previous_institute', 'batch_name', 'cohort_name', 'cohort_number', 'inactive_reason', 'created_at', 'updated_at'];
      fieldsToRemove.forEach(f => delete cleanedData[f]);

      await axios.put(`${BACKEND}/api/coordinator/students/${editStudent.student_id}`, cleanedData, axiosConfig());
      window.alert("Student profile updated successfully!");
      setEditStudent(null);
      setShowCommitConfirm(false);
      fetchStudents();
    } catch (err) { window.alert("Failed to update student profile."); }
  };

  const handleStatusChange = async (student, newStatus) => {
    if (student.active_yn === "INACTIVE" && newStatus === "ACTIVE") {
      window.alert("YOU CANT MAKE THE STUDENT AS ACTIVE . CONTACT THE ADMIN");
      return;
    }
    if (newStatus === "INACTIVE") {
      setInactiveModal(student);
      setInactiveReason("");
    } else {
      try {
        await axios.put(`${BACKEND}/api/coordinator/students/${student.student_id}`, { active_yn: "ACTIVE" }, axiosConfig());
        fetchStudents();
      } catch (err) { window.alert("Error updating status."); }
    }
  };

  const confirmInactive = async () => {
    if (!inactiveReason.trim()) return alert("Enter reason");
    try {
      await axios.put(`${BACKEND}/api/coordinator/students/${inactiveModal.student_id}`, { active_yn: "INACTIVE", inactive_reason: inactiveReason }, axiosConfig());
      setInactiveModal(null); setInactiveReason(""); fetchStudents();
    } catch (err) { window.alert("Error."); }
  };

  return (
    <div className="container">
      {/* HEADER WITH LOGO */}
      <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
          <img src={Logo} alt="RCF Logo" style={{ width: '60px', height: '60px', borderRadius: '8px' }} />
          <div>
            <h1 className="title">Student Management</h1>
            <p className="subtitle">Coordinating {filteredStudents.length} unique student records</p>
          </div>
        </div>

        <div className="export-menu-wrapper">
          <button className="btn primary" onClick={() => setExportOpen(!exportOpen)} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <Download size={18} /> Export <ChevronDown size={14} />
          </button>
          {exportOpen && (
            <div className="export-dropdown shadow-lg">
              <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6' }}>Default Export</div>
              <button onClick={() => handleDefaultExport('excel')}>Excel (.xlsx)</button>
              <button onClick={() => handleDefaultExport('pdf')}>PDF (.pdf)</button>
              
              <div style={{ padding: '8px 16px', fontSize: '11px', fontWeight: 'bold', color: '#9ca3af', textTransform: 'uppercase', borderBottom: '1px solid #f3f4f6', marginTop: '5px' }}>Master Export</div>
              <button onClick={() => { setCustomExportModal(true); setExportOpen(false); }} style={{ color: '#2563eb', fontWeight: '600' }}>
                <Settings size={14} className="inline mr-2" /> Custom Master Export
              </button>
            </div>
          )}
        </div>
      </div>

      {/* FILTER BAR */}
      <div className="filter-bar">
        <div className="filter-item">
          <Filter className="input-icon" />
          <select value={formData.cohort} onChange={(e) => setFormData({ cohort: e.target.value, batch: "" })}>
            <option value="">All Cohorts</option>
            {cohorts.map((c) => (<option key={c.cohort_number} value={c.cohort_number}>{c.cohort_name}</option>))}
          </select>
        </div>
        <div className="filter-item">
          <select value={formData.batch} disabled={!formData.cohort} onChange={(e) => setFormData((p) => ({ ...p, batch: e.target.value }))}>
            <option value="">All Batches</option>
            {batches.map((b) => (<option key={b.batch_id} value={b.batch_id}>{b.batch_name}</option>))}
          </select>
        </div>
        <div className="filter-item search-box">
          <Search className="input-icon" />
          <input placeholder="Search Name, ID or SIM..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
        </div>
      </div>

      <div className="table-wrapper shadow-md rounded-lg bg-white">
        <table className="students-table">
          <thead>
            <tr>
              <th style={{ width: "45px" }}>SL NO</th>
              <th>Student Name</th>
              <th>Enrollment Number</th>
              <th>Contact No</th>
              <th>Cohort</th>
              <th>Batch</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {filteredStudents.map((s, index) => (
              <tr key={s.student_id}>
                <td style={{ textAlign: 'center' }}>{index + 1}</td>
                <td>
                  <div className="student-info" style={{ display: 'flex', alignItems: 'center' }}>
                    <div onClick={() => handleOpenProfile(s)} style={{ cursor: "pointer", width: "35px", height: "35px", borderRadius: "50%", overflow: "hidden", marginRight: "10px", border: "1px solid #ddd" }}>
                      <img src={s.photo_link ? `${BACKEND}/${s.photo_link}` : "https://via.placeholder.com/35"} alt="Profile" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <button onClick={() => handleOpenProfile(s)} style={{ color: "#2563eb", fontWeight: "600", background: "none", border: "none", padding: 0, cursor: "pointer", fontSize: "14px" }}>
                        {s.student_name}
                      </button>
                      <button onClick={() => { setEditStudent(s); setEditForm({...s}); setInstSearch(""); setShowCommitConfirm(false); }} style={{ background: "none", border: "none", cursor: "pointer", color: "#d97706" }}><Edit size={14} /></button>
                    </div>
                  </div>
                </td>
                <td style={{ fontWeight: "600", color: "#4b5563" }}>{s.enr_id}</td>
                <td>{s.contact_no1 || "—"}</td>
                <td>{s.cohort_name}</td>
                <td>{s.batch_name}</td>
                <td>
                  <select 
                    value={s.active_yn} 
                    onChange={(e) => handleStatusChange(s, e.target.value)} 
                    className={`status-select ${s.active_yn === 'ACTIVE' ? 'active' : 'inactive'}`}
                  >
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="INACTIVE">INACTIVE</option>
                  </select>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* CUSTOM EXPORT MODAL */}
      {customExportModal && (
        <div className="modal">
          <div className="modal-content medium">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 className="modal-title"><ListChecks className="inline mr-2" /> Select Fields for Master Export</h3>
              <button onClick={() => setCustomExportModal(false)}><X /></button>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', maxHeight: '400px', overflowY: 'auto', padding: '10px', border: '1px solid #eee', borderRadius: '8px' }}>
              {STUDENT_MASTER_FIELDS.map(field => (
                <label key={field.id} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', border: '1px solid #f3f4f6', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}>
                  <input type="checkbox" checked={selectedFields.includes(field.id)} onChange={() => toggleField(field.id)} />
                  {field.label}
                </label>
              ))}
            </div>
            <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px', background: '#f9fafb', padding: '15px', borderRadius: '8px', gap: '10px' }}>
                <button className="btn secondary" onClick={exportPDF}>Export PDF</button>
                <button className="btn primary" onClick={exportExcel}>Export Excel (.xlsx)</button>
            </div>
          </div>
        </div>
      )}

      {/* VIEW PROFILE MODAL (DISE Code in Brackets) */}
      {viewStudent && (
        <div className="modal">
          <div className="modal-content large">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
               <img src={Logo} alt="Logo" style={{ width: '50px' }} />
               <button className="close-btn" onClick={() => setViewStudent(null)}><X size={20} /></button>
            </div>
            
            <div className="profile-header-card" style={{ textAlign: "center", marginBottom: 25 }}>
              <div className="avatar-lg" onClick={() => setFullPhoto(`${BACKEND}/${viewStudent.photo_link}`)}>
                <img src={viewStudent.photo_link ? `${BACKEND}/${viewStudent.photo_link}` : "https://via.placeholder.com/120"} alt="Student" />
              </div>
              <h2 style={{ marginTop: 12, fontSize: 20, fontWeight: 700, color: '#111827' }}>{viewStudent.student_name}</h2>
              <span className={`status-badge ${viewStudent.active_yn === "ACTIVE" ? "active" : "inactive"}`} style={{ fontSize: 12 }}>{viewStudent.active_yn}</span>
            </div>

            <div className="profile-sections-container">
              <div className="profile-section-block">
                <h4 className="section-title"><User size={18} /> Personal Details</h4>
                <div className="profile-grid">
                  <div><strong>Gender:</strong> {viewStudent.gender === "M" ? "Male" : viewStudent.gender === "F" ? "Female" : viewStudent.gender || "-"}</div>
                  <div><strong>Enrollment ID:</strong> {viewStudent.enr_id}</div>
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title"><BookOpen size={18} /> Academic Details</h4>
                <div className="profile-grid">
                  <div><strong>Cohort:</strong> {viewStudent.cohort_name}</div>
                  <div><strong>Batch:</strong> {viewStudent.batch_name}</div>
                  <div><strong>Sponsor:</strong> {viewStudent.sponsor || "-"}</div>
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title" style={{ color: '#be123c' }}><History size={18} /> Inactive History</h4>
                <div className="history-timeline" style={{ maxHeight: '150px', overflowY: 'auto' }}>
                  {inactiveHistory.length > 0 ? (
                    inactiveHistory.map((h, i) => (
                      <div key={i} className="history-entry" style={{ padding: '8px', borderLeft: '3px solid #be123c', background: '#fff5f5', marginBottom: '8px', borderRadius: '0 4px 4px 0' }}>
                        <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#991b1b', display: 'flex', alignItems: 'center', gap: '5px' }}>
                          <Calendar size={12} /> {new Date(h.inactive_date).toLocaleDateString('en-IN')}
                        </div>
                        <div style={{ fontSize: '12px', color: '#4b5563' }}><strong>Reason:</strong> {h.inactive_reason}</div>
                      </div>
                    ))
                  ) : (
                    <p style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>No historical records found.</p>
                  )}
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title"><Phone size={18} /> Contact Information</h4>
                <div className="profile-grid">
                  <div><strong>Student Contact:</strong> {viewStudent.contact_no1}</div>
                  <div><strong>Student Email:</strong> {viewStudent.student_email}</div>
                  <div style={{ display: 'flex', gap: '4px' }}><Lock size={12}/> <strong>Email Password:</strong> {viewStudent.student_email_password || "-"}</div>
                  <div><strong>Parent Contact:</strong> {viewStudent.contact_no2}</div>
                  <div><strong>Parent Email:</strong> {viewStudent.parent_email || "-"}</div>
                  <div className="full-row"><strong>Home Address:</strong> {viewStudent.home_address}</div>
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title"><Briefcase size={18} /> Family Details</h4>
                <div className="profile-grid">
                  <div><strong>Father:</strong> {viewStudent.father_name}</div>
                  <div><strong>Father Occ.:</strong> {viewStudent.father_occupation}</div>
                  <div><strong>Mother:</strong> {viewStudent.mother_name}</div>
                  <div><strong>Mother Occ.:</strong> {viewStudent.mother_occupation}</div>
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title"><GraduationCap size={18} /> Institute & Teacher</h4>
                <div className="profile-grid">
                  {/* DISE Code in Bracket Restored */}
                  <div><strong>Current Institute:</strong> {viewStudent.current_institute} ({viewStudent.current_institute_dise_code || "N/A"})</div>
                  <div><strong>Previous Institute:</strong> {viewStudent.previous_institute} ({viewStudent.previous_institute_dise_code || "N/A"})</div>
                  <div><strong>Teacher Name:</strong> {viewStudent.teacher_name}</div>
                  <div><strong>Teacher Mobile:</strong> {viewStudent.teacher_mobile_number || "-"}</div>
                </div>
              </div>

              <div className="profile-section-block">
                <h4 className="section-title"><MoreHorizontal size={18} /> Other Details</h4>
                <div className="profile-grid">
                  <div><strong>SIM Name:</strong> <span style={{ fontWeight: 'bold' }}>{viewStudent.sim_name || "NOT ASSIGNED"}</span></div>
                  <div><strong>Recharge Status:</strong> {viewStudent.recharge_status || "-"}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* EDIT MODAL WITH DROPDOWN VISIBILITY FIX */}
      {editStudent && (
        <div className="modal">
          <div className="modal-content large">
            <button className="close-btn" onClick={() => { setEditStudent(null); setShowCommitConfirm(false); }}><X size={18} /></button>
            <h3 className="modal-title">
              {showCommitConfirm ? "Review & Confirm Changes" : "Edit Student Details"}
            </h3>
            
            {!showCommitConfirm ? (
              <>
                <div className="edit-form grid-2-col" style={{ maxHeight: '450px', overflowY: 'auto' }}>
                  {Object.keys(editForm).map((k) => {
                    if (['applicant_id', 'photo_link', 'batch_id', 'cohort_number', 'inactive_reason', 'batch_name', 'cohort_name', 'created_at', 'updated_at', 'previous_institute_dise_code', 'current_institute', 'previous_institute'].includes(k)) return null;
                    
                    const isLocked = ['student_id', 'enr_id', 'student_email', 'student_email_password', 'parent_email', 'student_name', 'sponsor', 'active_yn'].includes(k);

                    if (k === 'current_institute_dise_code') {
                      return (
                        <div className="form-group" key={k} style={{ gridColumn: 'span 2', position: 'relative' }}>
                          <label style={{ fontWeight: '700', color: '#1e40af' }}>Current Institute (DISE | Name)</label>
                          <div style={{ position: 'relative' }}>
                            <input 
                              type="text" 
                              className="form-input" 
                              placeholder="Type 3+ chars to search..." 
                              value={instSearch} 
                              onChange={(e) => setInstSearch(e.target.value)} 
                            />
                            {isSearchingInst && <Loader2 className="animate-spin" size={16} style={{ position: 'absolute', right: '10px', top: '10px' }} />}
                          </div>
                          {instOptions.length > 0 && (
                            <div className="inst-search-results">
                              {instOptions.map(inst => (
                                <div key={inst.dise_code} className="inst-item" onClick={() => {
                                    setEditForm(prev => ({ ...prev, current_institute_dise_code: inst.dise_code }));
                                    setInstSearch(`${inst.dise_code} | ${inst.institute_name}`);
                                    setInstOptions([]);
                                  }}>
                                  <strong>{inst.dise_code}</strong> | {inst.institute_name}
                                </div>
                              ))}
                            </div>
                          )}
                          <small>Currently mapped DISE: <strong>{editForm.current_institute_dise_code}</strong></small>
                        </div>
                      );
                    }

                    return (
                      <div className="form-group" key={k}>
                        <label style={{ textTransform: 'capitalize', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '5px' }}>
                            {k === 'student_id' ? 'Applicant ID' : k.replace(/_/g, " ")} {isLocked && <Lock size={12} className="text-gray-400" />}
                        </label>
                        <input name={k} value={editForm[k] || ""} onChange={handleEditChange} readOnly={isLocked} className={`form-input ${isLocked ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`} />
                      </div>
                    )
                  })}
                </div>
                <div className="modal-actions">
                  <button className="btn secondary" onClick={() => setEditStudent(null)}>Discard</button>
                  <button className="btn primary" onClick={handleReviewChanges}>Review Changes</button>
                </div>
              </>
            ) : (
              <div className="commit-preview-container">
                <div className="change-list shadow-inner" style={{ background: '#f8fafc', borderRadius: '8px', padding: '15px' }}>
                    {changesSummary.map((c, i) => (
                        <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #e2e8f0' }}>
                            <span style={{ fontWeight: 'bold', fontSize: '13px' }}>{c.field}</span>
                            <div style={{ textAlign: 'right' }}>
                                <span style={{ color: '#ef4444', textDecoration: 'line-through', fontSize: '11px' }}>{c.from}</span>
                                <ArrowRight size={14} className="mx-2 inline text-gray-400" />
                                <span style={{ color: '#059669', fontWeight: 'bold', fontSize: '13px' }}>{c.to}</span>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="modal-actions" style={{ marginTop: '20px' }}>
                  <button className="btn secondary" onClick={() => setShowCommitConfirm(false)}>Back</button>
                  <button className="btn primary" onClick={saveEdit} style={{ background: '#059669', color: 'white' }}>
                    <CheckCircle size={18} className="mr-2 inline" /> Confirm & Commit Changes
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* INACTIVE MODAL */}
      {inactiveModal && (
        <div className="modal">
          <div className="modal-content small">
            <h3 className="modal-title text-red-600"><AlertTriangle className="inline w-5 h-5 mr-1" /> Confirm Deactivation</h3>
            <textarea rows={4} value={inactiveReason} onChange={(e) => setInactiveReason(e.target.value)} placeholder="Type reason here..." className="w-full border p-2 rounded" />
            <div className="modal-actions">
              <button className="btn secondary" onClick={() => {setInactiveModal(null); setInactiveReason("");}}>Cancel</button>
              <button className="btn danger" onClick={confirmInactive}>Confirm Inactive</button>
            </div>
          </div>
        </div>
      )}

      {/* FULL PHOTO VIEW */}
      {fullPhoto && (
        <div className="modal" onClick={() => setFullPhoto(null)}>
          <div className="modal-content" style={{ maxWidth: "450px", textAlign: "center", padding: '10px' }} onClick={e => e.stopPropagation()}>
            <img src={fullPhoto} alt="Full View" style={{ maxWidth: "100%", borderRadius: "8px" }} />
          </div>
        </div>
      )}

      <style>{`
        /* POSITIONS RESULTS BELOW SEARCH BAR */
        .inst-search-results { 
          position: absolute; 
          top: 100%; 
          left: 0; 
          right: 0; 
          z-index: 9999; 
          background: white; 
          max-height: 200px; 
          overflow-y: auto; 
          border: 1px solid #e2e8f0; 
          border-radius: 6px; 
          box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
          margin-top: 5px; 
        }
        .inst-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .inst-item:hover { background-color: #f8fafc; color: #2563eb; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .profile-sections-container { display: flex; flex-direction: column; gap: 15px; }
        .profile-section-block { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; background: #fff; }
        .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e40af; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 12px; }
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; }
        .avatar-lg { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
        .avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
        .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .status-select { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
        .status-select.active { color: #16a34a; }
        .status-select.inactive { color: #dc2626; }
      `}</style>
    </div>
  );
}